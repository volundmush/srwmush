th u(NEWCOBJ,Adaptive Game Engine Combat System <AGE>,age,,,,WIZARD SAFE !NO_COMMAND,INHERIT SIDEFX SAFE)
th u(NEWCOBJ,Adaptive Game Engine Database <AGEDB>,agedb,,age,1,WIZARD SAFE !NO_COMMAND,INHERIT SIDEFX SAFE)

&ISADMIN [u(cobj,age)]=cor(u(parent(%!)/isadmin,%0),u(tester,%0))

&SYSTEM`SWITCHES [u(cobj,age)]=setunion(u(%q<sysname>`%q<command>`PLAYER),if(cor(u(isadmin,%#),u(tester,%#)),u(%q<sysname>`%q<command>`ADMIN)),|,|)
&SYSTEM`NAME [u(cobj,age)]=u(strfirstof,%q<sysname>,COMBAT)
&SYSTEM`COLORS [u(cobj,age)]=COMBAT
&SYSTEM`OPTIONS [u(cobj,age)]=COMBAT

&FUN`VERSION [u(cobj,age)]=default(%#/D`CSYS`VERSION,1)

@lock/use [u(cobj,age)]=FUN`VERSION/1

&INC`EANNOUNCE [u(cobj,age)]=@attach %!/INC`MSG`ROOM=[ansi(m,COMBAT:)]%B[ansi(177,%0:)]%B%1,,,,,1
&INC`ANNOUNCE [u(Cobj,age)]=@attach %!/INC`MSG`ROOM=[ansi(m,COMBAT:)]%B%0,,,,,1
&INC`EPRIVATE [u(cobj,age)]=@attach %!/INC`MSG=[ansi(m,COMBAT:)]%B[ansi(117,%0:)]%B%1,%2,,,1
&INC`PRIVATE [u(cobj,age)]=@attach %!/INC`MSG=[ansi(m,COMBAT:)]%B%0,%1,,,1
&INC`DEBUG [u(cobj,age)]=@select/inline words(u(setr,testlist,u(filter,TESTER,lplayers(%l))))=>0,{@attach %!/INC`MSG`ROOM=[ansi(117,DEBUG:)][ansi(117,%0:)]%B%1,%q<testlist>,,,,1};


@@ -- Section for AGE Config.

&INC`VALID`ADJECTIVE [u(cobj,age)]=@check strlen(%0)=@attach %!/INC`MSG=ERROR: No Adjective entered!;@select/inline isint(%0)=1,{@attach %!/INC`VALID`INT},0,{@attach %!/INC`PARTIAL=%0,get(u(cobj,agedb)/ADJECTIVES)  ,|,value};th u(setq,valueformat,%q<value>);

&CMD`AGE [u(cobj,age)]=$^(?s)\+(ageconfig)(?\:/(\S+))?(?\: +(.+?))?(?\:/(.+?)?)?(?\:=(.*))?$:@check cor(hasflag(%#,WIZARD),cor(u(isadmin,%#),u(tester,%#)))=@attach %!/INC`MSG=ERROR: Permission denied.;th u(setq,command,%1);th u(setq,sysname,AGE);@attach %!/INC`GETSWITCH=%2;@attach %!/INC`CHECKPC=%#,1;@attach %!/INC`%q<sysname>`[u(strfirstof,%q<switch>,MAIN)]=%3,%4,%5
@set [u(cobj,age)]/CMD`AGE=regexp

&AGE`AGECONFIG`PLAYER [u(cobj,age)]=
&AGE`AGECONFIG`ADMIN [u(cobj,age)]=ADJECTIVE|HEAT|TECH|STAT|ATTACK|CONSEQUENCES|CONFIG|BOSS

&INC`AGE`CONFIG [u(cobj,age)]=@attach %!/INC`CONFIG=%0,%2

&CONFIG`OPTIONS [u(cobj,age)]=EXEMPT_DISTRICT|BOSS_EXTRA_HP

&CONFIG`EXEMPT_DISTRICT [u(cobj,age)]=The District dbref for rooms exempt from Consequences checks.
&CONFIG`EXEMPT_DISTRICT`DEFAULT [u(cobj,age)]=
&CONFIG`EXEMPT_DISTRICT`VALID [u(cobj,age)]=DBREF

&CONFIG`BOSS_EXTRA_HP [u(cobj,age)]=How much extra HP obtained. Formula is: BaseHP * (1 + (BOSS_EXTRA_HP * Opponents))
&CONFIG`BOSS_EXTRA_HP`DEFAULT [u(cobj,age)]=0.5
&CONFIG`BOSS_EXTRA_HP`VALID [u(cobj,age)]=NUMBER

&INC`AGE`MAIN [u(cobj,age)]=@select/inline strlen(%0)=0,{@attach %!/INC`AGE`MAIN`DISPLAY},{@attach %!/INC`AGE`MAIN`SET}

&INC`AGE`MAIN`DISPLAY [u(cobj,age)]=@pemit %#=u(header,AGE - Core Values);@dolist/inline/delimit | [get(u(cobj,agedb)/CORES)]={@pemit %#=%i0: [default(u(cobj,agedb)/CORE`%i0`CUSTOM,u(cobj,agedb)/CORE`%i0,??)]};@pemit %#=u(footer)

&INC`AGE`MAIN`SET [u(cobj,age)]=@attach %!/INC`PARTIAL=%0,get(u(cobj,agedb)/CORES),|,Core;@attach %!/INC`VALID`NUMBER=%2;&CORE`%q<CORE>`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set AGE %q<core> to: %q<value>.;@attach %!/INC`MSG`CHAN=Set AGE Core '%q<core>' To: %q<value>

&CORES [u(cobj,agedb)]=BALANCE|NORMALIZE|BASEDAMAGE|FUDGESCATTER|SCATTER_POSITIVE|SCATTER_NEGATIVE|BASEHP

&CORE`BALANCE [u(cobj,agedb)]=0
&CORE`NORMALIZE [u(cobj,agedb)]=1.3
&CORE`BASEDAMAGE [u(cobj,agedb)]=60
&CORE`FUDGESCATTER [u(cobj,agedb)]=5
&CORE`SCATTER_POSITIVE [u(cobj,agedb)]=10
&CORE`SCATTER_NEGATIVE [u(cobj,agedb)]=10
&CORE`BASEHP [u(cobj,agedb)]=10000

&INC`AGE`ADJECTIVE [u(cobj,age)]=@select/inline strlen(%0)=0,{@attach %!/INC`AGE`ADJECTIVE`DISPLAY},{@attach %!/INC`AGE`ADJECTIVE`SET}

&INC`AGE`ADJECTIVE`DISPLAY [u(cobj,age)]=@pemit %#=u(header,AGE - Adjectives);@dolist/inline/delimit | [get(u(cobj,agedb)/ADJECTIVES)]={@pemit %#=%i0: [default(u(cobj,agedb)/ADJECTIVES`%i0`CUSTOM,u(cobj,agedb)/ADJECTIVES`%i0,??)]};@pemit %#=u(footer)

&INC`AGE`ADJECTIVE`SET [u(cobj,age)]=@attach %!/INC`PARTIAL=%0,get(u(cobj,agedb)/ADJECTIVES),|,Adjective;@attach %!/INC`VALID`INT=%2;&ADJECTIVES`%q<adjective>`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set %q<adjective> to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Adjective '%q<adjective>' To: %q<value>

&ADJECTIVES [u(cobj,agedb)]=Minor|Moderate|Solid|Significant|Major|Superior|Massive|Extreme

&ADJECTIVES`MINOR [u(cobj,agedb)]=3
&ADJECTIVES`MODERATE [u(cobj,agedb)]=6
&ADJECTIVES`SOLID [u(cobj,agedb)]=9
&ADJECTIVES`SIGNIFICANT [u(cobj,agedb)]=12
&ADJECTIVES`MAJOR [u(cobj,agedb)]=15
&ADJECTIVES`SUPERIOR [u(cobj,agedb)]=20
&ADJECTIVES`MASSIVE [u(cobj,agedb)]=25
&ADJECTIVES`EXTREME [u(cobj,agedb)]=30

&ADJ [u(cobj,age)]=if(isnum(%0),%0,get(u(cobj,agedb)/ADJECTIVES`%0))

&ADJINC [u(cobj,age)]=localize([u(setq,total,add(%1,match(u(setr,adj,get(u(cobj,agedb)/ADJECTIVES)),%0,|)))][switch(%q<total>,<1,0,>8,Extreme,elements(%q<adj>,%q<total>,|))])

&CUST [u(cobj,age)]=u(strfirstof,get(u(cobj,agedb)/%0`%1`CUSTOM),get(u(cobj,agedb)/%0`%1))

&PERCENTAGES`TINY [u(cobj,agedb)]=1
&PERCENTAGES`SMALL [u(cobj,agedb)]=2
&PERCENTAGES`STANDARD [u(cobj,agedb)]=3
&PERCENTAGES`CONSIDERABLE [u(cobj,agedb)]=4
&PERCENTAGES`SUBSTANTIAL [u(cobj,agedb)]=5
&PERCENTAGES`OVERWHELMING [u(cobj,agedb)]=6


@@ - Heat Config

&INC`AGE`HEAT [u(cobj,age)]=@select/inline strlen(%0)=0,{@attach %!/INC`AGE`HEAT`DISPLAY},{@attach %!/INC`AGE`HEAT`SET}

&INC`AGE`HEAT`DISPLAY [u(cobj,age)]=@pemit %#=u(header,AGE - HEAT Config);@pemit %#=ansi(u(color,%#,SYSTEm,COLUMN_NAMES),align(12 12 8 8 8,Name,MinHeat,Bonus,Penalty,Damage\%));@pemit %#=u(separator);@dolist/inline/delimit | [get(u(cobj,agedb)/HEATS)]={@pemit %#=align(12 12 8 8 8,%i0,u(cust,HEATS,%i0),u(cust,HEATS,%i0`BONUS),u(cust,HEATS,%i0`PENALTY),u(cust,HEATS,%i0`DAMAGE))};@pemit %#=u(footer)

&INC`AGE`HEAT`SET [u(cobj,age)]=@attach %!/INC`PARTIAL=%0,get(u(cobj,agedb)/HEATS),|,HEAT;@select/inline strlen(%1)=>1,{@attach %!/INC`PARTIAL=%1,BONUS|PENALTY|DAMAGE,|,Option;@attach %!/INC`AGE`HEAT`SET`%q<option>},{@attach %!/INC`AGE`HEAT`SET`MINHEAT}

&INC`AGE`HEAT`SET`MINHEAT [u(cobj,age)]=@attach %!/INC`VALID`POSINT=%2;&HEATS`%q<HEAT>`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set HEAT Tier %q<HEAT> to: %q<value>.;@attach %!/INC`MSG`CHAN=Set HEAT Tier '%q<HEAT>' To: %q<value>

&INC`AGE`HEAT`SET`BONUS [u(cobj,age)]=@attach %!/INC`VALID`ADJECTIVE=%2;&HEATS`%q<HEAT>`BONUS`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set HEAT %q<HEAT> Bonus to: %q<value>.;@attach %!/INC`MSG`CHAN=Set HEAT '%q<HEAT>' Bonus To: %q<value>
&INC`AGE`HEAT`SET`PENALTY [u(cobj,age)]=@attach %!/INC`VALID`ADJECTIVE=%2;&HEATS`%q<HEAT>`PENALTY`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set HEAT %q<HEAT> Penalty to: %q<value>.;@attach %!/INC`MSG`CHAN=Set HEAT '%q<HEAT>' Penalty To: %q<value>
&INC`AGE`HEAT`SET`DAMAGE [u(cobj,age)]=@attach %!/INC`VALID`INT=%2;&HEATS`%q<HEAT>`DAMAGE`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set HEAT %q<HEAT> Damage to: %q<value>.;@attach %!/INC`MSG`CHAN=Set HEAT '%q<HEAT>' Damage To: %q<value>

&HEATS [u(cobj,agedb)]=Cool|Warm|Overheating|Melting|Slagged

&HEATS`COOL [u(cobj,agedb)]=50
&HEATS`COOL`ATTACK`BONUS`STAT`7 [u(cobj,agedb)]=Moderate
&HEATS`COOL`ATTACK`BONUS`STAT`6 [u(cobj,agedb)]=Moderate
&HEATS`COOL`ATTACK`BONUS`STAT`5 [u(cobj,agedb)]=Moderate
&HEATS`COOL`ATTACK`BONUS`STAT`4 [u(cobj,agedb)]=Moderate
&HEATS`COOL`DEFENSE`BONUS`STAT`7 [u(cobj,agedb)]=Moderate
&HEATS`COOL`DEFENSE`BONUS`STAT`6 [u(cobj,agedb)]=Moderate
&HEATS`COOL`DEFENSE`BONUS`STAT`5 [u(cobj,agedb)]=Moderate
&HEATS`COOL`DEFENSE`BONUS`STAT`4 [u(cobj,agedb)]=Moderate
&HEATS`COOL`CHECK [u(cobj,agedb)]=lte(get(%0/D`COMBAT`HEAT),mul(get(%0/D`COMBAT`OPPONENTS),v(HEATS`COOL)))

&HEATS`WARM [u(cobj,agedb)]=100
&HEATS`WARM`CHECK [u(cobj,agedb)]=lte(get(%0/D`COMBAT`HEAT),mul(get(%0/D`COMBAT`OPPONENTS),v(HEATS`WARM)))

&HEATS`OVERHEATING [u(cobj,agedb)]=125
&HEATS`OVERHEATING`ATTACK`PENALTY`STAT`0 [u(cobj,agedb)]=Moderate
&HEATS`OVERHEATING`ATTACK`PENALTY`STAT`1 [u(cobj,agedb)]=Moderate
&HEATS`OVERHEATING`ATTACK`PENALTY`STAT`2 [u(cobj,agedb)]=Moderate
&HEATS`OVERHEATING`ATTACK`PENALTY`STAT`3 [u(cobj,agedb)]=Moderate
&HEATS`OVERHEATING`ATTACK`PENALTY`STAT`4 [u(cobj,agedb)]=Moderate
&HEATS`OVERHEATING`ATTACK`PENALTY`STAT`5 [u(cobj,agedb)]=Moderate
&HEATS`OVERHEATING`ATTACK`PENALTY`STAT`6 [u(cobj,agedb)]=Moderate
&HEATS`OVERHEATING`ATTACK`PENALTY`STAT`7 [u(cobj,agedb)]=Moderate
&HEATS`OVERHEATING`DEFENSE`PENALTY`STAT`0 [u(cobj,agedb)]=Minor
&HEATS`OVERHEATING`DEFENSE`PENALTY`STAT`1 [u(cobj,agedb)]=Minor
&HEATS`OVERHEATING`DEFENSE`PENALTY`STAT`2 [u(cobj,agedb)]=Minor
&HEATS`OVERHEATING`DEFENSE`PENALTY`STAT`3 [u(cobj,agedb)]=Minor
&HEATS`OVERHEATING`DEFENSE`PENALTY`STAT`4 [u(cobj,agedb)]=Minor
&HEATS`OVERHEATING`DEFENSE`PENALTY`STAT`5 [u(cobj,agedb)]=Minor
&HEATS`OVERHEATING`DEFENSE`PENALTY`STAT`6 [u(cobj,agedb)]=Minor
&HEATS`OVERHEATING`DEFENSE`PENALTY`STAT`7 [u(cobj,agedb)]=Minor

&HEATS`OVERHEATING`DAMAGE [u(cobj,agedb)]=0.05
&HEATS`OVERHEATING`CHECK [u(cobj,agedb)]=lte(get(%0/D`COMBAT`HEAT),mul(get(%0/D`COMBAT`OPPONENTS),v(HEATS`OVERHEATING)))

&HEATS`MELTING [u(cobj,agedb)]=150
&HEATS`MELTING`ATTACK`PENALTY`STAT`0 [u(cobj,agedb)]=Solid
&HEATS`MELTING`ATTACK`PENALTY`STAT`1 [u(cobj,agedb)]=Solid
&HEATS`MELTING`ATTACK`PENALTY`STAT`2 [u(cobj,agedb)]=Solid
&HEATS`MELTING`ATTACK`PENALTY`STAT`3 [u(cobj,agedb)]=Solid
&HEATS`MELTING`ATTACK`PENALTY`STAT`4 [u(cobj,agedb)]=Solid
&HEATS`MELTING`ATTACK`PENALTY`STAT`5 [u(cobj,agedb)]=Solid
&HEATS`MELTING`ATTACK`PENALTY`STAT`6 [u(cobj,agedb)]=Solid
&HEATS`MELTING`ATTACK`PENALTY`STAT`7 [u(cobj,agedb)]=Solid
&HEATS`MELTING`DEFENSE`PENALTY`STAT`0 [u(cobj,agedb)]=Solid
&HEATS`MELTING`DEFENSE`PENALTY`STAT`1 [u(cobj,agedb)]=Solid
&HEATS`MELTING`DEFENSE`PENALTY`STAT`2 [u(cobj,agedb)]=Solid
&HEATS`MELTING`DEFENSE`PENALTY`STAT`3 [u(cobj,agedb)]=Solid
&HEATS`MELTING`DEFENSE`PENALTY`STAT`4 [u(cobj,agedb)]=Solid
&HEATS`MELTING`DEFENSE`PENALTY`STAT`5 [u(cobj,agedb)]=Solid
&HEATS`MELTING`DEFENSE`PENALTY`STAT`6 [u(cobj,agedb)]=Solid
&HEATS`MELTING`DEFENSE`PENALTY`STAT`7 [u(cobj,agedb)]=Solid
&HEATS`MELTING`DAMAGE [u(cobj,agedb)]=0.1
&HEATS`MELTING`CHECK [u(cobj,agedb)]=lte(get(%0/D`COMBAT`HEAT),mul(get(%0/D`COMBAT`OPPONENTS),v(HEATS`MELTING)))

&HEATS`SLAGGED [u(cobj,agedb)]=999999
&HEATS`SLAGGED`ATTACK`PENALTY`STAT`0 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`ATTACK`PENALTY`STAT`1 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`ATTACK`PENALTY`STAT`2 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`ATTACK`PENALTY`STAT`3 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`ATTACK`PENALTY`STAT`4 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`ATTACK`PENALTY`STAT`5 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`ATTACK`PENALTY`STAT`6 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`ATTACK`PENALTY`STAT`7 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`DEFENSE`PENALTY`STAT`0 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`DEFENSE`PENALTY`STAT`1 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`DEFENSE`PENALTY`STAT`2 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`DEFENSE`PENALTY`STAT`3 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`DEFENSE`PENALTY`STAT`4 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`DEFENSE`PENALTY`STAT`5 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`DEFENSE`PENALTY`STAT`6 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`DEFENSE`PENALTY`STAT`7 [u(cobj,agedb)]=Solid
&HEATS`SLAGGED`DAMAGE [u(cobj,agedb)]=1000
&HEATS`SLAGGED`CHECK [u(cobj,agedb)]=1


&HEATSTATUS [u(cobj,age)]=first(squish(iter(get(u(cobj,agedb)/HEATS),if(u(u(cobj,agedb)/HEATS`%i0`CHECK,%0),%i0[ibreak()]),|,|),|),|)

@@ Damage Age Config --

&DAMAGES [u(cobj,agedb)]=Perfect|Excellent|Good|Damaged|Critical|Disabled|Scrap

&DAMAGES`PERFECT [u(cobj,agedb)]=1
&DAMAGES`EXCELLENT [u(cobj,agedb)]=0.76
&DAMAGES`GOOD [u(cobj,agedb)]=0.501
&DAMAGES`DAMAGED [u(cobj,agedb)]=0.251
&DAMAGES`CRITICAL [u(cobj,agedb)]=0.01
&DAMAGES`DISABLED [u(cobj,agedb)]=-0.249
&DAMAGES`SCRAP [u(cobj,agedb)]=-99999

&HITPERCENT [u(cobj,age)]=mul(get(%0/D`COMBAT`HEALTH[if(%2,`ORIGINAL)]),%1)
&PERCENT [u(cobj,age)]=fdiv(sub(get(%0/D`COMBAT`HEALTH),get(%0/D`COMBAT`DAMAGE)),get(%0/D`COMBAT`HEALTH[if(%1,`ORIGINAL)]))
&DPERCENT [u(cobj,age)]=fdiv(get(%0/D`COMBAT`HEAT),get(%0/D`COMBAT`HEAT`MAXIMUM))
&TPERCENT [u(cobj,age)]=fdiv(get(%0/D`COMBAT`TENSION),get(%0/D`COMBAT`TENSION`MAXIMUM))

&DSTAGE [u(cobj,age)]=localize([u(setq,perc,u(percent,%0))][first(iter(get(u(cobj,agedb)/DAMAGES),if(gte(u(cust,DAMAGES,%i0),%q<perc>),%i0[ibreak()]),|,%b))])

&DSTAGENUM [u(cobj,age)]=match(get(u(cobj,agedb)/DAMAGES),u(dstage,%0),|)

@@ Weight Age Config--

&INC`AGE`WEIGHT [u(cobj,age)]=@select/inline strlen(%0)=0,{@attach %!/INC`AGE`WEIGHT`DISPLAY},{@attach %!/INC`AGE`WEIGHT`SET}

&INC`AGE`WEIGHT`DISPLAY [u(cobj,age)]=@pemit %#=u(header,AGE - Weight Config);@pemit %#=ansi(u(color,%#,COLUMN_NAMES),align(12 12 8 8 8,Name,Threshold,Bonus,Penalty,Tunings));@pemit %#=u(separator);@dolist/inline/delimit | [get(u(cobj,agedb)/WEIGHTS)]={@pemit %#=align(12 12 8 8 8,%i0,u(cust,WEIGHTS,%i0),u(cust,WEIGHTS,%i0`BONUS),u(cust,WEIGHTS,%i0`PENALTY),u(cust,WEIGHTS,%i0`TUNINGS))};@pemit %#=u(footer,Global: [u(cust,WEIGHTS,GLOBAL)])

&INC`AGE`WEIGHT`SET [u(cobj,age)]=@attach %!/INC`PARTIAL=%0,[get(u(cobj,agedb)/WEIGHTS)],|,Weight;@attach %!/INC`PARTIAL=%1,BONUS,|,Option;@attach %!/INC`AGE`WEIGHT`SET`%q<option>

&INC`AGE`WEIGHT`SET`THRESHOLD [u(cobj,age)]=@attach %!/INC`VALID`INT=%2;&WEIGHTS`%q<Tech>`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Tech %q<Tech> Threshold to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Tech '%q<Tech>' Threshold To: %q<value>
&INC`AGE`WEIGHT`SET`BONUS [u(cobj,age)]=@attach %!/INC`VALID`INT=%2;&WEIGHTS`%q<weight>`BONUS`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Weight %q<weight> Bonus to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Weight '%q<weight>' Bonus To: %q<value>

&WEIGHTS [u(cobj,agedb)]=LIGHT|MEDIUM|HEAVY|SUPERHEAVY|BOSS

&WEIGHTS`LIGHT [u(cobj,agedb)]=Light
&WEIGHTS`LIGHT`BONUS [u(cobj,agedb)]=0

&WEIGHTS`MEDIUM [u(cobj,agedb)]=Medium
&WEIGHTS`MEDIUM`BONUS [u(cobj,agedb)]=6

&WEIGHTS`HEAVY [u(cobj,agedb)]=Heavy
&WEIGHTS`HEAVY`BONUS [u(cobj,agedb)]=12

&WEIGHTS`SUPERHEAVY [u(cobj,agedb)]=Superheavy
&WEIGHTS`SUPERHEAVY`BONUS [u(cobj,agedb)]=24

&WEIGHTS`BOSS [u(cobj,agedb)]=Boss
&WEIGHTS`BOSS`BONUS [u(cobj,agedb)]=30

&WEIGHT [u(cobj,age)]=localize([u(setq,glob,u(cust,TECHS,GLOBAL))][switch(%0,-1,X,first(squish(iter(get(u(cobj,agedb)/TECHS),if(gte(sub(%0,%q<glob>),u(cust,TECHS,%i0)),%i0[ibreak()]),|,%b))))])

&WEIGHT`UPGRADE [u(cobj,age)]=switch(%0,LIGHT,MEDIUM,MEDIUM,HEAVY,HEAVY,SUPERHEAVY,SUPERHEAVY,SUPERHEAVY,BOSS,BOSS)
&WEIGHT`DOWNGRADE [u(cobj,age)]=switch(%0,LIGHT,LIGHT,MEDIUM,LIGHT,HEAVY,MEDIUM,SUPERHEAVY,SUPERHEAVY,BOSS,BOSS)

@@ Stats ------




Boxer
2 Grades Resilience & Agility, 1 Grade Armor, Mobility, Strength, Skill
Shooter
2 Grades Armor & Mobility, 1 Grade Resilience, Agility, Firepower, Aim

&STATLETTER [u(cobj,age)]=switch(%0,0,F,1,D,2,C,3,B,4,A,5,S,6,SS,7,SSS,8,EX,?)

&LETTERSTAT [u(cobj,age)]=switch(%0,F,0,D,1,C,2,B,3,A,4,S,5,SS,6,SSS,7,EX,8,?)

&ENTITY`0 [u(cobj,agedb)]=Pilot

&ENTITY`0`TRAIT`1 [u(cobj,agedb)]=Type
&ENTITY`0`TRAIT`1`PREFIX [u(cobj,agedb)]=TYP
&ENTITY`0`TRAIT`1`MAXIMUM [u(cobj,agedb)]=1

&ENTITY`0`TRAIT`2 [u(cobj,agedb)]=Talent
&ENTITY`0`TRAIT`2`PREFIX [u(cobj,agedb)]=TAL
&ENTITY`0`TRAIT`2`MAXIMUM [u(cobj,agedb)]=1

&ENTITY`0`TRAIT`3 [u(cobj,agedb)]=Skill
&ENTITY`0`TRAIT`3`PREFIX [u(cobj,agedb)]=SKL
&ENTITY`0`TRAIT`3`MAXIMUM [u(cobj,agedb)]=1

&ENTITY`0`TRAIT`4 [u(cobj,agedb)]=Trait
&ENTITY`0`TRAIT`4`PREFIX [u(cobj,agedb)]=TRA
&ENTITY`0`TRAIT`4`MAXIMUM [u(cobj,agedb)]=9

&ENTITY`0`STAT`0 [u(cobj,agedb)]=Strength
&ENTITY`0`STAT`0`MINIMUM [u(cobj,agedb)]=0
&ENTITY`0`STAT`0`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`0`STAT`0`DEFAULT [u(cobj,agedb)]=1
&ENTITY`0`STAT`0`DIAL [u(cobj,agedb)]=55
&ENTITY`0`STAT`0`SCALE [u(cobj,agedb)]=1.05

&ENTITY`0`STAT`0`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`0`STAT`0`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`0`STAT`0`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`0`STAT`0`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`0`STAT`0`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`0`STAT`0`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`0`STAT`0`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`0`STAT`0`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`0`STAT`0`MAPPING`8 [u(cobj,agedb)]=125


&ENTITY`0`STAT`1 [u(cobj,agedb)]=Skill
&ENTITY`0`STAT`1`MINIMUM [u(cobj,agedb)]=0
&ENTITY`0`STAT`1`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`0`STAT`1`DEFAULT [u(cobj,agedb)]=0
&ENTITY`0`STAT`1`DIAL [u(cobj,agedb)]=55
&ENTITY`0`STAT`1`SCALE [u(cobj,agedb)]=1.05

&ENTITY`0`STAT`1`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`0`STAT`1`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`0`STAT`1`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`0`STAT`1`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`0`STAT`1`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`0`STAT`1`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`0`STAT`1`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`0`STAT`1`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`0`STAT`1`MAPPING`8 [u(cobj,agedb)]=125


&ENTITY`0`STAT`2 [u(cobj,agedb)]=Firepower
&ENTITY`0`STAT`2`MINIMUM [u(cobj,agedb)]=0
&ENTITY`0`STAT`2`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`0`STAT`2`DEFAULT [u(cobj,agedb)]=0
&ENTITY`0`STAT`2`DIAL [u(cobj,agedb)]=55
&ENTITY`0`STAT`2`SCALE [u(cobj,agedb)]=1.05


&ENTITY`0`STAT`2`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`0`STAT`2`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`0`STAT`2`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`0`STAT`2`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`0`STAT`2`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`0`STAT`2`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`0`STAT`2`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`0`STAT`2`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`0`STAT`2`MAPPING`8 [u(cobj,agedb)]=125

&ENTITY`0`STAT`3 [u(cobj,agedb)]=Aim
&ENTITY`0`STAT`3`MINIMUM [u(cobj,agedb)]=0
&ENTITY`0`STAT`3`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`0`STAT`3`DEFAULT [u(cobj,agedb)]=0
&ENTITY`0`STAT`3`DIAL [u(cobj,agedb)]=55
&ENTITY`0`STAT`3`SCALE [u(cobj,agedb)]=1.05

&ENTITY`0`STAT`3`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`0`STAT`3`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`0`STAT`3`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`0`STAT`3`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`0`STAT`3`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`0`STAT`3`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`0`STAT`3`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`0`STAT`3`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`0`STAT`3`MAPPING`8 [u(cobj,agedb)]=125

&ENTITY`0`STAT`4 [u(cobj,agedb)]=Resilience
&ENTITY`0`STAT`4`MINIMUM [u(cobj,agedb)]=0
&ENTITY`0`STAT`4`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`0`STAT`4`DEFAULT [u(cobj,agedb)]=0
&ENTITY`0`STAT`4`DIAL [u(cobj,agedb)]=55
&ENTITY`0`STAT`4`SCALE [u(cobj,agedb)]=1.05

&ENTITY`0`STAT`4`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`0`STAT`4`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`0`STAT`4`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`0`STAT`4`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`0`STAT`4`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`0`STAT`4`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`0`STAT`4`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`0`STAT`4`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`0`STAT`4`MAPPING`8 [u(cobj,agedb)]=125


&ENTITY`0`STAT`5 [u(cobj,agedb)]=Agility
&ENTITY`0`STAT`5`MINIMUM [u(cobj,agedb)]=0
&ENTITY`0`STAT`5`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`0`STAT`5`DEFAULT [u(cobj,agedb)]=0
&ENTITY`0`STAT`5`DIAL [u(cobj,agedb)]=55
&ENTITY`0`STAT`5`SCALE [u(cobj,agedb)]=1.05

&ENTITY`0`STAT`5`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`0`STAT`5`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`0`STAT`5`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`0`STAT`5`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`0`STAT`5`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`0`STAT`5`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`0`STAT`5`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`0`STAT`5`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`0`STAT`5`MAPPING`8 [u(cobj,agedb)]=125

&ENTITY`0`STAT`6 [u(cobj,agedb)]=Armor
&ENTITY`0`STAT`6`MINIMUM [u(cobj,agedb)]=0
&ENTITY`0`STAT`6`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`0`STAT`6`DEFAULT [u(cobj,agedb)]=0
&ENTITY`0`STAT`6`DIAL [u(cobj,agedb)]=55
&ENTITY`0`STAT`6`SCALE [u(cobj,agedb)]=1.05

&ENTITY`0`STAT`6`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`0`STAT`6`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`0`STAT`6`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`0`STAT`6`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`0`STAT`6`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`0`STAT`6`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`0`STAT`6`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`0`STAT`6`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`0`STAT`6`MAPPING`8 [u(cobj,agedb)]=125

&ENTITY`0`STAT`7 [u(cobj,agedb)]=Mobility
&ENTITY`0`STAT`7`MINIMUM [u(cobj,agedb)]=0
&ENTITY`0`STAT`7`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`0`STAT`7`DEFAULT [u(cobj,agedb)]=0
&ENTITY`0`STAT`7`DIAL [u(cobj,agedb)]=55
&ENTITY`0`STAT`7`SCALE [u(cobj,agedb)]=1.05

&ENTITY`0`STAT`7`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`0`STAT`7`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`0`STAT`7`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`0`STAT`7`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`0`STAT`7`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`0`STAT`7`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`0`STAT`7`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`0`STAT`7`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`0`STAT`7`MAPPING`8 [u(cobj,agedb)]=125


@@ - Mecha
&ENTITY`1 [u(cobj,agedb)]=Mecha

&ENTITY`1`TRAIT`1 [u(cobj,agedb)]=Offense
&ENTITY`1`TRAIT`1`PREFIX [u(cobj,agedb)]=OFF
&ENTITY`1`TRAIT`1`MAXIMUM [u(cobj,agedb)]=1

&ENTITY`1`TRAIT`2 [u(cobj,agedb)]=Defense
&ENTITY`1`TRAIT`2`PREFIX [u(cobj,agedb)]=Def
&ENTITY`1`TRAIT`2`MAXIMUM [u(cobj,agedb)]=1

&ENTITY`1`TRAIT`3 [u(cobj,agedb)]=System
&ENTITY`1`TRAIT`3`PREFIX [u(cobj,agedb)]=SYS
&ENTITY`1`TRAIT`3`MAXIMUM [u(cobj,agedb)]=1

&ENTITY`1`TRAIT`4 [u(cobj,agedb)]=Design
&ENTITY`1`TRAIT`4`PREFIX [u(cobj,agedb)]=DES
&ENTITY`1`TRAIT`4`MAXIMUM [u(cobj,agedb)]=1

&ENTITY`1`TRAIT`5 [u(cobj,agedb)]=Module
&ENTITY`1`TRAIT`5`PREFIX [u(cobj,agedb)]=MOD
&ENTITY`1`TRAIT`5`MAXIMUM [u(cobj,agedb)]=1

&ENTITY`1`TRAIT`6 [u(cobj,agedb)]=Decal
&ENTITY`1`TRAIT`6`PREFIX [u(cobj,agedb)]=DEC
&ENTITY`1`TRAIT`6`MAXIMUM [u(cobj,agedb)]=9


&ENTITY`1`STAT`0 [u(cobj,agedb)]=Strength
&ENTITY`1`STAT`0`MINIMUM [u(cobj,agedb)]=0
&ENTITY`1`STAT`0`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`1`STAT`0`DEFAULT [u(cobj,agedb)]=0
&ENTITY`1`STAT`0`DIAL [u(cobj,agedb)]=55
&ENTITY`1`STAT`0`SCALE [u(cobj,agedb)]=1.05

&ENTITY`1`STAT`0`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`1`STAT`0`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`1`STAT`0`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`1`STAT`0`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`1`STAT`0`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`1`STAT`0`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`1`STAT`0`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`1`STAT`0`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`1`STAT`0`MAPPING`8 [u(cobj,agedb)]=125


&ENTITY`1`STAT`1 [u(cobj,agedb)]=Skill
&ENTITY`1`STAT`1`MINIMUM [u(cobj,agedb)]=0
&ENTITY`1`STAT`1`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`1`STAT`1`DEFAULT [u(cobj,agedb)]=0
&ENTITY`1`STAT`1`DIAL [u(cobj,agedb)]=55
&ENTITY`1`STAT`1`SCALE [u(cobj,agedb)]=1.05

&ENTITY`1`STAT`1`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`1`STAT`1`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`1`STAT`1`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`1`STAT`1`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`1`STAT`1`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`1`STAT`1`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`1`STAT`1`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`1`STAT`1`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`1`STAT`1`MAPPING`8 [u(cobj,agedb)]=125


&ENTITY`1`STAT`2 [u(cobj,agedb)]=Firepower
&ENTITY`1`STAT`2`MINIMUM [u(cobj,agedb)]=0
&ENTITY`1`STAT`2`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`1`STAT`2`DEFAULT [u(cobj,agedb)]=0
&ENTITY`1`STAT`2`DIAL [u(cobj,agedb)]=55
&ENTITY`1`STAT`2`SCALE [u(cobj,agedb)]=1.05


&ENTITY`1`STAT`2`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`1`STAT`2`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`1`STAT`2`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`1`STAT`2`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`1`STAT`2`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`1`STAT`2`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`1`STAT`2`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`1`STAT`2`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`1`STAT`2`MAPPING`8 [u(cobj,agedb)]=125

&ENTITY`1`STAT`3 [u(cobj,agedb)]=Aim
&ENTITY`1`STAT`3`MINIMUM [u(cobj,agedb)]=0
&ENTITY`1`STAT`3`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`1`STAT`3`DEFAULT [u(cobj,agedb)]=0
&ENTITY`1`STAT`3`DIAL [u(cobj,agedb)]=55
&ENTITY`1`STAT`3`SCALE [u(cobj,agedb)]=1.05

&ENTITY`1`STAT`3`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`1`STAT`3`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`1`STAT`3`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`1`STAT`3`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`1`STAT`3`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`1`STAT`3`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`1`STAT`3`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`1`STAT`3`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`1`STAT`3`MAPPING`8 [u(cobj,agedb)]=125

&ENTITY`1`STAT`4 [u(cobj,agedb)]=Resilience
&ENTITY`1`STAT`4`MINIMUM [u(cobj,agedb)]=0
&ENTITY`1`STAT`4`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`1`STAT`4`DEFAULT [u(cobj,agedb)]=0
&ENTITY`1`STAT`4`DIAL [u(cobj,agedb)]=55
&ENTITY`1`STAT`4`SCALE [u(cobj,agedb)]=1.05

&ENTITY`1`STAT`4`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`1`STAT`4`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`1`STAT`4`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`1`STAT`4`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`1`STAT`4`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`1`STAT`4`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`1`STAT`4`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`1`STAT`4`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`1`STAT`4`MAPPING`8 [u(cobj,agedb)]=125


&ENTITY`1`STAT`5 [u(cobj,agedb)]=Agility
&ENTITY`1`STAT`5`MINIMUM [u(cobj,agedb)]=0
&ENTITY`1`STAT`5`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`1`STAT`5`DEFAULT [u(cobj,agedb)]=0
&ENTITY`1`STAT`5`DIAL [u(cobj,agedb)]=55
&ENTITY`1`STAT`5`SCALE [u(cobj,agedb)]=1.05

&ENTITY`1`STAT`5`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`1`STAT`5`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`1`STAT`5`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`1`STAT`5`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`1`STAT`5`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`1`STAT`5`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`1`STAT`5`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`1`STAT`5`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`1`STAT`5`MAPPING`8 [u(cobj,agedb)]=125

&ENTITY`1`STAT`6 [u(cobj,agedb)]=Armor
&ENTITY`1`STAT`6`MINIMUM [u(cobj,agedb)]=0
&ENTITY`1`STAT`6`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`1`STAT`6`DEFAULT [u(cobj,agedb)]=0
&ENTITY`1`STAT`6`DIAL [u(cobj,agedb)]=55
&ENTITY`1`STAT`6`SCALE [u(cobj,agedb)]=1.05

&ENTITY`1`STAT`6`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`1`STAT`6`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`1`STAT`6`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`1`STAT`6`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`1`STAT`6`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`1`STAT`6`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`1`STAT`6`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`1`STAT`6`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`1`STAT`6`MAPPING`8 [u(cobj,agedb)]=125

&ENTITY`1`STAT`7 [u(cobj,agedb)]=Mobility
&ENTITY`1`STAT`7`MINIMUM [u(cobj,agedb)]=0
&ENTITY`1`STAT`7`MAXIMUM [u(cobj,agedb)]=8
&ENTITY`1`STAT`7`DEFAULT [u(cobj,agedb)]=0
&ENTITY`1`STAT`7`DIAL [u(cobj,agedb)]=55
&ENTITY`1`STAT`7`SCALE [u(cobj,agedb)]=1.05

&ENTITY`1`STAT`7`MAPPING`0 [u(cobj,agedb)]=30
&ENTITY`1`STAT`7`MAPPING`1 [u(cobj,agedb)]=40
&ENTITY`1`STAT`7`MAPPING`2 [u(cobj,agedb)]=50
&ENTITY`1`STAT`7`MAPPING`3 [u(cobj,agedb)]=60
&ENTITY`1`STAT`7`MAPPING`4 [u(cobj,agedb)]=70
&ENTITY`1`STAT`7`MAPPING`5 [u(cobj,agedb)]=80
&ENTITY`1`STAT`7`MAPPING`6 [u(cobj,agedb)]=95
&ENTITY`1`STAT`7`MAPPING`7 [u(cobj,agedb)]=110
&ENTITY`1`STAT`7`MAPPING`8 [u(cobj,agedb)]=125



&STATS [u(cobj,age)]=iter(u(sortattr,lattr(u(cobj,agedb)/ENTITY`%0`STAT`*)),get(u(cobj,agedb)/%i0),%b,|)

&CUSTSTAT [u(cobj,age)]=u(strfirstof,get(u(cobj,agedb)/ENTITY`%0`STAT`%1`CUSTOM),get(u(cobj,agedb)/ENTITY`%0`STAT`%1))

&INC`AGE`STAT [u(cobj,age)]=@select/inline strlen(%0)=0,{@attach %!/INC`AGE`STAT`DISPLAY},{@attach %!/INC`AGE`STAT`SET}

&INC`AGE`STAT`DISPLAY [u(cobj,age)]=@pemit %#=u(header,AGE - STAT Config);@pemit %#=ansi(u(color,%#,COMBAT,COLUMN_NAMES),align(12 8 8 8 8 8 8 8,Name,Minimum,Maximum,Default,Dial,Scale,AccWorth,Mapping));@pemit %#=u(separator);@dolist/inline 0 1 2 3={@pemit %#=align(12 8 8 8 8 8 8 8,get(u(cobj,agedb)/ENTITY`0`STAT`%i0),u(custstat,0,%i0`MINIMUM),u(custstat,0,%i0`MAXIMUM),u(custstat,0,%i0`DEFAULT),u(custstat,0,%i0`DIAL),u(custstat,0,%i0`SCALE),u(custstat,0,%i0`ACCWORTH),iter(u(sortattr,u(lattr,u(cobj,agedb)/ENTITY`0`STAT`%i0`MAPPING`*)),last(%i0,`): [get(u(cobj,agedb)/%i0)],%b,%R))};@pemit %#=u(footer)

&INC`AGE`STAT`SET [u(cobj,age)]=@attach %!/INC`PARTIAL=%0,u(u(cobj,age)/STATS),|,STAT;th u(setq,statnum,sub(match(u(u(cobj,age)/STATS),%q<stat>,|),1));@check strlen(%1)=@attach %!/INC`MSG=ERROR: Must enter an option!;@attach %!/INC`PARTIAL=before(%1,/),MINIMUM|MAXIMUM|DEFAULT|MAPPING|ACCWORTH|DIAL|SCALE,|,Option;@attach %!/INC`AGE`STAT`SET`%q<option>

&STATS [u(cobj,age)]=POWER|ENDURANCE|PRECISION|MITIGATION

&INC`AGE`STAT`SET`MINIMUM [u(cobj,age)]=@attach %!/INC`VALID`INT=%2;&ENTITY`0`STAT`%q<statnum>`MINIMUM`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set STAT %q<STAT> Minimum to: %q<value>.;@attach %!/INC`MSG`CHAN=Set STAT '%q<STAT>' Minimum To: %q<value>
&INC`AGE`STAT`SET`MAXIMUM [u(cobj,age)]=@attach %!/INC`VALID`INT=%2;&ENTITY`0`STAT`%q<statnum>`MAXIMUM`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set STAT %q<STAT> Maximum to: %q<value>.;@attach %!/INC`MSG`CHAN=Set STAT '%q<STAT>' Maximum To: %q<value>
&INC`AGE`STAT`SET`DIAL [u(cobj,age)]=@attach %!/INC`VALID`INT=%2;&ENTITY`0`STAT`%q<statnum>`DIAL`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set STAT %q<STAT> Dial to: %q<value>.;@attach %!/INC`MSG`CHAN=Set STAT '%q<STAT>' Dial To: %q<value>
&INC`AGE`STAT`SET`DEFAULT [u(cobj,age)]=@attach %!/INC`VALID`INT=%2;&ENTITY`0`STAT`%q<statnum>`DEFAULT`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set STAT %q<STAT> Default to: %q<value>.;@attach %!/INC`MSG`CHAN=Set STAT '%q<STAT>' Default To: %q<value>
&INC`AGE`STAT`SET`SCALE [u(cobj,age)]=@attach %!/INC`VALID`NUMBER=%2;&ENTITY`0`STAT`%q<statnum>`SCALE`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set STAT %q<STAT> Scale to: %q<value>.;@attach %!/INC`MSG`CHAN=Set STAT '%q<STAT>' Scale To: %q<value>

&INC`AGE`STAT`SET`MAPPING [u(cobj,age)]=@check strlen(after(%1,/))=@attach %!/INC`MSG=ERROR: Must enter a Mapping #! 1-5!;@attach %!?INC`PARTIAL=after(%1,/),1|2|3|4|5,|,map;@attach %!/INC`VALID`INT=%2;&ENTITY`0`STAT`%q<statnum>`MAPPING`%q<map>`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set STAT %q<STAT> Mapping %q<map> to: %q<value>.;@attach %!/INC`MSG`CHAN=Set STAT '%q<STAT>' Mapping %q<map> To: %q<value>


@@ Attacks Config
&INC`AGE`ATTACK [u(cobj,age)]=@select/inline strlen(%0)=0,{@attach %!/INC`AGE`ATTACK`DISPLAY},{@attach %!/INC`AGE`ATTACK`SET}

&INC`AGE`ATTACK`DISPLAY [u(cobj,age)]=@pemit %#=u(header,AGE - ATTACK Config);@pemit %#=ansi(u(color,%#,COLUMN_NAMES),align(12 12 12 8,Name,Multiplier,Percentage,Cost));@pemit %#=u(separator);@dolist/inline/delimit | [get(u(cobj,agedb)/ATTACKS)]={@pemit %#=align(12 12 12 8,%i0,u(cust,ATTACKS,%i0),u(cust,ATTACKS,%i0`PERCENTAGE),u(cust,ATTACKS,%i0`COST))};@pemit %#=u(footer)

&INC`AGE`ATTACK`SET [u(cobj,age)]=@attach %!/INC`PARTIAL=%0,[get(u(cobj,agedb)/ATTACKS)],|,ATTACK;@check strlen;@attach %!/INC`PARTIAL=%1,COST|MULTIPLIER|PERCENTAGE,|,Option;@attach %!/INC`AGE`ATTACK`SET`%q<option>

&INC`AGE`ATTACK`SET`COST [u(cobj,age)]=@attach %!/INC`VALID`INT=%2;&ATTACKS`%q<attack>`COST`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Attack %q<attack> Cost to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Attack '%q<attack>' cost To: %q<value>
&INC`AGE`ATTACK`SET`MULTIPLIER [u(cobj,age)]=@attach %!/INC`VALID`NUMBER=%2;&ATTACKS`%q<attack>`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Attack %q<attack> Multiplier to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Attack '%q<attack>' Multiplier To: %q<value>
&INC`AGE`ATTACK`SET`PERCENTAGE [u(cobj,age)]=@attach %!/INC`VALID`NUMBER=%2;&ATTACKS`%q<attack>`PERCENTAGE`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Attack %q<attack> Percentage to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Attack '%q<attack>' Percentage To: %q<value>

&ATTACKS [u(cobj,agedb)]=1|2|3|4|5|6|7|8|9|10

&ATTACKS`POWER [u(cobj,age)]=mul(%0,1)
&ATTACKS`COST [u(cobj,age)]=mul(%0,10)


&ATTACKS`1 [u(cobj,agedb)]=1.0
&ATTACKS`1`COST [u(cobj,agedb)]=10
&ATTACKS`1`PERCENTAGE [u(cobj,agedb)]=0.050
&ATTACKS`1`DESCRIPTION [u(cobj,agedb)]=Light

&ATTACKS`2 [u(cobj,agedb)]=2.0
&ATTACKS`2`COST [u(cobj,agedb)]=20
&ATTACKS`2`PERCENTAGE [u(cobj,agedb)]=0.100
&ATTACKS`2`DESCRIPTION [u(cobj,agedb)]=Standard

&ATTACKS`3 [u(cobj,agedb)]=3.0
&ATTACKS`3`COST [u(cobj,agedb)]=30
&ATTACKS`3`PERCENTAGE [u(cobj,agedb)]=0.15
&ATTACKS`3`DESCRIPTION [u(cobj,agedb)]=Heavy

&ATTACKS`4 [u(cobj,agedb)]=4.0
&ATTACKS`4`COST [u(cobj,agedb)]=40
&ATTACKS`4`PERCENTAGE [u(cobj,agedb)]=0.2
&ATTACKS`4`DESCRIPTION [u(cobj,agedb)]=Massive

&ATTACKS`5 [u(cobj,agedb)]=5.0
&ATTACKS`5`COST [u(cobj,agedb)]=50
&ATTACKS`5`PERCENTAGE [u(cobj,agedb)]=0.235
&ATTACKS`5`DESCRIPTION [u(cobj,agedb)]=Finishing

&ATTACKS`6 [u(cobj,agedb)]=6.0
&ATTACKS`6`COST [u(cobj,agedb)]=60
&ATTACKS`6`PERCENTAGE [u(cobj,agedb)]=0.27
&ATTACKS`6`DESCRIPTION [u(cobj,agedb)]=Finishing+1

&ATTACKS`7 [u(cobj,agedb)]=7.0
&ATTACKS`7`COST [u(cobj,agedb)]=70
&ATTACKS`7`PERCENTAGE [u(cobj,agedb)]=0.305
&ATTACKS`7`DESCRIPTION [u(cobj,agedb)]=Finishing+2

&ATTACKS`8 [u(cobj,agedb)]=8.0
&ATTACKS`8`COST [u(cobj,agedb)]=80
&ATTACKS`8`PERCENTAGE [u(cobj,agedb)]=0.34
&ATTACKS`8`DESCRIPTION [u(cobj,agedb)]=Finishing+3

&ATTACKS`9 [u(cobj,agedb)]=9.0
&ATTACKS`9`COST [u(cobj,agedb)]=90
&ATTACKS`9`PERCENTAGE [u(cobj,agedb)]=0.375
&ATTACKS`9`DESCRIPTION [u(cobj,agedb)]=Finishing+4

&ATTACKS`10 [u(cobj,agedb)]=10.0
&ATTACKS`10`COST [u(cobj,agedb)]=100
&ATTACKS`10`PERCENTAGE [u(cobj,agedb)]=0.41
&ATTACKS`10`DESCRIPTION [u(cobj,agedb)]=Finishing+5

@@ INTENSITY data

&INTENSITY`TINY [u(cobj,agedb)]=1
&INTENSITY`SMALL [u(cobj,agedb)]=2
&INTENSITY`STANDARD [u(Cobj,agedb)]=3
&INTENSITY`CONSIDERABLE [u(cobj,agedb)]=4
&INTENSITY`SUBSTANTIAL [u(cobj,agedb)]=5
&INTENSITY`OVERWHELMING [u(Cobj,agedb)]=6
&INTENSITY`OVERRIDE [u(cobj,agedb)]=999999

@@ Boss data

&INC`AGE`BOSS [u(cobj,age)]=@select/inline strlen(%0)=0,{@attach %!/INC`AGE`BOSS`DISPLAY},{@attach %!/INC`AGE`BOSS`SET}

&INC`AGE`BOSS`DISPLAY [u(cobj,age)]=@pemit %#=u(header,AGE - BOSS Config);@pemit %#=ansi(u(color,%#,COLUMN_NAMES),align(2 12 10 10 9 9 9 9,#,Bonus_HP,DMG_MUL,REA_MUL,Casual,Normal,Serious,Boss));@pemit %#=u(separator);@dolist/inline/delimit | [get(u(cobj,agedb)/BOSSES)]={@pemit %#=align(>2 12 10 10 9 9 9,%i0,u(cust,BOSS,%i0`BONUS_HP),u(cust,BOSS,%i0`DMG_MUL),u(cust,BOSS,%i0`REA_MUL),u(cust,BOSS,%i0`CASUAL),u(cust,BOSS,%i0`NORMAL),u(cust,BOSS,%i0`SERIOUS),u(cust,BOSS,%i0`BOSS))};@pemit %#=u(footer)

&INC`AGE`BOSS`SET [u(cobj,age)]=@attach %!/INC`PARTIAL=%0,[get(u(cobj,agedb)/BOSSES)],|,BOSS;@attach %!/INC`PARTIAL=%1,BONUS_HP|DMG_MUL|REA_MUL|SERIOUS|NORMAL|CASUAL|BOSS,|,Option;@attach %!/INC`AGE`BOSS`SET`%q<option>

&INC`AGE`BOSS`SET`BONUS_HP [u(cobj,age)]=@attach %!/INC`VALID`INT=%2;&BOSS`%q<boss>`BONUS_HP`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Bonus %q<boss> Bonus_HP to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Boss '%q<boss>' Bonus_HP To: %q<value>
&INC`AGE`BOSS`SET`DMG_MUL [u(cobj,age)]=@attach %!/INC`VALID`NUMBER=%2;&BOSS`%q<boss>`DMG_MUL`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Bonus %q<boss> DMG_MUL to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Boss '%q<boss>' DMG_MUL To: %q<value>
&INC`AGE`BOSS`SET`REA_MUL [u(cobj,age)]=@attach %!/INC`VALID`NUMBER=%2;&BOSS`%q<boss>`REA_MUL`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Bonus %q<boss> REA_MUL to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Boss '%q<boss>' REA_MUL To: %q<value>
&INC`AGE`BOSS`SET`CASUAL [u(cobj,age)]=@attach %!/INC`VALID`NUMBER=%2;&BOSS`%q<boss>`CASUAL`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Bonus %q<boss> CASUAL to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Boss '%q<boss>' CASUAL To: %q<value>
&INC`AGE`BOSS`SET`NORMAL [u(cobj,age)]=@attach %!/INC`VALID`NUMBER=%2;&BOSS`%q<boss>`NORMAL`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Bonus %q<boss> NORMAL to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Boss '%q<boss>' NORMAL To: %q<value>
&INC`AGE`BOSS`SET`SERIOUS [u(cobj,age)]=@attach %!/INC`VALID`NUMBER=%2;&BOSS`%q<boss>`SERIOUS`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Bonus %q<boss> SERIOUS to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Boss '%q<boss>' SERIOUS To: %q<value>
&INC`AGE`BOSS`SET`BOSS [u(cobj,age)]=@attach %!/INC`VALID`NUMBER=%2;&BOSS`%q<boss>`BOSS`CUSTOM [u(cobj,agedb)]=%q<value>;@attach %!/INC`MSG=Set Bonus %q<boss> BOSS to: %q<value>.;@attach %!/INC`MSG`CHAN=Set Boss '%q<boss>' BOSS To: %q<value>

&BOSSES [u(cobj,agedb)]=2|3|4|5|6|7|8|9|10


&BOSS`2`DMG_MUL [u(cobj,agedb)]=1.12
&BOSS`2`REA_MUL [u(cobj,agedb)]=0.84
&BOSS`2`SERIOUS [u(cobj,agedb)]=0.975
&BOSS`2`NORMAL [u(cobj,agedb)]=0.95
&BOSS`2`CASUAL [u(cobj,agedb)]=0.925

&BOSS`3`DMG_MUL [u(cobj,agedb)]=1.20
&BOSS`3`REA_MUL [u(cobj,agedb)]=0.80
&BOSS`3`SERIOUS [u(cobj,agedb)]=0.966
&BOSS`3`NORMAL [u(cobj,agedb)]=0.938
&BOSS`3`CASUAL [u(cobj,agedb)]=0.906

&BOSS`4`DMG_MUL [u(cobj,agedb)]=1.23
&BOSS`4`REA_MUL [u(cobj,agedb)]=0.768
&BOSS`4`SERIOUS [u(cobj,agedb)]=0.956
&BOSS`4`NORMAL [u(cobj,agedb)]=0.925
&BOSS`4`CASUAL [u(cobj,agedb)]=0.887

&BOSS`5`DMG_MUL [u(cobj,agedb)]=1.25
&BOSS`5`REA_MUL [u(cobj,agedb)]=0.75
&BOSS`5`SERIOUS [u(cobj,agedb)]=0.947
&BOSS`5`NORMAL [u(cobj,agedb)]=0.913
&BOSS`5`CASUAL [u(cobj,agedb)]=0.867

&BOSS`6`DMG_MUL [u(cobj,agedb)]=1.27
&BOSS`6`REA_MUL [u(cobj,agedb)]=0.7408
&BOSS`6`SERIOUS [u(cobj,agedb)]=0.938
&BOSS`6`NORMAL [u(cobj,agedb)]=0.9
&BOSS`6`CASUAL [u(cobj,agedb)]=0.85

&BOSS`7`DMG_MUL [u(cobj,agedb)]=1.29
&BOSS`7`REA_MUL [u(cobj,agedb)]=0.7371
&BOSS`7`SERIOUS [u(cobj,agedb)]=0.928
&BOSS`7`NORMAL [u(cobj,agedb)]=0.888
&BOSS`7`CASUAL [u(cobj,agedb)]=0.831

&BOSS`8`DMG_MUL [u(cobj,agedb)]=1.30
&BOSS`8`REA_MUL [u(cobj,agedb)]=0.7313
&BOSS`8`SERIOUS [u(cobj,agedb)]=0.919
&BOSS`8`NORMAL [u(cobj,agedb)]=0.875
&BOSS`8`CASUAL [u(cobj,agedb)]=0.813

&BOSS`9`DMG_MUL [u(cobj,agedb)]=1.31
&BOSS`9`REA_MUL [u(cobj,agedb)]=0.7278
&BOSS`9`SERIOUS [u(cobj,agedb)]=0.909
&BOSS`9`NORMAL [u(cobj,agedb)]=0.863
&BOSS`9`CASUAL [u(cobj,agedb)]=0.794

&BOSS`10`DMG_MUL [u(cobj,agedb)]=1.32
&BOSS`10`REA_MUL [u(cobj,agedb)]=0.7260
&BOSS`10`SERIOUS [u(cobj,agedb)]=0.9
&BOSS`10`NORMAL [u(cobj,agedb)]=0.85
&BOSS`10`CASUAL [u(cobj,agedb)]=0.775




@@ Offense and Defense
&ATK`1 [u(cobj,agedb)]=Accurate
&ATK`1`STATUS [u(Cobj,agedb)]=ATK_ACCURATE
&ATK`1`ATTACK_TURNS [u(cobj,agedb)]=1
&ATK`1`DEFENSE_TURNS [u(Cobj,agedb)]=0
&ATK`1`DESCRIPTION [u(cobj,agedb)]=switch(%0,<=2,precision strike,<=4,lethal strike,5,mortal strike)

&ATK`2 [u(cobj,agedb)]=Forceful
&ATK`2`STATUS [u(Cobj,agedb)]=ATK_FORCEFUL
&ATK`2`ATTACK_TURNS [u(cobj,agedb)]=1
&ATK`2`DEFENSE_TURNS [u(Cobj,agedb)]=0
&ATK`2`DESCRIPTION [u(cobj,agedb)]=switch(%0,<=2,heavy blow,<=4,mighty blow,5,savage blow)

&ATK`3 [u(cobj,agedb)]=Efficient
&ATK`3`STATUS [u(Cobj,agedb)]=ATK_EFFICIENT
&ATK`3`ATTACK_TURNS [u(cobj,agedb)]=1
&ATK`3`DEFENSE_TURNS [u(Cobj,agedb)]=0
&ATK`3`DESCRIPTION [u(cobj,agedb)]=switch(%0,<=2,effective attack,<=4,expert attack,5,perfect attack)

&ATK`4 [u(cobj,agedb)]=Dramatic
&ATK`4`STATUS [u(Cobj,agedb)]=ATK_DRAMATIC
&ATK`4`ATTACK_TURNS [u(cobj,agedb)]=1
&ATK`4`DEFENSE_TURNS [u(Cobj,agedb)]=0
&ATK`4`DESCRIPTION [u(cobj,agedb)]=switch(%0,<=2,dynamic offensive,<=4,decisive offensive,5,absolute offensive)

&ATK`5 [u(cobj,agedb)]=Trained
&ATK`5`STATUS [u(Cobj,agedb)]=ATK_TRAINED
&ATK`5`ATTACK_TURNS [u(cobj,agedb)]=1
&ATK`5`DEFENSE_TURNS [u(Cobj,agedb)]=0
&ATK`5`DESCRIPTION [u(cobj,agedb)]=switch(%0,<=2,dynamic offensive,<=4,decisive offensive,5,absolute offensive)


&REA`1 [u(cobj,agedb)]=Target
&REA`1`STATUS [u(Cobj,agedb)]=REA_TARGET
&REA`1`ATTACK_TURNS [u(cobj,agedb)]=1
&REA`1`DEFENSE_TURNS [u(Cobj,agedb)]=0
&REA`1`ACTION [u(cobj,agedb)]=Targets
&REA`1`MISS [u(cobj,agedb)]=switch(%0,<=2,%1 isn't even distracted by %2's %3!,<=4,%1 is able to ignore %2's %3!,5,%1 maintains laser focus in the face of %2's %3! It's the perfect opportunity!)
&REA`1`CLOSE [u(cobj,agedb)]=switch(%0,<=2,%1 takes %2's %3 in stride!,<=4,%1 stays ready through %2's %3!,5,%1 somehow keeps their position after %2's %3!)
&REA`1`SOLID [u(cobj,agedb)]=switch(%0,<=2,%1 puts mind over matter when hit with %2's %3!,<=4,%1 hangs on to their preparation through %2's %3!,5,%1 struggles to stay focused at all after %2's %3!)
&REA`1`CRITICAL [u(cobj,agedb)]=switch(%0,<=2,%1 suffers serious damage from %2's %3 for their effort!,<=4,%1 doesn't even try to stop %2's %3\, and pays for it!,5,%1 suffers the full fury of %2's %3! let's hope it was worth it!)
&REA`1`COST`1 [u(cobj,agedb)]=10
&REA`1`COST`1`X [u(cobj,agedb)]=1
&REA`1`COST`2 [u(cobj,agedb)]=25
&REA`1`COST`2`X [u(cobj,agedb)]=2
&REA`1`COST`3 [u(cobj,agedb)]=35
&REA`1`COST`3`X [u(cobj,agedb)]=3

&REA`2 [u(cobj,agedb)]=Charge
&REA`2`STATUS [u(Cobj,agedb)]=REA_CHARGE
&REA`2`ATTACK_TURNS [u(cobj,agedb)]=1
&REA`2`DEFENSE_TURNS [u(Cobj,agedb)]=0
&REA`2`ACTION [u(cobj,agedb)]=Charges
&REA`2`MISS [u(cobj,agedb)]=switch(%0,<=2,%1 is untouched by %2's %3!,<=4,%1 is unscathed by %2's %3!,5,%1 has the perfect chance to one-up %2's %3! Let's see the damage!)
&REA`2`CLOSE [u(cobj,agedb)]=switch(%0,<=2,%1 wrestles with %2's %3!,<=4,%1 is able to wait out %2's %3!,5,%1 scrapes through %2's %3!)
&REA`2`SOLID [u(cobj,agedb)]=switch(%0,<=2,%1 eats %2's %3 in the exchange!,<=4,%1 powers through %2's %3!,5,%1 takes a lot of damage trading with %2's %3!)
&REA`2`CRITICAL [u(cobj,agedb)]=switch(%0,<=2,%1 receives %2's %3 badly!,<=4,%1 takes %2's %3 straight to the face!,5,%1 grossly underestimates %2's %3\, and suffers the consequences! That had to hurt!)
&REA`2`COST`1 [u(cobj,agedb)]=10
&REA`2`COST`1`X [u(cobj,agedb)]=1
&REA`2`COST`2 [u(cobj,agedb)]=25
&REA`2`COST`2`X [u(cobj,agedb)]=2
&REA`2`COST`3 [u(cobj,agedb)]=35
&REA`2`COST`3`X [u(cobj,agedb)]=3


&REA`3 [u(cobj,agedb)]=Guard
&REA`3`STATUS [u(Cobj,agedb)]=REA_GUARD
&REA`3`ATTACK_TURNS [u(cobj,agedb)]=0
&REA`3`DEFENSE_TURNS [u(Cobj,agedb)]=1
&REA`3`ACTION [u(cobj,agedb)]=Guards
&REA`3`MISS [u(cobj,agedb)]=switch(%0,<=2,%1 stopped %2's %3 cold!,<=4,%1 completely blocked %2's %3!,5,%1 is somehow completely unphased by %2's %3! Impressive!)
&REA`3`CLOSE [u(cobj,agedb)]=switch(%0,<=2,%1 rolls with %2's %3!,<=4,%1 held back %2's %3!,5,%1 barely resisted %2's %3!)
&REA`3`SOLID [u(cobj,agedb)]=switch(%0,<=2,%1 holds out against %2's %3!,<=4,%1 struggles against %2's %3!,5,%1 somehow endures %2's %3!)
&REA`3`CRITICAL [u(cobj,agedb)]=switch(%0,<=2,%1's guard is pierced by %2's %3!,<=4,%1 couldn't hold out against %2's %3!,5,%1 is completely overpowered by %2's %3! It's just too strong!)
&REA`3`COST`1 [u(cobj,agedb)]=10
&REA`3`COST`1`X [u(cobj,agedb)]=1
&REA`3`COST`2 [u(cobj,agedb)]=25
&REA`3`COST`2`X [u(cobj,agedb)]=2
&REA`3`COST`3 [u(cobj,agedb)]=35
&REA`3`COST`3`X [u(cobj,agedb)]=3


&REA`4 [u(cobj,agedb)]=Maneuver
&REA`4`STATUS [u(Cobj,agedb)]=REA_MANEUVER
&REA`4`ATTACK_TURNS [u(cobj,agedb)]=0
&REA`4`DEFENSE_TURNS [u(Cobj,agedb)]=1
&REA`4`ACTION [u(cobj,agedb)]=Maneuvers
&REA`4`MISS [u(cobj,agedb)]=switch(%0,<=2,%1 easily avoids being struck by %2's %3!,<=4,%1 eludes %2's otherwise %3!,5,%1 negates %2's %3 completely! Good thinking!)
&REA`4`CLOSE [u(cobj,agedb)]=switch(%0,<=2,%1 avoids %2's %3 at the last minute!,<=4,%1 manages to fend off %2's %3!,5,%1 barely escapes destruction by %2's %3!)
&REA`4`SOLID [u(cobj,agedb)]=switch(%0,<=2,%1 partly dulls %2's %3!,<=4,%1 only blunts %2's %3!,5,%1 can only do so much against %2's %3!)
&REA`4`CRITICAL [u(cobj,agedb)]=switch(%0,<=2,%1 is caught flat-footed by %2's %3!,<=4,%1 takes the full brunt of %2's %3!,5,%1 is helpless before %2's %3! No escaping this one!)
&REA`4`COST`1 [u(cobj,agedb)]=10
&REA`4`COST`1`X [u(cobj,agedb)]=1
&REA`4`COST`2 [u(cobj,agedb)]=25
&REA`4`COST`2`X [u(cobj,agedb)]=2
&REA`4`COST`3 [u(cobj,agedb)]=35
&REA`4`COST`3`X [u(cobj,agedb)]=3


&REA`5 [u(cobj,agedb)]=Counter
&REA`5`STATUS [u(Cobj,agedb)]=REA_COUNTER
&REA`5`ATTACK_TURNS [u(cobj,agedb)]=1
&REA`5`DEFENSE_TURNS [u(Cobj,agedb)]=1
&REA`5`ACTION [u(cobj,agedb)]=Counters
&REA`5`MISS [u(cobj,agedb)]=switch(%0,<=2,%1 is totally undaunted by %2's %3!,<=4,%1 isn't threatened by %2's %3!,5,%1 laughs in the face of death at %2's %3! Confidence surges!)
&REA`5`CLOSE [u(cobj,agedb)]=switch(%0,<=2,%1 shrugs off %2's %3!,<=4,%1 comes out on top from %2's %3!,5,%1 dramatically emerges from the aftermath of %2's %3!)
&REA`5`SOLID [u(cobj,agedb)]=switch(%0,<=2,%1 determinedly pushes through %2's %3!,<=4,%1 suffers the brunt of %2's %3 to catch a breath!,5,%1 holds on and staggers through %2's %3!)
&REA`5`CRITICAL [u(cobj,agedb)]=switch(%0,<=2,%1's defiance only makes %2's %3 worse!,<=4,%1 pays dearly for standing in the way of %2's %3!,5,%1 is utterly crushed by %2's %3! It'll be hard to come back from that one!)
&REA`5`COST`1 [u(cobj,agedb)]=0
&REA`5`COST`1`X [u(cobj,agedb)]=1
&REA`5`COST`2 [u(cobj,agedb)]=5
&REA`5`COST`2`X [u(cobj,agedb)]=2
&REA`5`COST`3 [u(cobj,agedb)]=5
&REA`5`COST`3`X [u(cobj,agedb)]=3


&REA`6 [u(cobj,agedb)]=Vent
&REA`6`STATUS [u(Cobj,agedb)]=REA_VENT
&REA`6`ATTACK_TURNS [u(cobj,agedb)]=0
&REA`6`DEFENSE_TURNS [u(Cobj,agedb)]=1
&REA`6`ACTION [u(cobj,agedb)]=Counters
&REA`6`MISS [u(cobj,agedb)]=switch(%0,<=2,%1 is totally undaunted by %2's %3!,<=4,%1 isn't threatened by %2's %3!,5,%1 laughs in the face of death at %2's %3! Confidence surges!)
&REA`6`CLOSE [u(cobj,agedb)]=switch(%0,<=2,%1 shrugs off %2's %3!,<=4,%1 comes out on top from %2's %3!,5,%1 dramatically emerges from the aftermath of %2's %3!)
&REA`6`SOLID [u(cobj,agedb)]=switch(%0,<=2,%1 determinedly pushes through %2's %3!,<=4,%1 suffers the brunt of %2's %3 to catch a breath!,5,%1 holds on and staggers through %2's %3!)
&REA`6`CRITICAL [u(cobj,agedb)]=switch(%0,<=2,%1's defiance only makes %2's %3 worse!,<=4,%1 pays dearly for standing in the way of %2's %3!,5,%1 is utterly crushed by %2's %3! It'll be hard to come back from that one!)
&REA`6`COST`1 [u(cobj,agedb)]=-10
&REA`6`COST`1`X [u(cobj,agedb)]=1
&REA`6`COST`2 [u(cobj,agedb)]=0
&REA`6`COST`2`X [u(cobj,agedb)]=2
&REA`6`COST`3 [u(cobj,agedb)]=10
&REA`6`COST`3`X [u(cobj,agedb)]=3


@@ Traits

@@ Archetypes
&INC`AGE`ARCHETYPE [u(cobj,age)]=@select/inline strlen(%0)=0,{@attach %!/INC`AGE`ARCHETYPE`DISPLAY},{@attach %!/INC`AGE`ARCHETYPE`SET}

&INC`AGE`ARCHETYPE`DISPLAY [u(cobj,age)]=@pemit %#=u(header,AGE - Archetype Config);@pemit %#=ansi(u(color,%#,COMBAT,COLUMN_NAMES),align(4 40,ID,Name));@pemit %#=u(separator);@dolist/inline u(sortattr,u(lattr,u(cobj,agedb)/ARC`*))={@pemit %#=align(4 40,last(%i0,`),default(u(cobj,agedb)/%i0,<Unset>))};@pemit %#=u(footer)

&INC`AGE`ARCHETYPE`SET [u(cobj,age)]=@stop 1=@attach %!/INC`MSG=ERROR: SEt is not supported!;@attach %!/INC`PARTIAL=%0,u(u(cobj,age)/ARCHETYPES),|,ARCHETYPE;th u(setq,ARCHETYPEnum,sub(match(u(u(cobj,age)/ARCHETYPES),%q<ARCHETYPE>,|),1));


@@ Types
&TYP`0 [u(cobj,agedb)]=Unshaped

&TYP`1 [u(cobj,agedb)]=Broad
&TYP`1`STATUS [u(cobj,agedb)]=TYP_BROAD

&TYP`2 [u(cobj,agedb)]=Scrapper
&TYP`2`STATUS [u(cobj,agedb)]=TYP_SCRAPPER

&TYP`3 [u(cobj,agedb)]=Marksman
&TYP`3`STATUS [u(cobj,agedb)]=TYP_MARKSMAN

&TYP`4 [u(cobj,agedb)]=Knight
&TYP`4`STATUS [u(cobj,agedb)]=TYP_KNIGHT

&TYP`5 [u(cobj,agedb)]=Bastion
&TYP`5`STATUS [u(cobj,agedb)]=TYP_BASTION

&TYP`6 [u(cobj,agedb)]=Striker
&TYP`6`STATUS [u(cobj,agedb)]=TYP_STRIKER

&TYP`7 [u(cobj,agedb)]=Skirmisher
&TYP`7`STATUS [u(cobj,agedb)]=TYP_SKIRMISHER

&TYP`8 [u(cobj,agedb)]=Quirky
&TYP`8`STATUS [u(cobj,agedb)]=TYP_QUIRKY

@@ Offenses
&OFF`0 [u(cobj,agedb)]=Unshaped

&OFF`1 [u(cobj,agedb)]=Arsenal
&OFF`1`STATUS [u(cobj,agedb)]=OFF_ARSENAL

&OFF`2 [u(cobj,agedb)]=Assaulter
&OFF`2`STATUS [u(cobj,agedb)]=OFF_ASSAULTER

&OFF`3 [u(cobj,agedb)]=Barrager
&OFF`3`STATUS [u(cobj,agedb)]=OFF_BARRAGER

&OFF`4 [u(cobj,agedb)]=Brawler
&OFF`4`STATUS [u(cobj,agedb)]=OFF_BRAWLER

&OFF`5 [u(cobj,agedb)]=Gunfighter
&OFF`5`STATUS [u(cobj,agedb)]=OFF_GUNFIGHTER

&OFF`6 [u(cobj,agedb)]=Specialist
&OFF`6`STATUS [u(cobj,agedb)]=OFF_SPECIALIST

&OFF`7 [u(cobj,agedb)]=Operator
&OFF`7`STATUS [u(cobj,agedb)]=OFF_OPERATOR

&OFF`8 [u(cobj,agedb)]=Tailored
&OFF`8`STATUS [u(cobj,agedb)]=OFF_TAILORED


@@ Defenses
&DEF`0 [u(cobj,agedb)]=Unshaped

&DEF`1 [u(cobj,agedb)]=Balanced
&DEF`1`STATUS [u(cobj,agedb)]=DEF_BALANCED

&DEF`2 [u(cobj,agedb)]=Solid
&DEF`2`STATUS [u(cobj,agedb)]=DEF_SOLID

&DEF`3 [u(cobj,agedb)]=Agile
&DEF`3`STATUS [u(cobj,agedb)]=DEF_AGILE

&DEF`4 [u(cobj,agedb)]=Adroit
&DEF`4`STATUS [u(cobj,agedb)]=DEF_ADROIT

&DEF`5 [u(cobj,agedb)]=Rampart
&DEF`5`STATUS [u(cobj,agedb)]=DEF_RAMPART

&DEF`6 [u(cobj,agedb)]=Untouchable
&DEF`6`STATUS [u(cobj,agedb)]=DEF_UNTOUCHABLE

&DEF`7 [u(cobj,agedb)]=Boxer
&DEF`7`STATUS [u(cobj,agedb)]=DEF_BOXER

&DEF`8 [u(cobj,agedb)]=Shooter
&DEF`8`STATUS [u(cobj,agedb)]=DEF_SHOOTER

&DEF`9 [u(cobj,agedb)]=Personalized
&DEF`9`STATUS [u(cobj,agedb)]=DEF_PERSONALIZED



@@ ---- Section for version Switch....

&CMD`CSWITCH [u(cobj,age)]=$+cswitch *:@attach %!/INC`VALID`POSINT=%0;@check match(1,%q<value>)=@attach %!/INC`MSG=ERROR: Csys Version %q<value> is not available. Choices: 1;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will switch your Combat System version to %q<value>. Your current status and settings will be cleared.,COMBAT SWITCH %q<value>;@attach %!/INC`MSG=You have switched combat system versions.;@attach %!/INC`MSG`ROOM=Switched to Combat system version: %q<value>;&D`CSYS`VERSION %#=%q<value>

&VERSION [u(cobj,age)]=default(%0/D`CSYS`VERSION,1)

@@ ---- VIEWS
@@ @SQL CREATE OR REPLACE VIEW volv_centity AS SELECT c.centity_id AS centity_id,e.entity_name AS centity_name,c.centity_type as centity_type,c.centity_version AS centity_version,c.centity_owner AS centity_owner,e2.entity_name AS centity_owner_name,e2.entity_type AS centity_owner_type,e2.entity_objid AS centity_owner_objid,c.centity_date_created AS centity_date_created,UNIX_TIMESTAMP(c.centity_date_created) AS centity_date_created_secs,c.centity_claim_lock AS centity_claim_lock,c.centity_approved AS centity_approved FROM vol_centity AS c LEFT JOIN vol_entity AS e ON c.centity_id=e.entity_id LEFT JOIN vol_entity AS e2 ON c.centity_owner=e2.entity_id

@@ @SQL CREATE OR REPLACE VIEW volv_clink AS SELECT cl.clink_id AS clink_id,cl.character_id AS character_id,e.entity_name AS character_name,e.entity_objid AS character_objid,cl.clink_approved AS clink_approved,cl.clink_loan_from AS clink_loan_from,e2.entity_name AS loan_from_name,e2.entity_objid AS loan_from_objid,cl.clink_type AS clink_type,cl.clink_locked AS clink_locked,cl.consequences_date_gained AS consequences_date_gained,UNIX_TIMESTAMP(cl.consequences_date_gained) AS consequences_date_gained_secs,cl.consequences_date_timeout AS consequences_date_timeout,UNIX_TIMESTAMP(cl.consequences_date_timeout) AS consequences_date_timeout_secs,cl.consequences_scenes AS consequences_scenes,cen.* FROM vol_clink AS cl LEFT JOIN volv_centity AS cen ON cen.centity_id=cl.centity_id LEFT JOIN vol_entity AS e ON cl.character_id=e.entity_id LEFT JOIN vol_entity AS e2 ON cl.clink_loan_from=e2.entity_id;

@@ ----- ARMORY

&CMD`ARMORY [u(cobj,age)]=$^(?s)\+(pilot|mecha)(?\:/(\S+))?(?\: +(.+?))?(?\:=(.*))?$:th u(setq,sysname,ARMORY);th u(setq,command,u(capnames,%1));@attach %!/%1`INIT;@attach %!/INC`CHECKPC=%#,1;@attach %!/INC`GETSWITCH=%2;@attach %!/INC`%q<sysname>`[u(strfirstof,%q<switch>,MAIN)]=%3,%4
@set [u(cobj,age)]/CMD`ARMORY=regexp

&ARMORY`PILOT`PLAYER [u(cobj,age)]=VIEW|CLAIM|RELEASE|GRANT|REVOKE|LIST
&ARMORY`PILOT`ADMIN [u(cobj,age)]=CREATE|DELETE|TRANSFER|SELECT|DELETE|ADD|REMOVE|SET|LOCK|RAWLOCK|UNLOCK

&ARMORY`MECHA`PLAYER [u(cobj,age)]=VIEW|CLAIM|RELEASE|GRANT|REVOKE|LIST
&ARMORY`MECHA`ADMIN [u(cobj,age)]=CREATE|DELETE|TRANSFER|SELECT|DELETE|ADD|REMOVE|SET|LOCK|RAWLOCK|UNLOCK

&PILOT`INIT [u(cobj,age)]=th u(setq,etype,PILOT);th u(setq,eid,0)
&MECHA`INIT [u(cobj,age)]=th u(setq,etype,MECHA);th u(setq,eid,1)

&INC`ATARGET [u(Cobj,age)]=@check strlen(before(%0,/))=@attach %!/INC`MSG=ERROR: Must target an Owner! Example Syntax: Character/%n\, Group/Justice League, or Global.;@attach %!/INC`PARTIAL=before(%0,/),CHARACTER|GROUP|GLOBAL,|,tchoice;@select/inline %q<tchoice>=GLOBAL,{th u(setq,tar%1id,NULL);th u(setq,tar%1type,GLOBAL);th u(setq,tar%1name,GLOBAL)},CHARACTER,{@attach %!/INC`CHECKPC=after(%0,/),99;th u(setq,tar%1id,r(t99id));th u(setq,tar%1name,r(t99name));th u(setq,tar%1type,CHARACTER)},GROUP,{@attach %!/INC`VALID`GROUP=after(%0,/);th u(setq,tar%1id,get(%q<value>/D`ID));th u(setq,tar%1type,GROUP);th u(setq,tar%1name,name(%q<value>))}
@@ %0 - The TARGET. %1 - The slot to load it into. 1, 2, 3, etc.

@@ ENTITY TYPE: 1 - character, 5 - group, 9 - combat system entity

&INC`VALID`CNAME [u(cobj,age)]=@attach %!/INC`VALID`ENAME=%0,Combat Entity

&INC`VALID`CENTITY [u(cobj,age)]=@attach %!/INC`SEARCHSQL=%0,%q<etype>,CENTITY,%1,%2,%q<eid>,u(version,%#)
&Q`FIND`CENTITY`LIST [u(cobj,age)]=SELECT centity_name FROM volv_centity WHERE centity_owner=? AND centity_type=? AND centity_version=?
&Q`FIND`CENTITY`EXACT [u(cobj,age)]=SELECT centity_id,centity_name FROM volv_centity WHERE centity_name=? AND centity_owner=? AND centity_type=? AND centity_version=? LIMIT 1
&Q`FIND`CENTITY`EXACT`ID [u(cobj,age)]=SELECT centity_id,centity_name FROM volv_centity WHERE centity_id=? AND centity_owner=? AND centity_type=? AND centity_version=? LIMIT 1
&Q`FIND`CENTITY`WILD [u(cobj,age)]=SELECT centity_id,centity_name FROM volv_centity WHERE centity_name LIKE '!%' AND centity_owner=? AND centity_type=? AND centity_version=? LIMIT 1
&Q`LOAD`CENTITY [u(cobj,age)]=SELECT centity_id,centity_name,centity_owner,centity_owner_name,centity_owner_objid,centity_owner_type,centity_date_created_secs,centity_type,centity_version,centity_claim_lock FROM volv_centity WHERE centity_id=?
&FIELD`CENTITY [u(Cobj,age)]=id name owner ownername ownerobjid ownertype datecreated type version claimlock

&INC`VALID`ETARGET [u(cobj,age)]=@select/inline isint(%0)=1,{th u(setq,value,%0)},0,{@attach %!/INC`VALID`ENAME=%0}

&INC`CTARGET [u(cobj,age)]=@attach %!/INC`VALID`CENTITY=%0,%1,%2

@@ --------- ARMORY SECTION FOR CREATE

&INC`ARMORY`CREATE [u(cobj,age)]=@attach %!/INC`ATARGET=%0,1;@attach %!/INC`VALID`ENAME=%1;@stop u(mysql,EXIST`CENTITY,%q<eid>,u(VERSION,%#),%q<tar1id>,%q<value>,%q<value>)=@attach %!/INC`MSG=ERROR: Another %q<etype> already uses that name!;@attach %!/INC`DOSQL=CREATE`CENTITY`1/cid,%q<value>;@attach %!/INC`DOSQL=CREATE`CENTITY`2,%q<cid>,u(VERSION,%#),%q<tar1id>,%q<eid>;@dolist/inline u(lattr,u(cobj,agedb)/ENTITY`%q<eid>`STAT`*)={@attach %!/INC`DOSQL=NEW`CENTITY_TRAIT,%q<cid>,last(%i0,`),0,get(u(cobj,agedb)/%i0`DEFAULT)};@attach %!/INC`ARMORY`CREATE`%q<etype>;@attach %!/INC`ARMORY`CREATE`%q<etype>`%q<tar1type>;@attach %!/INC`MSG=Created %q<etype> '%q<cid>: %q<value>' for '%q<tar1type>: %q<tar1name>'. It is SELECTED for editing.;&D`ARMORY`%q<etype> %#=%q<cid>;&D`ARMORY`%q<etype>`NAME %#=%q<value>;&D`ARMORY`%q<etype>`OWNER %#=%q<tar1name>;&D`ARMORY`%q<etype>`TYPE %#=%q<tar1type>;&D`ARMORY`%q<etype>`OWNER_ID %#=%q<tar1id>;@attach %!/INC`MSG`CHAN=Created %q<etype> '%q<cid>: %q<value>' for '%q<tar1type>: %q<tar1name>'

&INC`ARMORY`CREATE`PILOT [u(cobj,age)]=
&INC`ARMORY`CREATE`PILOT`GLOBAL [u(cobj,age)]=
&INC`ARMORY`CREATE`PILOT`CHARACTER [u(cobj,age)]=@attach %!/INC`DOSQL=NEW`CENTITY_LINK/clink_id,%q<tar1id>,%q<cid>,0,NULL,0
&INC`ARMORY`CREATE`PILOT`GROUP [u(cobj,age)]=

&INC`ARMORY`CREATE`MECHA [u(cobj,age)]=
&INC`ARMORY`CREATE`MECHA`GLOBAL [u(cobj,age)]=
&INC`ARMORY`CREATE`MECHA`CHARACTER [u(cobj,age)]=@attach %!/INC`DOSQL=NEW`CENTITY_LINK/clink_id,%q<tar1id>,%q<cid>,0,NULL,0
&INC`ARMORY`CREATE`MECHA`GROUP [u(cobj,age)]=

&Q`EXIST`CENTITY [u(cobj,age)]=SELECT centity_id,centity_name FROM volv_centity WHERE centity_type=? AND centity_version=? AND centity_owner=? AND (centity_name=? OR centity_id=?)

&Q`CREATE`CENTITY`1 [u(cobj,age)]=INSERT INTO vol_entity (entity_name,entity_type) VALUES (?,9)
&Q`CREATE`CENTITY`2 [u(cobj,age)]=INSERT INTO vol_centity (centity_id,centity_version,centity_date_created,centity_owner,centity_type) VALUES (?,?,UTC_TIMESTAMP(),?,?)

&Q`NEW`CENTITY_TRAIT [u(cobj,age)]=INSERT INTO vol_ctrait (centity_id,trait_id,trait_type,trait_value) VALUES (?,?,?,?)

&Q`NEW`CENTITY_LINK [u(cobj,age)]=INSERT INTO vol_clink (character_id,centity_id,clink_type,clink_loan_from,clink_locked) VALUES (?,?,?,!,?)

@@ ---------- ARMORY SECTION FOR DELETE
&INC`ARMORY`DELETE [u(cobj,age)]=@attach %!/INC`ATARGET=%0,1;@select/inline isint(%1)=1,{th u(setq,value,%1)},0,{@attach %!/INC`VALID`ENAME=%1};@check u(setr,found,u(mysql3,FIND`CENTITY`EXACT[if(isint(%q<value>),`ID)],%q<value>,%q<tar1id>,%q<eid>,u(VERSION,%#)))=@attach %!/INC`MSG=ERROR: A %q<etype> does not use that name or ID! Deletions require EXACT MATCHES. (Name or ID);@attach %!/INC`LOADSQL=CENTITY,elements(%q<found>,1,chr(177)),1,;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will DELETE the %q<etype> '%q<centity1.id>: %q<centity1.name>'. This will affect everyone who is linked to it. Enter the same command again to verify.,DELETE %q<etype> %q<centity1.id>];@attach %!/INC`DOSQL=DELETE`CENTITY,%q<centity1.id>;@attach %!/INC`ARMORY`DELETE`%q<etype>;@attach %!/INC`ARMORY`DELETE`%q<etype>`%q<tar1type>;@attach %!/INC`MSG=[ansi(hr,DELETED)] %q<etype> '%q<centity1.id>: %q<centity1.name>' for '%q<tar1type>: %q<tar1name>'.;@attach %!/INC`MSG`CHAN=[ansi(hr,DELETED)] %q<etype> '%q<centity1.id>: %q<centity1.name>' for '%q<tar1type>: %q<tar1name>'

&Q`DELETE`CENTITY [u(cobj,age)]=DELETE FROM vol_entity WHERE entity_id=?

&INC`ARMORY`DELETE`PILOT [u(cobj,age)]=
&INC`ARMORY`DELETE`PILOT`GLOBAL [u(cobj,age)]=
&INC`ARMORY`DELETE`PILOT`CHARACTER [u(cobj,age)]=
&INC`ARMORY`DELETE`PILOT`GROUP [u(cobj,age)]=


@@ ---------- ARMORY SECTION FOR SELECT
&INC`ARMORY`SELECT [u(cobj,age)]=@attach %!/INC`ATARGET=%0,1;@attach %!/INC`CTARGET=%1,1,%q<tar1id>;@attach %!/INC`MSG=Selected %q<etype> '%q<centity1.id>: %q<centity1.name>' for '%q<tar1type>: %q<tar1name>'.;&D`ARMORY`%q<etype> %#=%q<centity1.id>;&D`ARMORY`%q<etype>`NAME %#=%q<centity1.name>;&D`ARMORY`%q<etype>`OWNER %#=%q<tar1name>;&D`ARMORY`%q<etype>`TYPE %#=%q<tar1type>;&D`ARMORY`%q<etype>`OWNER_ID %#=%q<tar1id>;@attach %!/INC`ARMORY`SELECT`%q<etype>;@attach %!/INC`ARMORY`SELECT`%q<etype>`%q<tar1type>

&INC`ARMORY`SELECT`PILOT [u(cobj,age)]=
&INC`ARMORY`SELECT`PILOT`GLOBAL [u(cobj,age)]=
&INC`ARMORY`SELECT`PILOT`CHARACTER [u(cobj,age)]=
&INC`ARMORY`SELECT`PILOT`GROUP [u(cobj,age)]=


@@ ---------- ARMORY SECTION FOR LIST
&INC`ARMORY`LIST [u(cobj,age)]=@attach %!/INC`ATARGET=u(strfirstof,%0,CHARACTER/%#),1;@attach %!/INC`ARMORY`LIST`%q<etype>;@attach %!/INC`ARMORY`LIST`%q<etype>`%q<tar1type>

&INC`ARMORY`LIST`PILOT [u(cobj,age)]=th u(setq,display_ids,u(mysql3,IDS`RETRIEVE,%q<tar1id>,0,u(version,%#)));@select/inline cor(u(isadmin,%#),eq(get(%#/D`ID),%q<tar1id>))=0,{th u(setq,display_ids,filterbool(#lambda/testlock(elements(\%0,2,chr(177)),%#),%q<display_ids>,chr(176),chr(176)))};@check strlen(%q<display_ids>)=@attach %!/INC`MSG=ERROR: No %q<tar1type> %q<etype>S to list.;th u(setq,display_ids,iter(%q<display_ids>,first(%i0,chr(177)),chr(176),%b))

&FUN`PILOTLINE [u(cobj,age)]=align(5 20 18 14 8,%0,%1,if(cand(not(isint(%5)),not(u(isadmin,%#))),???,trim(iter(ldelete(%2,5,chr(176)),ljust(switch(inum(0),5,if(elements(%i0,2,chr(177)),ansi(hy,*),%b),ansi(u(statcolor,elements(%i0,1,chr(177))),u(VIEW`STAT3,elements(%i0,1,chr(177)))[if(elements(%i0,2,chr(177)),+)])),3),chr(176),%b))),u(cust,ARC,u(strfirstof,%3,0)),u(VIEW`WEIGHT,%4))


&Q`LIST`PILOT_STATS [u(cobj,age)]=SELECT trait_value,trait_flags_1 FROM vol_ctrait WHERE centity_id=? AND trait_type=0 ORDER BY trait_id
&Q`LIST`PILOT_NAME [u(cobj,age)]=SELECT centity_id,centity_name FROM volv_centity WHERE centity_id=? LIMIT 1
&Q`LIST`PILOT_ARCHETYPE [u(cobj,age)]=SELECT mantle_archetype FROm volv_mantle WHERE mantle_id=? LIMIT 1
&Q`LIST`PILOT_OWNER [u(cobj,age)]=SELECT centity_owner FROM vol_centity WHERe centity_id=? LIMIT 1

&INC`ARMORY`LIST`PILOT`UNIVERSAL [u(cobj,age)]=@pemit %#=ansi(u(color,%#,AGE,COLUMN_NAMES),align(5 20 18 14 8,ID,Name,iter(Po En Pr Mi Dr,%i0%B),Archetype,Weight));@pemit %#=u(separator);@dolist/inline %q<display_ids>={th u(setq,mdata,u(mysql3,LIST`PILOT_NAME,%i0));th u(setq,mstats,u(mysql3,LIST`PILOT_STATS,%i0));th u(setq,marc,u(mysql,LIST`PILOT_ARCHETYPE,%i0));th u(setq,mown,u(mysql,LIST`PILOT_OWNER,%i0));@pemit %#=u(FUN`PILOTLINE,%i0,elements(%q<mdata>,2,chr(177)),%q<mstats>,%q<marc>,elements(elements(%q<mstats>,5,chr(176)),1,chr(177)),%q<mown>)};@pemit %#=u(footer)

&INC`ARMORY`LIST`PILOT`GLOBAL [u(cobj,age)]=@pemit %#=u(header,Global [capstr(lcstr(%q<etype>s))]);@attach %!/INC`ARMORY`LIST`PILOT`UNIVERSAL

&INC`ARMORY`LIST`PILOT`CHARACTER [u(cobj,age)]=@pemit %#=u(header,%q<tar1name>'s [capstr(lcstr(%q<etype>s))]);@attach %!/INC`ARMORY`LIST`PILOT`UNIVERSAL;@select/inline cand(words(u(setr,display_ids,u(mysql,IDS`EXTRA,%q<tar1id>,0,u(VERSION,%#)))),cor(u(isadmin,%#),eq(get(%#/D`ID),%q<tar1id>)))=1,{@pemit %#=u(header,%q<tar1name>'s Borrowed [capstr(lcstr(%q<etype>)s)]);@attach %!/INC`ARMORY`LIST`PILOT`UNIVERSAL}

&INC`ARMORY`LIST`PILOT`GROUP [u(cobj,age)]=@pemit %#=u(header,%q<tar1name>'s [capstr(lcstr(%q<etype>s))]);@attach %!/INC`ARMORY`LIST`PILOT`UNIVERSAL


&Q`IDS`EXTRA [u(cobj,age)]=SELECT centity_id FROM volv_clink WHERE character_id=? AND centity_type=? AND centity_version=? AND clink_locked=1 ORDER BY centity_name
&Q`IDS`RETRIEVE [u(Cobj,age)]=SELECT centity_id,centity_claim_lock FROM volv_centity WHERE centity_owner=? and centity_type=? AND centity_version=? ORDER BY centity_name



@@ ---------- ARMORY SECTION FOR VIEW
&INC`ARMORY`VIEW [u(cobj,age)]=@attach %!/INC`ATARGET=%0,1;@attach %!/INC`CTARGET=%1;@attach %!/INC`ARMORY`VIEW`%q<etype>;@attach %!/INC`ARMORY`VIEW`%q<etype>`%q<tar1type>

&INC`ARMORY`VIEW`PILOT [u(cobj,age)]=
&INC`ARMORY`VIEW`PILOT`GLOBAL [u(cobj,age)]=
&INC`ARMORY`VIEW`PILOT`CHARACTER [u(cobj,age)]=
&INC`ARMORY`VIEW`PILOT`GROUP [u(cobj,age)]=



@@ display code snippets
&INC`SHOWSELECT [u(cobj,age)]=@pemit %#=u(header,Character Editor: %q<t1name>);@pemit %#=ansi(u(color,%#,COMBAT,COLUMN_NAMES),align(2 19 6 6 6 6 12 16,ID,Name,Pow,End,Pre,Mit,Weight,Archetype));@dolist/inline/delimit [chr(176)] [u(mysql3,VIEW`PILOT_LINKS,%q<t1id>)]={th u(setq,row,u(choosegame,%i0,%d0));th u(setq,stats,elements(%q<row>,3,chr(177)));th u(setq,accs,elements(%q<row>,6,chr(177)));th u(setq,arc,elements(%q<row>,4,chr(177)));@pemit %#=align(2 19 6 6 6 6 12 16,elements(%q<row>,1,chr(177)),elements(%q<row>,2,chr(177)),elements(%q<stats>,1)[u(FUN`ACC,elements(%q<accs>,1))],elements(%q<stats>,2)[u(FUN`ACC,elements(%q<accs>,2))],elements(%q<stats>,3)[u(FUN`ACC,elements(%q<accs>,3))],elements(%q<stats>,4)[u(FUN`ACC,elements(%q<accs>,4))],u(VIEW`WEIGHT,elements(%q<stats>,5)),if(cand(%q<arc>,hasattr(u(cobj,agedb)/ARC`%q<arc>)),default(u(cobj,agedb)/ARC`%q<arc>,Unshaped),ansi(hx,N/A)))};@pemit %#=u(footer)

&VIEW`WEIGHT [u(cobj,age)]=switch(%0,1,Light,2,Medium,3,Heavy,4,Superheavy,5,Boss,<Unset>)

&FUN`ACC [u(Cobj,age)]=if(gte(%0,3),*%0,repeat(*,%0))


&INC`COMBAT`PILOT`CLAIM`LIST [u(cobj,age)]=@check words(u(setr,mantles,u(filter,GLOBAL_LOCK,u(mysql3,LIST`GLOBAL`CLAIMS),chr(176),chr(176),%#)),chr(176))=@attach %!/INC`MSG=ERROR: No Global Mantles to assume!;@pemit %#=u(header,Global Mantles);@pemit %#=ansi(u(color,%#,COMBAT,COLUMN_NAMES),align(4 14 9 9 9 9 8 11,ID,Name,Power,Endurance,Precision,Mitigatio,Weight,Archetype));@pemit %#=u(separator);@dolist/inline/delimit [chr(176)] %q<mantles>={th u(setq,row,u(choosegame,%i0,%d0));th u(setq,stats,elements(%q<row>,3,chr(177)));th u(setq,arc,elements(%q<row>,4,chr(177)));@pemit %#=align(4 14 9 9 9 9 8 11,elements(%q<row>,1,chr(177)),elements(%q<row>,2,chr(177)),if(u(isadmin,%#),u(VIEW`STAT,elements(%q<stats>,1)),Public),if(u(isadmin,%#),u(VIEW`STAT,elements(%q<stats>,2)),Public),if(u(isadmin,%#),u(VIEW`STAT,elements(%q<stats>,3)),Public),if(u(isadmin,%#),u(VIEW`STAT,elements(%q<stats>,4)),Public),u(VIEW`WEIGHT,elements(%q<stats>,5)),if(cand(%q<arc>,hasattr(u(cobj,agedb)/ARC`%q<arc>)),default(u(cobj,agedb)/ARC`%q<arc>,Unpublished),ansi(hx,N/A)))};@pemit %#=u(footer)

&INC`COMBAT`PILOT`SHOWPILOTS [u(cobj,age)]=@check words(u(setr,mantles,u(mysql3,VIEW`PILOT_LINKS,%q<t1id>)),chr(176))=@attach %!/INC`MSG=ERROR: No mantles to list.;@pemit %#=u(header,Character Editor: %q<t1name>);@pemit %#=ansi(u(color,%#,COMBAT,COLUMN_NAMES),align(2 12 9 9 9 9 8 11 3,ID,Name,Power,Endurance,Precision,Mititigat,Weight,Archetype,Acl));@dolist/inline/delimit [chr(176)] %q<mantles>={th u(setq,row,u(choosegame,%i0,%d0));th u(setq,stats,elements(%q<row>,3,chr(177)));th u(setq,arc,elements(%q<row>,4,chr(177)));@pemit %#=align(2 12 9 9 9 9 8 11 3,elements(%q<row>,1,chr(177)),elements(%q<row>,2,chr(177)),if(elements(%q<row>,7,chr(177)),Public,u(VIEW`STAT,elements(%q<stats>,1))),if(elements(%q<row>,7,chr(177)),Public,u(VIEW`STAT,elements(%q<stats>,2))),if(elements(%q<row>,7,chr(177)),Public,u(VIEW`STAT,elements(%q<stats>,3))),if(elements(%q<row>,7,chr(177)),Public,u(VIEW`STAT,elements(%q<stats>,4))),u(VIEW`WEIGHT,elements(%q<stats>,5)),if(cand(%q<arc>,hasattr(u(cobj,agedb)/ARC`%q<arc>)),default(u(cobj,agedb)/ARC`%q<arc>,Unpublished),ansi(hx,N/A)),elements(%q<stats>,6))};@pemit %#=u(footer)


@@ --------- ARMORY SECTION SUPPLEMENTAL
&INC`LOADSELECT [u(cobj,age)]=@check strlen(u(setr,value,get(%#/D`ARMORY`%q<etype>)))=@attach %!/INC`MSG=ERROR: Nothing is Selected!;@check u(setr,found,u(mysql3,FIND`CENTITY`EXACT[if(isint(%q<value>),`ID)],%q<value>,get(%#/D`ARMORY`%q<etype>`OWNER_ID),%q<eid>,u(VERSION,%#)))=@attach %!/INC`MSG=ERROR: %q<etype> not found! It may have been deleted. use /select again!;@attach %!/INC`LOADSQL=CENTITY,elements(%q<found>,1,chr(177)),1;th unsetq(found);@attach %!/INC`LOADSELECT`%q<etype>

&INC`LOADSELECT`PILOT [u(cobj,age)]=

@@ --------- ARMORY SECTION FOR SET
&INC`ARMORY`SET [u(cobj,age)]=@attach %!/INC`LOADSELECT;@check strlen(%0)=@attach %!/INC`MSG=ERROR: Must choose a parameter to set!;@attach %!/INC`PARTIAL=%0,u(ARMORY`SET`%q<etype>,%#),|,choice;@attach %!/INC`ARMORY`SET`%q<etype>`%q<choice>;@attach %!/INC`MSG=You set [u(setr,msg,[get(%#/D`ARMORY`%q<etype>`OWNER)]'s %q<etype> "%q<centity1.id>: %q<centity1.name>" %q<choice> to: %q<value>)];@attach %!/INC`MSG`CHAN=Set %q<msg>

&ARMORY`SET`PILOT [u(cobj,age)]=NAME|TYPE

&INC`ARMORY`SET`CENTITY`NAME [u(cobj,age)]=@attach %!/INC`VALID`ENAME=%1;@stop cand(u(setr,fid2,first(u(mysql2,EXIST`CENTITY,%q<eid>,u(VERSION,%#),get(%#/D`ARMORY`%q<etype>`OWNER_ID),%q<value>,%q<value>),|)),neq(%q<centity1.id>,%q<fid2>))=@attach %!/INC`MSG=ERROR: %q<etype> names must be unique per Owner.;@attach %!/INC`DOSQL=CENTITY`RENAME,%q<value>,%q<centity1.id>;&D`ARMORY`%q<etype>`NAME %#=%q<value>

&Q`CENTITY`RENAME [u(cobj,age)]=UPDATE vol_entity SET entity_name=? WHERE entity_id=?

&INC`ARMORY`SET`CENTITY`APPROVED [u(cobj,age)]=@check isint(%1)=@attach %!/INC`MSG=ERROR: Approved must be 0 (false) or 1 (true).;@attach %!/INC`DOSQL=SET`CENTITY_APPROVED,%1,%q<centity1.id>;@attach %!/INC`ARMORY`SET`CENTITY`APPROVED`%q<etype>
&INC`ARMORY`SET`CENTITY`APPROVED`CHARACTER [u(cobj,age)]=@attach %!/INC`DOSQL=SET`CLINK_APPROVED,%1,%q<centity1.id>,get(%#/D`ARMORY`%q<etype>`OWNER_ID)

&INC`ARMORY`SET`CENTITY`TRAIT [u(cobj,age)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: Nothing entered to set %q<choice> to!;@check and(isint(%1),gte(%1,u(setr,mintrait,u(cust,ENTITY`%q<eid>,STAT`%2`MINIMUM))),lte(%2,u(setr,maxtrait,u(cust,ENTITY`%q<eid>,STAT`%2`MAXIMUM))))=@attach %!/INC`MSG=ERROR: %q<choice> must be a whole number between %q<mintrait>-%q<maxtrait>.;@attach %!/INC`DOSQL=SET`CENTITY_STAT,u(setr,value,%1),%q<centity1.id>,%2,%3;

&Q`SET`CENTITY_STAT [u(cobj,age)]=UPDATE vol_ctrait SET trait_value=? WHERE centity_id=? AND trait_id=? AND trait_type=?

&INC`ARMORY`SET`CENTITY`TRAITFLAG1 [u(cobj,age)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: Nothing entered to set %q<choice> to!;@check cand(isint(%1),gte(%1,0))=@attach %!/INC`MSG=ERROR: %q<choice> must be a whole number.;@attach %!/INC`DOSQL=SET`CENTITY_STATFLAG1,%1,%q<centity1.id>,%2,%3

&Q`SET`CENTITY_STATFLAG1 [u(cobj,age)]=UPDATE vol_ctrait SET trait_flags_1=? WHERE centity_id=? AND trait_id=? AND trait_type=?

&INC`ARMORY`SET`PILOT`NAME [u(cobj,age)]=@attach %!/INC`ARMORY`SET`CENTITY`NAME

&INC`ARMORY`SET`PILOT`TYPE [u(cobj,age)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: Type field empty!;@check isint(u(setr,typ_id,u(FIND_TRAIT,TYP,%1)))=@attach %!/INC`MSG=ERROR: Could not find Type: %1!;@attach %!/INC`DOSQL=SET`PILOT`TYPE,%q<centity1.id>,%q<typ_id>,1,1;th u(setq,value,u(cust,TYP,%q<typ_id>))

&Q`SET`PILOT`TYPE [u(cobj,age)]=INSERT INTO vol_ctrait (centity_id,trait_id,trait_type,trait_value) VALUES (?,?,?,?) ON DUPLICATE KEY UPDATE trait_value=VALUES(trait_value)

&FIND_TRAIT [u(cobj,age)]=localize(if(strlen(u(setr,found,u(filter,EXACT_TRAIT,u(setr,all,u(lattr,u(cobj,agedb)/%0`*)),%b,%b,%1))),last(%q<found>,`),last(first(u(filter,WILD_TRAIT,%q<all>,%b,%b,%1)),`)))

&FIND_MULTI [u(cobj,age)]=localize(if(strlen(u(setr,found,u(filter,EXACT_TRAIT,u(setr,all,u(lattr,u(cobj,agedb)/%0`*)),%b,%b,%1))),last(%q<found>,`),sortkey(#lambda/strlen(get(u(cobj,agedb)/%0`\%0)),iter(u(filter,WILD_TRAIT,%q<all>,%b,%b,%1),last(%i0,`)))))

&FIL`EXACT_TRAIT [u(cobj,age)]=strmatch(%1,get(u(cobj,agedb)/%0))
&FIL`WILD_TRAIT [u(cobj,age)]=strmatch(get(u(cobj,agedb)/%0),%1*)

&ARMORY`SET`MECHA [u(cobj,age)]=NAME|SYSTEM|OFFENSE|DEFENSE

&INC`ARMORY`SET`MECHA`NAME [u(cobj,age)]=@attach %!/INC`ARMORY`SET`CENTITY`NAME

&INC`ARMORY`SET`MECHA`SYSTEM [u(cobj,age)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: System field empty!;@check isint(u(setr,sys_id,u(FIND_TRAIT,SYS,%1)))=@attach %!/INC`MSG=ERROR: Could not find System: %1!;@attach %!/INC`DOSQL=SET`MECHA`SYSTEM,%q<centity1.id>,0,3,%q<sys_id>;th u(setq,value,u(cust,SYS,%q<sys_id>))

&Q`SET`MECHA`SYSTEM [u(cobj,age)]=INSERT INTO vol_ctrait (centity_id,trait_id,trait_type,trait_value) VALUES (?,?,?,?) ON DUPLICATE KEY UPDATE trait_value=VALUES(trait_value)

&INC`ARMORY`SET`MECHA`OFFENSE [u(cobj,age)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: Offense field empty!;@check isint(u(setr,off_id,u(FIND_TRAIT,OFF,%1)))=@attach %!/INC`MSG=ERROR: Could not find Offense: %1!;@attach %!/INC`DOSQL=SET`MECHA`OFFENSE,%q<centity1.id>,%q<off_id>,1,1;th u(setq,value,u(cust,OFF,%q<off_id>))

&Q`SET`MECHA`OFFENSE [u(cobj,age)]=INSERT INTO vol_ctrait (centity_id,trait_id,trait_type,trait_value) VALUES (?,?,?,?) ON DUPLICATE KEY UPDATE trait_value=VALUES(trait_value)

&INC`ARMORY`SET`MECHA`DEFENSE [u(cobj,age)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: Defense field empty!;@check isint(u(setr,def_id,u(FIND_TRAIT,DEF,%1)))=@attach %!/INC`MSG=ERROR: Could not find Defense: %1!;@attach %!/INC`DOSQL=SET`MECHA`DEFENSE,%q<centity1.id>,%q<def_id>,2,1;th u(setq,value,u(cust,DEF,%q<def_id>))

&Q`SET`MECHA`DEFENSE [u(cobj,age)]=INSERT INTO vol_ctrait (centity_id,trait_id,trait_type,trait_value) VALUES (?,?,?,?) ON DUPLICATE KEY UPDATE trait_value=VALUES(trait_value)

@@ ---- ARMORY SECTION FOR ADD
&INC`ARMORY`ADD [u(cobj,age)]=@attach %!/INC`LOADSELECT;@check strlen(%0)=@attach %!/INC`MSG=ERROR: Must choose a parameter to add!;@attach %!/INC`PARTIAL=%0,u(ARMORY`ADD`%q<etype>,%#),|,choice;@attach %!/INC`ARMORY`ADD`%q<etype>`%q<choice>;@attach %!/INC`MSG=You added '%q<value>' to [u(setr,msg,[get(%#/D`ARMORY`%q<etype>`OWNER)]'s %q<etype> "%q<centity1.id>: %q<centity1.name>" %q<choice> list.)];@attach %!/INC`MSG`CHAN=Added '%q<value>' to %q<msg>

&ARMORY`ADD`PILOT [u(Cobj,age)]=QUIRK

&INC`ARMORY`ADD`CENTITY`TRAIT [u(cobj,age)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: No %2 entered to add.;@check u(setr,trait_id,u(FIND_TRAIT,%3,%1))=@attach %!/INC`MSG=ERROR: Could not find %2 named '%1'.;@stop u(mysql,EXIST`CENTITY_TRAIT,%q<centity1.id>,%q<trait_id>,%4)=@attach %!/INC`MSG=ERROR: %q<etype> already has that %2.;@attach %!/INC`DOSQL=ADD`CENTITY_TRAIT,%q<centity1.id>,%q<trait_id>,%4,1;th u(setq,value,u(cust,%3,%q<trait_id>))

&Q`EXIST`CENTITY_TRAIT [u(cobj,age)]=SELECT trait_value FROM vol_ctrait WHERE centity_id=? AND trait_id=? AND trait_type=? 
&Q`ADD`CENTITY_TRAIT [u(cobj,age)]=INSERT INTO vol_ctrait (centity_id,trait_id,trait_type,trait_value) VALUES (?,?,?,?) ON DUPLICATE KEY UPDATE trait_value=VALUES(trait_value)

&INC`ARMORY`ADD`PILOT`QUIRK [u(cobj,age)]=@attach %!/INC`ARMORY`ADD`CENTITY`TRAIT=%0,%1,Quirk,QRK,2

@@ ---- ARMORY SECTION FOR REMOVE
&INC`ARMORY`REMOVE [u(cobj,age)]=@attach %!/INC`LOADSELECT;@check strlen(%0)=@attach %!/INC`MSG=ERROR: Must choose a parameter to add!;@attach %!/INC`PARTIAL=%0,u(ARMORY`REMOVE`%q<etype>,%#),|,choice;@attach %!/INC`ARMORY`REMOVE`%q<etype>`%q<choice>;@attach %!/INC`MSG=You removed '%q<value>' from [u(setr,msg,[get(%#/D`ARMORY`%q<etype>`OWNER)]'s %q<etype> "%q<centity1.id>: %q<centity1.name>" %q<choice> list.)];@attach %!/INC`MSG`CHAN=Removed '%q<value>' from %q<msg>

&ARMORY`REMOVE`PILOT [u(cobj,age)]=u(ARMORY`ADD`PILOT,%0)

&INC`ARMORY`REMOVE`CENTITY`TRAIT [u(cobj,age)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: No %2 entered to remove.;@check u(setr,trait_id,u(FIND_TRAIT,%3,%1))=@attach %!/INC`MSG=ERROR: Could not find %2 named '%1'.;@check u(mysql,EXIST`CENTITY_TRAIT,%q<centity1.id>,%q<trait_id>,%4)=@attach %!/INC`MSG=ERROR: %q<etype> lacks that %2.;@attach %!/INC`DOSQL=DELETE`CENTITY_TRAIT,%q<centity1.id>,%q<trait_id>,%4;th u(setq,value,u(cust,%3,%q<trait_id>))

&Q`DELETE`CENTITY_TRAIT [u(cobj,age)]=DELETE FROM vol_ctrait WHERE centity_id=? AND trait_id=? AND trait_type=?

&INC`ARMORY`REMOVE`PILOT`QUIRK [u(cobj,age)]=@attach %!/INC`ARMORY`REMOVE`CENTITY`TRAIT=%0,%1,Quirk,QRK,2


@@ ----- ARMORY SECTION FOR TRANSFER
&INC`ARMORY`TRANSFER [u(cobj,age)]=@attach %!/INC`LOADSELECT;@attach %!/INC`ATARGET=%0,1;@select/inline strlen(%1)=>0,{@attach %!/INC`VALID`ENAME=%1};@stop cand(u(setr,fid2,first(u(mysql2,EXIST`CENTITY,%q<eid>,u(VERSION,%#),%q<tar1id>,u(strfirstof,%q<value>,%q<centity1.name>),u(strfirstof,%q<value>,%q<centity1.name>)),|)),neq(%q<centity1.id>,%q<fid2>))=@attach %!/INC`MSG=ERROR: %q<etype> names must be unique per Owner.;@attach %!/INC`ARMORY`TRANSFER`CENTITY;@attach %!/INC`ARMORY`TRANSFER`CENTITY`%q<etype>;&D`ARMORY`%q<etype>`TYPE %#=%q<tar1type>;&D`ARMORY`%q<etype>`OWNER %#=%q<tar1name>;&D`ARMORY`%q<etype>`OWNER_ID %#=%q<tar1id>;&D`ARMORY`%q<etype>`NAME %#=u(strfirstof,%q<value>,%q<centity1.name>);@attach %!/INC`MSG=You transferred [u(setr,msg,%q<centity1.ownername>'s %q<etype> "%q<centity1.id>: %q<centity1.name>" to: %q<tar1type>: %q<tar1name>)];@attach %!/INC`MSG`CHAN=Transferred %q<msg>

&INC`ARMORY`TRANSFER`CENTITY [u(cobj,age)]=@attach %!/INC`DOSQL=TRANSFER`CENTITY,switch(%q<tar1id>,NULL,SET_NULL,%q<tar1id>),%q<centity1.id>

&Q`TRANSFER`CENTITY [u(cobj,age)]=UPDATE vol_centity SET centity_owner=? WHERE centity_id=?

&INC`ARMORY`TRANSFER`CENTITY`CHARACTER [u(cobj,age)]=@attach %!/INC`DOSQL=TRANSFER`CENTITY`CHARACTER,%q<tar1id>,%q<centity1.id>;

&Q`TRANSFER`CLINK [u(cobj,age)]=UPDATE vol_clink SET character_id=? WHERE centity_id=? AND clink_parent IS NULL

@@ ----- ARMORY SECTION FOR CLONE
&INC`ARMORY`CLONE [u(cobj,age)]=@attach %!/INC`LOADSELECT;@attach %!/INC`ATARGET=%0,1;@select/inline strlen(%1)=>0,{@attach %!/INC`VALID`ENAME=%1};@stop cand(u(setr,fid2,first(u(mysql2,EXIST`CENTITY,%q<eid>,u(VERSION,%#),%q<tar1id>,u(strfirstof,%q<value>,%q<centity1.name>),u(strfirstof,%q<value>,%q<centity1.name>)),|)),neq(%q<centity1.id>,%q<fid2>))=@attach %!/INC`MSG=ERROR: %q<etype> names must be unique per Owner.;@attach %!/INC`ARMORY`CLONE`CENTITY;@attach %!/INC`ARMORY`CLONE`CENTITY`%q<etype>;

&INC`ARMORY`CLONE`CENTITY [u(cobj,age)]=@attach %!/INC`DOSQL=CLONE`CENTITY`1/newid,u(strfirstof,%q<value>,%q<centity1.name>);@attach %!/INC`DOSQL=CLONE`CENTITY`2,%q<newid>,%q<tar1id>,%q<centity1.id>;@attach %!/INC`DOSQL=CLONE`CENTITY`3,%q<newid>,%q<centity1.id>

&Q`CLONE`CENTITY`1 [u(cobj,age)]=INSERT INTO vol_entity (entity_type,entity_name) VALUES (9,?)
&Q`CLONE`CENTITY`2 [u(cobj,age)]=INSERT INTO vol_centity (centity_id,centity_date_created,centity_version,centity_type,centity_owner,centity_lock,centity_approved) SELECT ?,UTC_TIMESTAMP(),centity_version,centity_type,?,centity_lock,centity_approved FROM vol_centity WHERE centity_id=?
&Q`CLONE`CENTITY`3 [u(Cobj,age)]=INSERT INTO vol_ctrait (centity_id,trait_id,trait_type,trait_value,trait_flags_1,trait_flags_2) SELECT ?,trait_id,trait_type,trait_value,trait_flags_1,trait_flags_2 FROM vol_ctrait WHERE centity_id=?

&INC`ARMORY`CLONE`CENTITY`CHARACTER [u(cobj,age)]=@attach %!/INC`DOSQL=CLONE`CLINK,%q<tar1id>,%q<newid>,%q<centity1.id>,get(%0/D`ARMORY`%q<etype>`OWNER_ID);

&Q`CLONE`CLINK [u(cobj,age)]=INSERT INTO vol_clink (character_id,centity_id,clink_approved,clink_type,clink_locked) SELECT (?,?,clink_approved,clink_type,clink_locked) FROM vol_clink WHERE centity_id=? AND character_id=?

@@ ---------- ARMORY SECTION FOR LOANSYS

@@ Lock
&INC`ARMORY`UNLOCK [u(cobj,age)]=@attach %!/INC`ARMORY`LOCK=#TRUE,%1,1
&INC`ARMORY`RAWLOCK [u(cobj,age)]=@attach %!/INC`ARMORY`LOCK=%0,%1,1
&INC`ARMORY`LOCK [u(cobj,age)]=@attach %!/INC`LOADSELECT;@attach %!/INC`VALID`[if(%2,LOCK,GROUPLOCK)]=%0;@attach %!/INC`DOSQL=LOCK`CENTITY,%q<value>,%q<centity1.id>;@attach %!/INC`MSG=Locked [u(setr,msg,%q<centity1.ownername>'s %q<etype> "%q<centity1.id>: %q<centity1.name>" to: %q<valueformat>)];@attach %!/INC`MSG`CHAN=Locked %q<msg>

&Q`LOCK`CENTITY [u(cobj,age)]=UPDATE vol_centity SET centity_claim_lock=? WHERE centity_id=?



@@ Claim
&INC`ARMORY`CLAIM [u(cobj,age)]=@attach %!/INC`ATARGET=%0,1;@attach %!/INC`ARMORY`CLAIM`%q<tar1type>;@attach %!/INC`VALID`ETARGET=%1;@check strlen(u(setr,claimable,filterbool(#lambda/testlock(elements(\%0,2,chr(177)),%#),u(mysql3,LIST`CLAIMABLE,%q<tar1id>,u(VERSION,%#),%q<eid>),chr(176),chr(176))))=@attach %!/INC`MSG=ERROR: %q<tar1type> %q<tar1name> has no claimable %q<etype>S you can access!;th u(setq,claimids,u(SQL`IN`NUMBER,iter(%q<claimable>,first(%i0,chr(177)),chr(176),%b)));@check strlen(u(setr,found,u(mysql,SELECT`CENTITY_NAME_IDFILTER,%q<claimids>,%q<value>,%q<value>,%q<value>)))=@attach %!/INC`MSG=ERROR: Cannot find %q<etype> called %q<value>;@stop u(mysql,EXIST`CLAIM,%q<t1id>,first(%q<found>,chr(177)))=@attach %!/INC`MSG=ERROR: You already have a link to that %q<etype>!;@attach %!/INC`DOSQL=CLAIM`%q<etype>,%q<t1id>,u(setr,claimid,first(%q<found>,chr(177))),%q<tar1id>;@attach %!/INC`ARMORY`CLAIM`%q<etype>;@attach %!/INC`ARMORY`CLAIM`%q<etype>`%q<tar1type>;@attach %!/INC`MSG=You claim [u(setr,msg,"%q<claimid>: [rest(%q<found>,chr(177))]" from %q<tar1type>: %q<tar1name>.)];@attach %!/INC`MSG`CHAN=Claimed %q<msg>

&Q`EXIST`CLAIM [u(cobj,age)]=SELECT centity_id FROM vol_clink WHERE character_id=? AND centity_id=? LIMIT 1

&Q`LIST`CLAIMABLE [u(cobj,age)]=SELECT centity_id,centity_claim_lock FROM volv_centity WHERE centity_owner=? AND centity_version=? AND centity_type=? ORDER BY CHAR_LENGTH(centity_name)

&Q`SELECT`CENTITY_NAME_IDFILTER [u(Cobj,age)]=SELECT centity_id,centity_name FROM volv_centity WHERE centity_id IN (!) AND (centity_id=? OR (centity_name=? OR centity_name LIKE '!%')) ORDER BY CHAR_LENGTH(centity_name) LIMIT 1

&Q`CLAIM`PILOT [u(cobj,age)]=INSERT INTO vol_clink (character_id,centity_id,clink_approved,clink_loan_from,clink_locked) VALUES (?,?,1,?,1)

@@ Release
&INC`ARMORY`RELEASE [u(cobj,age)]=@attach %!/INC`VALID`ETARGET=%0;@check u(setr,found,u(mysql3,RELEASE`%q<etype>,%q<t1id>,u(VERSION,%#),%q<eid>,%q<value>,%q<value>,sqlescape(%q<value>)))=@attach %!/INC`MSG=ERROR: No loaned %q<etype> found by that name or ID!;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will remove %q<etype> "[elements(%q<found>,2,chr(177))]: [elements(%q<found>,3,chr(177))]" from your character. You may not have the permissions to re-claim it. Are you sure? Enter the same command again to verify.,RELEASE %q<etype> %q<found>;@attach %!/INC`DOSQL=DELETE`CLINK,elements(%q<found>,1,chr(177));@attach %!/INC`MSG=You released your claim on [elements(%q<found>,4,chr(177))]'s %q<etype> "[elements(%q<found>,2,chr(177))]: [elements(%q<found>,3,chr(177))]"!;@attach %!/INC`MSG`CHAN=Released claim on [elements(%q<found>,4,chr(177))]'s' %q<etype> "[elements(%q<found>,2,chr(177))]: [elements(%q<found>,3,chr(177))]"

&Q`RELEASE`PILOT [u(cobj,age)]=SELECT clink_id,centity_id,centity_name,centity_owner_name FROM volv_clink WHERE character_id=? AND centity_version=? AND centity_type=? AND clink_locked>0 AND (centity_id=? OR (centity_name=? OR centity_name LIKE '!%')) ORDER BY CHAR_LENGTH(centity_name) LIMIT 1

&Q`DELETE`CLINK [u(cobj,age)]=DELETE FROM vol_clink WHERE clink_id=?

@@ Grant
&INC`ARMORY`GRANT [u(cobj,age)]=@attach %!/INC`CHECKPC=%0,2;@attach %!/INC`VALID`ETARGET=%1;@check strlen(u(setr,found,u(mysql3,GRANT`%q<etype>,%q<t1id>,u(VERSION,%#),%q<eid>,%q<value>,%q<value>,sqlescape(%q<value>),%q<t1id>)))=@attach %!/INC`MSG=ERROR: Cannot find an owned %q<etype> named %q<value>!;@stop u(mysql,EXIST`CLAIM,%q<t2id>,elements(%q<found>,2,chr(177)))=@attach %!/INC`MSG=ERROR: %q<t2name> already has a link to that %q<etype>!;@attach %!/INC`DOSQL=CLAIM`%q<etype>,%q<t2id>,elements(%q<found>,2,chr(177)),%q<t1id>;@attach %!/INC`MSG=You have granted %q<t1name> your %q<etype> "[elements(%q<found>,2,chr(177))]: [elements(%q<found>,3,chr(177))]";@attach %!/INC`MSG=%n granted you %p %q<etype> "[elements(%q<found>,2,chr(177))]: [elements(%q<found>,3,chr(177))]"!,%q<t2>;@attach %!/INC`MSG`CHAN=%n granted %q<t2name> %p %q<etype> "[elements(%q<found>,2,chr(177))]: [elements(%q<found>,3,chr(177))]"!

&Q`GRANT`PILOT [u(Cobj,age)]=SELECT clink_id,centity_id,centity_name FROM volv_clink WHERE character_id=? AND centity_version=? AND centity_type=? AND clink_locked=0 AND (centity_id=? OR (centity_name=? OR centity_name LIKE '!%')) AND centity_owner=? ORDER BY CHAR_LENGTH(centity_name) LIMIT 1

@@ Revoke
&INC`ARMORY`REVOKE [u(cobj,age)]=@attach %!/INC`CHECKPC=%0,2;@attach %!/INC`VALID`ETARGET=%1;@check strlen(u(setr,found,u(mysql3,REVOKE`%q<etype>,%q<t2id>,u(VERSION,%#),%q<eid>,%q<value>,%q<value>,sqlescape(%q<value>),%q<t1id>)))=@attach %!/INC`MSG=ERROR: Cannot find a granted %q<etype> named %q<value>!;@attach %!/INC`DOSQL=DELETE`CLINK,elements(%q<found>,1,chr(177));@attach %!/INC`MSG=You have revoked %q<t1name>'s access to your %q<etype> "[elements(%q<found>,2,chr(177))]: [elements(%q<found>,3,chr(177))]";@attach %!/INC`MSG=%n revoked your access to %p %q<etype> "[elements(%q<found>,2,chr(177))]: [elements(%q<found>,3,chr(177))]"!,%q<t2>;@attach %!/INC`MSG`CHAN=%n revoked %q<t1name>'s access to %p %q<etype> "[elements(%q<found>,2,chr(177))]: [elements(%q<found>,3,chr(177))]"!

&Q`REVOKE`PILOT [u(cobj,age)]=SELECT clink_id,centity_id,centity_name FROM volv_clink WHERE character_id=? AND centity_version=? AND centity_type=? AND (centity_id=? OR (centity_name=? OR centity_name LIKE '!%')) AND centity_owner=? ORDER BY CHAR_LENGTH(centity_name)

&VIEW`STAT [u(Cobj,age)]=switch(%0,1,Poor,2,Average,3,Good,4,Great,5,Excellent,?)
&VIEW`STAT2 [u(Cobj,age)]=switch(%0,1,D,2,C,3,B,4,A,5,S,?)
&VIEW`STAT3 [u(Cobj,age)]=switch(%0,1,Pr,2,Av,3,Gd,4,Gr,5,Ex,??)

@@ ---- ARMORY section for MAIN
&INC`ARMORY`MAIN [u(cobj,age)]=@select/inline strlen(%0)=>0,{@attach %!/INC`VALID`ETARGET;@check strlen(u(setr,found,u(mysql3,CHOOSE`%q<etype>,%q<t1id>,u(VERSION,%#),%q<eid>,%q<value>,%q<value>,sqlescape(%q<value>))))=@attach %!/INC`MSG=ERROR: Cannot find a %q<etype> called %q<value>!;@@ @select/inline cor(get(%#/D`COMBAT`DAMAGE),nattr(%#/D`COMBAT`Q`**))=1,{@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] You appear to be in combat. Changing %q<etype>S will force a +reset. Are you sure? Enter the same command again to continue.,ARMORY CHANGE %q<etype> [first(%q<found>,chr(177))]};@attach %!/WIPE=%#,D`ARMORY`MAIN`%q<etype>;@attach %!/INC`ARMORY`MAIN`%q<etype>;@attach %!/INC`MSG=You are now ready to rock as the %q<etype> "[elements(%q<found>,1,chr(177))]: [elements(%q<found>,2,chr(177))]"},0,{@attach %!/INC`ARMORY`LIST}

&INC`ARMORY`MAIN`PILOT [u(cobj,age)]=@dolist/inline/delimit | 1~ID|2~NAME|3~LINK|4~LOCKED={th u(attrib_set,%#,D`ARMORY`MAIN`%q<etype>`[after(%i0,~)],elements(%q<found>,before(%i0,~),chr(177)))};@dolist/inline/delimit [chr(176)] [u(mysql3,GROUP`TRAITS,get(%#/D`ARMORY`MAIN`%q<etype>`ID))]={th u(attrib_set,%#,D`ARMORY`MAIN`%q<etype>`TRAITS`[before(%i0,chr(177))],after(%i0,chr(177)))}

&INC`ARMORY`MAIN`MECHA [u(cobj,age)]=@attach %!/INC`ARMORY`MAIN`PILOT

&Q`CHOOSE`PILOT [u(cobj,age)]=SELECT l.centity_id,l.centity_name,l.clink_id,l.clink_locked FROM volv_clink AS l WHERE l.character_id=? AND l.centity_version=? AND l.centity_type=? AND (l.centity_id=? OR (l.centity_name=? OR l.centity_name LIKE '!%')) ORDER BY CHAR_LENGTH(l.centity_name) LIMIT 1

&Q`CHOOSE`MECHA [u(cobj,age)]=SELECT l.centity_id,l.centity_name,l.clink_id,l.clink_locked FROM volv_clink AS l WHERE l.character_id=? AND l.centity_version=? AND l.centity_type=? AND (l.centity_id=? OR (l.centity_name=? OR l.centity_name LIKE '!%')) ORDER BY CHAR_LENGTH(l.centity_name) LIMIT 1

&Q`GROUP`TRAITS [u(cobj,age)]=SELECT trait_type,GROUP_CONCAT(trait_id ORDER BY trait_id SEPARATOR ' ') FROM vol_ctrait WHERE trait_value>0 AND trait_type>0 AND centity_id=? GROUP BY trait_type ORDER BY trait_type

@@ ---- ARMORY help section
&SHLP`ARMORY [u(cobj,age)]=The Armory System is a generic framework for creating and maintaining different Combat System entities. Each game may implement its own commands such as +pilot or +armor which may have unique differences listed in sub-files of this one. This file covers the general concepts. Replace the +armory command with whatever's relevant for this game like +mantle/list!%R%R[ansi(hc,Concepts)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,target)] - All Combat Entities are OWNED BY one of three possible things: a specific CHARACTER\, a specific GROUP\, or the GLOBAL list - effectively owned by admin or the game itself. Whenever a <target> is called for\, it is entered as follows: Character/<Name>\, Group/<Name>\, or Global. This does take partial match! You can do C/<name> and so on.)]%R%R[ansi(hc,Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+armory/list <target>)] - Lists what a target owns. For characters it also lists whatever they're borrowing. Un-privileged players can only see Combat Entities if they pass its Claim Lock \(see below\).%R[ansi(h,+armory/create <target>=<name>)] - Creates a new Combat Entity owned by <target>. It will have all default stats and be auto-selected for editing.%R[ansi(h,+armory/delete <target>=<name>)] - Delete a Combat Entity. This CANNOT be undone! So be careful. <name> must be the exact name for sanity-checking but is not case-sensitive.%R[ansi(h,+armory/select <target>=<name>)] - Selects a Combat Entity for editing. This is useful for commands listed below.%R[ansi(h,+armory/transfer <target>\[=<name>\])] - Transfer the selected Combat Entity to a different owner. An optional name can be provided to rename it on the fly if the owner already has a Combat Entity of this name.%R[ansi(h,+armory/clone <target>\[=<name>\])] - Creates an identical copy of the selected Combat Entity and gives it to <target>. This is NOT the same as a loaned/borrowed Combat Entity - it is a standalone copy.%R[ansi(h,+armory/lock <lockstring>)] - Set the Claim Lock on a Combat Entity. This defaults to #FALSE \(nobody\). /lock uses the LockGen \(+help LockGen\) system. use /rawlock to instead use PennMUSH locks. /unlock simply sets it #TRUE \(everyone can see/claim it\).%R[ansi(h,+armory/set name=<new name>)] - Renames the selected Combat Entity. This is only a tiny bit of what /set can do though. See subfiles.)]
+shelp/add Character/Armory=[u(cobj,age)]/SHLP`ARMORY

&SHLP`ARMORY`PILOT [u(cobj,age)]=Note: these commands first require you to use +mantle/select <target>=<mantlename>!%R%R[ansi(hc,Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+mantle/set <stat>=<value>)] - <stat> can be POWER\, ENDURANCE\, PRECISION\, or MITIGATION. <value> takes a number 1-5.%R[ansi(h,+mantle/set Weight=<value>)] - <Value> is the name of the Weight class. Light\, Heavy\, etc.%R[ansi(h,+mantle/set Archetype=<value>)] - <value> is the name of the Archetype.%R[ansi(h,+mantle/add quirk=<value>)] - This is used only for mantles with static Quirks that override player preferences. <value> is the name of a Quirk. If a mantle has even a single static Quirk then it will ignore all player prefs!%R[ansi(h,+mantle/remove quirk=<value>)] - Remove a quirk added via /add.%R[ansi(h,+mantle/set <bonus>=<value>)] - <bonus> can be POWBON\, ENDBON\, PREBON\, MITBON\, or HEATBON. Set to 0 or 1. Numbers higher than 1 do not count.%R[ansi(h,+mantle/set approved=<value>)] - Set to 0 \(no\) or 1 \(yes\). Unapproved Mantles cannot be used. \(Not currently implemented\))]
+shelp/addsub Armory/+mantle=[u(cobj,age)]/SHLP`ARMORY`PILOT

@@ +matrix section
&CMD`MATRIX [u(cobj,age)]=$^(?s)\+(matrix|rollforce|tensionforce|heatforce|switch|damageforce|auxforce|healforce|csetup)(?\:/(\S+))?(?\: +(.+?))?(?\:/(.+?)?)?(?\:=(.*))?$:th u(setq,sysname,MATRIX);@check cor(u(isadmin,%#),u(tester,%#))=@attach %!/INC`MSG=Try as you might\, you cannot see the Matrix.;@attach %!/INC`%q<sysname>`%1=%3,%4,%5
@set [u(cobj,age)]/CMD`MATRIX=regexp

&INC`MATRIX`MATRIX [u(cobj,age)]=&D`MATRIX %#=not(get(%#/D`MATRIX));@attach %!/INc`MSG=You [if(get(%#/D`MATRIX),will now,will no longer)] see the Matrix.

&INC`MATRIX`START [u(cobj,age)]=@attach %!/INC`CHECKPC=%0,1;@check nattr(%q<t1>/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: %q<t1name> is not battle-ready!;@attach %!/INC`VALID`INT=%2;

&INC`MATRIX`ROLLFORCE [u(cobj,age)]=@attach %!/INC`MATRIX`START;&D`ROLLFORCE %q<t1>=%q<value>;@attach %!/INC`MSG=Okay! %q<t1name>'s' next defense roll will be: %q<value>

&INC`MATRIX`TENSIONFORCE [u(cobj,age)]=@attach %!/INC`MATRIX`START;&D`COMBAT`TENSION %q<t1>=%q<value>;@attach %!/INC`MSG=Okay! %q<t1name>'s current Tension is %q<value>. We are spring-loaded!

&INC`MATRIX`AUXFORCE [u(cobj,age)]=@attach %!/INC`MATRIX`START;&D`COMBAT`AUX %q<t1>=%q<value>;@attach %!/INC`MSG=Okay! %q<t1name>'s current Aux is %q<value>. Shifting to Auxiliary power!

&INC`MATRIX`DAMAGEFORCE [u(cobj,age)]=@attach %!/INC`MATRIX`START;@attach %!/INC`DAMAGE=%q<t1>,%q<value>,Damage Force

&INC`MATRIX`HEALFORCE [u(cobj,age)]=@attach %!/INC`MATRIX`START;@attach %!/INC`HEAL=%q<t1>,%q<value>,Heal Force

&INC`MATRIX`HEATFORCE [u(cobj,age)]=@attach %!/INC`MATRIX`START;&D`COMBAT`HEAT %q<t1>=%q<value>;@attach %!/INC`MSG=Okay! %q<t1name>'s current Heat is %q<value>. Do you feel the heat?;th u(attrib_set,%q<t1>,D`COMBAT`HEAT`STATUS,u(heatstatus,%q<t1>))

@@ PUSHES
&INC`SETSTATUS [u(cobj,age)]=@dolist/inline get(%0/D`COMBAT`ACTIVE`STATUS)={@attach %!/STATUS`[before(%i0,$)]`PRE_SET_STATUS=%0,%1,%2,get(u(cobj,age)/STATUS`%2`TAGS),%4,%5};@select/inline strlen(%q<blockstatus>)=0,{@attach %!/INC`SETSTATUS`[default(u(cobj,age)/STATUS`%2`TYPE,STACK)]}
@@ %0 - Target. %1 - Source. %2 - Status to inflict. %3 - Arguments. %4 - Attack Turn Bonus. %5 - Defense Turn Bonus. (Set to X for indefinite.) %6 - Additional Tags.

&INC`SETSTATUS`IGNORE [u(cobj,age)]=@select/inline words(get(%0/D`COMBAT`ACTIVE`STATUS`%2))=>0,{},0,{@attach %!/INC`SETSTATUS`STACK}

&INC`SETSTATUS`REPLACE [u(Cobj,age)]=@select/inline words(u(setr,foundstatus,first(get(%0/D`COMBAT`ACTIVE`STATUS`%2))))=>0,{@attach %!/KILLSTATUS=%0,%q<foundstatus>;@attach %!/INC`SETSTATUS`STACK},0,{@attach %!/INC`SETSTATUS`STACK}

&INC`SETSTATUS`QUEUE [u(cobj,age)]=@select/inline words(get(%0/D`COMBAT`ACTIVE`STATUS`%2))=>0,{th u(attrib_set,%0,D`COMBAT`QUEUE`%2,insert(get(%0/D`COMBAT`QUEUE`%2),-1,%1~%3~%4~%5,^))},0,{@attach %!/INC`SETSTATUS`STACK}

&INC`SETSTATUS`ADD [u(cobj,age)]=@select/inline words(u(setr,foundstatus,first(get(%0/D`COMBAT`ACTIVE`STATUS`%2))))=>0,{@select/inline %4=X,{th u(attrib_set,%0,D`COMBAT`STATUS`%q<foundstatus>`ATTACK_TURNS,X)},{@select/inline get(%0/D`COMBAT`STATUS`%q<foundstatus>`ATTACK_TURNS)=X,{},{th u(addto,%0,D`COMBAT`STATUS`%q<foundstatus>`ATTACK_TURNS,%4)}};@select/inline %5=X,{th u(attrib_set,%0,D`COMBAT`STATUS`%q<foundstatus>`DEFENSE_TURNS,X)},{@select/inline get(%0/D`COMBAT`STATUS`%q<foundstatus>`DEFENSE_TURNS)=X,{},{th u(addto,%0,D`COMBAT`STATUS`%q<foundstatus>`DEFENSE_TURNS,%5)}};th u(attrib_set,%0,D`COMBAT`STATUS`%q<foundstatus>`SOURCE,setunion(get(%0/D`COMBAT`STATUS`%q<foundstatus>`SOURCE),%1))},0,{@attach %!/INC`SETSTATUS`STACK}

&INC`SETSTATUS`STACK [u(cobj,age)]=th u(attrib_set,%0,D`COMBAT`STATUS,u(setr,next,add(1,get(%0/D`COMBAT`STATUS))));@cpattr [u(cobj,age)]/STATUS`%2=%0/D`COMBAT`STATUS`[u(setr,statid,%2$%q<next>)];th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`%2,setunion(get(%0/D`COMBAT`ACTIVE`STATUS`%2),%q<statid>));th u(attrib_set,%0,D`COMBAT`STATUS`%q<statid>`SOURCE,%1);@select/inline match(get(u(cobj,age)/STATUS`%2`ATTACK_TURNS) %4 %q<statusatkturns>,X)=>0,{th u(attrib_set,%0,D`COMBAT`STATUS`%q<statid>`ATTACK_TURNS,X)},0,{th u(attrib_set,%0,D`COMBAT`STATUS`%q<statid>`ATTACK_TURNS,add(get(u(cobj,age)/STATUS`%2`ATTACK_TURNS),%4,%q<statusatkturns>))};@select/inline t(get(%0/D`COMBAT`STATUS`%q<statid>`ATTACK_TURNS))=1,{th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`ATTACK,setunion(get(%0/D`COMBAT`ACTIVE`STATUS`ATTACK),%q<statid>))};@select/inline match(get(u(cobj,age)/STATUS`%2`DEFENSE_TURNS) %5 %q<statusdefturns>,X)=>0,{th u(attrib_set,%0,D`COMBAT`STATUS`%q<statid>`DEFENSE_TURNS,X)},0,{th u(attrib_set,%0,D`COMBAT`STATUS`%q<statid>`DEFENSE_TURNS,add(get(u(cobj,age)/STATUS`%2`DEFENSE_TURNS),%5,%q<statusdefturns>))};@select/inline t(get(%0/D`COMBAT`STATUS`%q<statid>`DEFENSE_TURNS))=1,{th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`DEFENSE,setunion(get(%0/D`COMBAT`ACTIVE`STATUS`DEFENSE),%q<statid>))};@dolist/inline/nobreak/delimit | %3|%q<statargs>={@check strlen(%i0);th u(attrib_set,%0,D`COMBAT`STATUS`%q<statid>`[before(%i0,=)],after(%i0,=))};@dolist/inline setunion(get(u(cobj,age)/STATUS`%2`TAGS),%6)={th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`TAGS`%i0,setunion(get(%0/D`COMBAT`ACTIVE`STATUS`TAGS`%i0),%q<statid>))};th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS,setunion(get(%0/D`COMBAT`ACTIVE`STATUS),%q<statid>));@dolist/inline/nobreak edit(lattr(%!/STATUS`%2`**),STATUS`%2`,)={@check strlen(get(%!/STATUS`%2`%i0));@stop match(TYPE TAGS DESCRIPTION,elements(%i0,1,`));th u(attrib_set,%0,D`COMBAT`HOOKS`%i0,setunion(%q<statid>,get(%0/D`COMBAT`HOOKS`%i0)))};@attach %!/STATUS`%2`ON_ACTIVATE=%0,%q<statid>;th unsetq(status???turns);@dolist/inline get(%0/D`COMBAT`HOOKS`ON_GAIN_STATUS)={@attach %!/STATUS`[before(%i0,$)]`ON_GAIN_STATUS=%0,%1,%q<statid>,%3,%4,%5};@dolist/inline get(%1/D`COMBAT`ACTIVE`STATUS)={@attach %!/STATUS`[before(%i0,$)]`ON_INFLICT_STATUS=%1,%0,%q<statid>}



&BOOST`1 [u(cobj,agedb)]=Flush
&BOOST`1`CHOICES [u(cobj,agedb)]=1
&BOOST`1`1 [u(cobj,agedb)]=Consumes all Aux to reduce current Heat by 5 per Aux.
&BOOST`1`ACTIVATE [u(cobj,agedb)]=@check u(setr,myaux,get(%#/D`COMBAT`AUX))=@attach %!/INC`MSG=ERROR: It would be rather silly to Flush without any Aux\, now wouldn't it?;@attach %!/INC`HEAT=%#,[mul(%q<myaux>,-5)],FLUSH;th u(attrib_set,%#,D`COMBAT`AUX,0)


&PUSH`2 [u(cobj,agedb)]=Defense
&PUSH`2`CHOICES [u(cobj,agedb)]=2|4|6
&PUSH`2`2 [u(cobj,agedb)]=The next attack against you deals a Standard degree of less damage.
&PUSH`2`4 [u(cobj,agedb)]=The next attack against you deals a Substantial degree of less damage.
&PUSH`2`6 [u(cobj,agedb)]=The next attack against you deals an Overwhelming degree of less damage.
&PUSH`2`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_DEFENSE,COST=%q<hypecost>|DISPLAY=[switch(%q<hypecost>,2,Standard,4,Substantial,6,Overwhelming)],0,1

&PUSH`3 [u(cobj,agedb)]=Balance
&PUSH`3`CHOICES [u(cobj,agedb)]=2|4|6
&PUSH`3`2 [u(cobj,agedb)]=Your next attack deals a Small degree of more damage, and the next attack against you deals a Small degree of less damage.
&PUSH`3`4 [u(cobj,agedb)]=Your next attack deals a Standard degree of more damage, and the next attack against you deals a Standard degree of less damage.
&PUSH`3`6 [u(cobj,agedb)]=Your next attack deals a Considerable degree of more damage, and the next attack against you deals a Considerable degree of less damage.
&PUSH`3`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_BALANCE,COST=%q<hypecost>|DISPLAY=[switch(%q<hypecost>,2,Small,4,Standard,6,Considerable)],1,1

&PUSH`4 [u(cobj,agedb)]=Buff
&PUSH`4`CHOICES [u(cobj,agedb)]=1|3|5|7
&PUSH`4`1 [u(cobj,agedb)]=You gain a Buff that grants a Minor bonus to Precision, Power, Endurance, or Mitigation, for your next 2 turns.
&PUSH`4`3 [u(cobj,agedb)]=You gain a Buff that grants a Solid bonus to Precision, Power, Endurance, or Mitigation, for your next 2 turns.
&PUSH`4`5 [u(cobj,agedb)]=You gain a Buff that grants a Major bonus to Precision, Power, Endurance, or Mitigation, for your next 2 turns.
&PUSH`4`7 [u(cobj,agedb)]=You gain a Buff that grants a Superior bonus to Precision, Power, Endurance, or Mitigation, for your next 2 turns.
&PUSH`4`ACTIVATE [u(cobj,agedb)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: You must choose a stat! Syntax: +push Buff/#=<stat>;@attach %!/INC`PARTIAL=%1,POWER|PRECISION|ENDURANCE|MITIGATION,|,pushchoice;@attach %!/INC`SETSTATUS=%#,%#,PUSH_BUFF_%q<pushchoice>,COST=%q<hypecost>|DISPLAY=[switch(%q<hypecost>,1,Minor,3,Solid,5,Major,7,Superior)]

&PUSH`5 [u(cobj,agedb)]=Debuff
&PUSH`5`CHOICES [u(cobj,agedb)]=1|3|5|7
&PUSH`5`1 [u(cobj,agedb)]=Your next attack applies a Debuff that imposes a Minor penalty to Precision, Power, Endurance, or Mitigation, for the target’s next 2 turns.
&PUSH`5`3 [u(cobj,agedb)]=Your next attack applies a Debuff that imposes a Solid penalty to Precision, Power, Endurance, or Mitigation, for the target’s next 2 turns.
&PUSH`5`5 [u(cobj,agedb)]=Your next attack applies a Debuff that imposes a Major penalty to Precision, Power, Endurance, or Mitigation, for the target’s next 2 turns.
&PUSH`5`7 [u(cobj,agedb)]=Your next attack applies a Debuff that imposes a Superior penalty to Precision, Power, Endurance, or Mitigation, for the target’s next 2 turns.
&PUSH`5`ACTIVATE [u(cobj,agedb)]=@check strlen(%1)=@attach %!/INC`MSG=ERROR: You must choose a stat! Syntax: +push Debuff/#=<stat>;@attach %!/INC`PARTIAL=%1,POWER|PRECISION|ENDURANCE|MITIGATION,|,pushchoice;@attach %!/INC`SETSTATUS=%#,%#,PUSH_INFLICT_DEBUFF_%q<pushchoice>,COST=%q<hypecost>|DISPLAY=[switch(%q<hypecost>,1,Minor,3,Solid,5,Major,7,Superior)],1,0

&PUSH`6 [u(cobj,agedb)]=Damage Over Time
&PUSH`6`CHOICES [u(cobj,agedb)]=1|3|5|7
&PUSH`6`1 [u(cobj,agedb)]=A Small amount of damage from your next attack will be dealt to the target at the beginning of their turn, then a Tiny amount for their next 2 turns.
&PUSH`6`3 [u(cobj,agedb)]=A Standard amount of damage from your next attack will be dealt to the target at the beginning of their turn, then a Small amount for their next 2 turns.
&PUSH`6`5 [u(cobj,agedb)]=A Considerable amount of damage from your next attack will be dealt to the target at the beginning of their turn, then a Standard amount for their next 2 turns.
&PUSH`6`7 [u(cobj,agedb)]=A Substantial amount of damage from your next attack will be dealt to the target at the beginning of their turn, then a Standard amount for their next 2 turns.
&PUSH`6`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_INFLICT_DOT,COST=%q<hypecost>|DISPLAY=[switch(%q<hypecost>,1,Tiny,3,Standard,5,Considerable,7,Substantial)],1,0

&PUSH`7 [u(cobj,agedb)]=Cure
&PUSH`7`CHOICES [u(cobj,agedb)]=3|5|7
&PUSH`7`3 [u(cobj,agedb)]=You are cured of all Debuff or Damage Over Time effects of Moderate/Small severity or lower.
&PUSH`7`5 [u(cobj,agedb)]=You are cured of all Debuff or Damage Over Time effects of Significant/Standard severity or lower.
&PUSH`7`7 [u(cobj,agedb)]=You are cured of all Debuff or Damage Over Time effects of Superior/Substantial severity or lower.
&PUSH`7`ACTIVATE [u(cobj,agedb)]=@check words(u(setr,tocure,u(filter,COSTCOMPARE,setunion(get(%0/D`COMBAT`ACTIVE`STATUS`TAGS`DEBUFF),get(%0/D`COMBAT`ACTIVE`STATUS`TAGS`DOT)),%b,%b,CURE,switch(%2,3,Moderate,5,Significant,7,Superior),switch(%2,3,Small,5,Standard,7,Substantial),%0)))=@attach %!/INC`MSG=ERROR: Nothing to cure! Either no applicable Statuses found or existing Statuses are too potent.;@dolist/inline %q<tocure>={@attach %!/KILLSTATUS=%0,%i0,1};@attach %!/INC`EANNOUNCE=CURE,[ansi(hw,%n)] shrugs off negative Status Effects!

&PUSH`8 [u(cobj,agedb)]=Break
&PUSH`8`CHOICES [u(cobj,agedb)]=3|5|7
&PUSH`8`3 [u(cobj,agedb)]=Your next attack removes all Buff effects of a Moderate bonus or lower if it deals damage.
&PUSH`8`5 [u(cobj,agedb)]=Your next attack removes all Buff effects of a Significant bonus or lower if it deals damage.
&PUSH`8`7 [u(cobj,agedb)]=Your next attack removes all Buff effects of a Superior bonus or lower if it deals damage.
&PUSH`8`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_INFLICT_BREAK,COST=%q<hypecost>,1,0

&PUSH`9 [u(cobj,agedb)]=Boost
&PUSH`9`CHOICES [u(cobj,agedb)]=2|4|6
&PUSH`9`2 [u(cobj,agedb)]=You immediately gain 4 Heat.
&PUSH`9`4 [u(cobj,agedb)]=You immediately gain 8 Heat.
&PUSH`9`6 [u(cobj,agedb)]=You immediately gain 12 Heat.
&PUSH`9`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_BOOST,COST=%q<hypecost>,0,0

&PUSH`10 [u(cobj,agedb)]=Coup de Grace
&PUSH`10`CHOICES [u(cobj,agedb)]=3|5
&PUSH`10`3 [u(cobj,agedb)]=Your next attack converts all Debuff and Damage Over Time effects of Solid/Standard severity or lower into immediate heavy damage.
&PUSH`10`5 [u(cobj,agedb)]=Your next attack converts all Debuff and Damage Over Time effects currently on the target into immediate heavy damage.
&PUSH`10`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_COUPDEGRACE,COST=%q<hypecost>|DISPLAY=[switch(%q<hypecost>,3,Solid,5,All)],1,0

&PUSH`11 [u(cobj,agedb)]=Finishing Blow
&PUSH`11`CHOICES [u(cobj,agedb)]=10
&PUSH`11`10 [u(cobj,agedb)]=Your next attack, so long as it does not result in a Miss, automatically becomes a Direct Hit after its final result is decided, but is somewhat less damaging.
&PUSH`11`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_FINISHINGBLOW,COST=%q<hypecost>,1,0

&PUSH`12 [u(cobj,agedb)]=Second Wind
&PUSH`12`CHOICES [u(cobj,agedb)]=9
&PUSH`12`9 [u(cobj,agedb)]=You immediately recover 15% of your Max HP and all Debuffs and Damage over Time effects applied to you are cured, but you receive a Significant penalty to Endurance and Mitigation for one round. This Push can only be used once.
&PUSH`12`ACTIVATE [u(cobj,agedb)]=@stop get(%#/D`COMBAT`HISTORY`SECONDWIND)=@attach %!/INC`MSG=ERROR: You have already used Second Wind this fight!;@attach %!/INC`SETSTATUS=%#,%#,PUSH_SECONDWIND,COST=%q<hypecost>,0,1

&PUSH`13 [u(cobj,agedb)]=Ultimate Attack
&PUSH`13`CHOICES [u(cobj,agedb)]=10
&PUSH`13`10 [u(cobj,agedb)]=Your next attack deals +50% its normal amount of damage, but is somewhat less accurate.
&PUSH`13`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_ULTIMATEATTACK,COST=%q<hypecost>,1,0

&PUSH`14 [u(Cobj,agedb)]=Exhaust
&PUSH`14`CHOICES [u(Cobj,agedb)]=2|4|6
&PUSH`14`2 [u(cobj,agedb)]=Your next attack decreases your Opponent's Heat by 5 if it deals damage.
&PUSH`14`4 [u(cobj,agedb)]=Your next attack decreases your Opponent's Heat by 10 if it deals damage.
&PUSH`14`6 [u(cobj,agedb)]=Your next attack decreases your Opponent's Heat by 15 if it deals damage.
&PUSH`14`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_EXHAUST,COST=%q<hypecost>|DISPLAY=%q<hypecost>,1,0

&PUSH`15 [u(cobj,agedb)]=Indomitability
&PUSH`15`CHOICES [u(cobj,agedb)]=10
&PUSH`15`10 [u(cobj,agedb)]=After your next attack, take 30% less damage from the next attack. (When fighting multiple opponents, activate this just before +attack'ing the last one.)
&PUSH`15`ACTIVATE [u(cobj,agedb)]=@attach %!/INC`SETSTATUS=%#,%#,PUSH_INDOMITABILITY_PREPARE,COST=%q<hypecost>,1,0

@@ STATUS Section 
&GETSTATUS [u(cobj,age)]=add(if(isnum(u(setr,adjbon,u(STATUS`[before(%1,$)]`%2`%3,%0,%1))),%q<adjbon>,u(adj,u(adjinc,%q<adjbon>,0))),u(ladd,iter(setinter(get(%0/[if(%4,%4,D`COMBAT)]`HOOKS`STATUS`[before(%1,$)]`%2`%3),get(%0/[if(%4,%4,D`COMBAT)]`ACTIVE`STATUS`%2)),u(adj,u(STATUS`[before(%i0,$)]`STATUS`[before(%1,$)]`%2`%3,%0,%i0)))))
@@ Arguments. %0 - the character. %1 - the status name. %2 - Attack/Defense. %3 - The attribute to grab. %4 - An alternate root instead of D`COMBAT.



@@ STATUS - Offenses

&STATUS`ATK_ACCURATE [u(cobj,age)]=Accurate
&STATUS`ATK_ACCURATE`ATTACK`BONUS`STAT`1 [u(cobj,age)]=Solid
&STATUS`ATK_ACCURATE`ATTACK`BONUS`STAT`3 [u(cobj,age)]=Solid
&STATUS`ATK_ACCURATE`ATTACK`PENALTY`STAT`0 [u(cobj,age)]=Minor
&STATUS`ATK_ACCURATE`ATTACK`PENALTY`STAT`2 [u(cobj,age)]=Minor

&STATUS`ATK_FORCEFUL [u(cobj,age)]=Forceful
&STATUS`ATK_FORCEFUL`ATTACK`BONUS`STAT`0 [u(cobj,age)]=Solid
&STATUS`ATK_FORCEFUL`ATTACK`BONUS`STAT`2 [u(cobj,age)]=Solid
&STATUS`ATK_FORCEFUL`ATTACK`PENALTY`STAT`1 [u(cobj,age)]=Minor
&STATUS`ATK_FORCEFUL`ATTACK`PENALTY`STAT`3 [u(cobj,age)]=Minor

&STATUS`ATK_TRAINED [u(cobj,age)]=Trained
&STATUS`ATK_TRAINED`ATTACK`BONUS`STAT`0 [u(cobj,age)]=Minor
&STATUS`ATK_TRAINED`ATTACK`BONUS`STAT`2 [u(cobj,age)]=Minor
&STATUS`ATK_TRAINED`ATTACK`BONUS`STAT`1 [u(cobj,age)]=Minor
&STATUS`ATK_TRAINED`ATTACK`BONUS`STAT`3 [u(cobj,age)]=Minor

&STATUS`ATK_EFFICIENT [u(cobj,age)]=Efficient
&STATUS`ATK_EFFICIENT`ATTACK`HEAT_COST [u(cobj,age)]=mul(get(%0/D`COMBAT`STATUS`%1`LEVEL),-2)
&STATUS`ATK_EFFICIENT`ATTACK`PENALTY`POWER [u(cobj,age)]=mul(%q<atklevel>,0.15)

&STATUS`ATK_DRAMATIC [u(cobj,age)]=Dramatic
&STATUS`ATK_DRAMATIC`ATTACK_END_TURN [u(cobj,age)]=@select/inline t(u(setr,gaintension,u(ladd,iter(lnum(%q<atklevel>),rand(0,1)))))=1,{@attach %!/INC`TENSION=%0,%q<gaintension>,DRAMATIC ATTACK};th unsetq(gaintension)

@@ STATUS - Defenses
&STATUS`REA_TARGET [u(cobj,age)]=Target
&STATUS`REA_TARGET`TYPE [u(cobj,age)]=QUEUE
&STATUS`REA_TARGET`ATTACK`BONUS`STAT`1 [u(cobj,age)]=switch(get(%0/%q<atk>`LEVEL),1,Moderate,2,Major,3,Massive,0)
&STATUS`REA_TARGET`ATTACK`BONUS`STAT`3 [u(cobj,age)]=switch(get(%0/%q<atk>`LEVEL),1,Moderate,2,Major,3,Massive,0)
&STATUS`REA_TARGET`ATTACK_INCREASE_HITMUL [u(cobj,age)]=@select/inline cand(get(%0/%q<atk>`USEX),lt(%q<hitmul>,1.0))=1,{@select/inline lte(u(setr,tarupgrade,rand(1,100)),u(setr,tarupchance,switch(get(%0/%q<atk>`LEVEL),1,10,2,18,3,26)))=1,{th u(setq,hitmul,switch(%q<hitmul>,0.7,1.0,0.4,0.7,0.0,0.4));@attach %!/INC`EANNOUNCE=TARGET,ansi(h,name(%q<atker>)) is right on target! Attack upgraded to a [switch(%q<hitmul>,1.0,Direct Hit,0.7,Solid Hit,0.4,Close Call)]!};@attach %!/INC`DEBUG=TARGET,Hit Upgrade Roll: %q<mandowngrade>/%q<mandownchance>;th unsetq(tarup*)}
&STATUS`REA_TARGET`ATTACK`CRITICAL_ATTACK`CHANCE [u(Cobj,age)]=switch(get(%0/%q<atk>`LEVEL),2,0.25,3,0.35)
&STATUS`REA_TARGET`ATTACK`CRITICAL_ATTACK`DAMAGE [u(Cobj,age)]=switch(get(%0/%q<atk>`LEVEL),2,0.25,3,0.35)

&STATUS`REA_CHARGE [u(cobj,age)]=Charge
&STATUS`REA_CHARGE`TYPE [u(cobj,age)]=QUEUE
&STATUS`REA_CHARGE`ATTACK`BONUS`STAT`0 [u(cobj,age)]=switch(get(%0/%q<atk>`LEVEL),1,Moderate,2,Major,3,Massive,0)
&STATUS`REA_CHARGE`ATTACK`BONUS`STAT`2 [u(cobj,age)]=switch(get(%0/%q<atk>`LEVEL),1,Moderate,2,Major,3,Massive,0)
&STATUS`REA_CHARGE`ATTACK`BONUS`POWER [u(Cobj,age)]=add(switch(get(%0/%q<atk>`LEVEL),2,0.5,3,0.15),if(get(%0/%q<atk>`USEX),switch(get(%0/%q<atk>`LEVEL),1,0.35,2,0.7,3,1.05)))

&STATUS`REA_GUARD [u(cobj,age)]=Guard
&STATUS`REA_GUARD`DEFENSE`BONUS`STAT`4 [u(cobj,age)]=switch(%q<rlevel>,1,Moderate,2,Major,3,Massive,0)
&STATUS`REA_GUARD`DEFENSE`BONUS`STAT`6 [u(cobj,age)]=switch(%q<rlevel>,1,Moderate,2,Major,3,Massive,0)
&STATUS`REA_GUARD`DEFENSE`BONUS`POWER [u(Cobj,age)]=add(switch(%q<rlevel>,2,0.5,3,0.15),if(%q<usex>,switch(%q<rlevel>,1,0.35,2,0.7,3,1.05)))

&STATUS`REA_MANEUVER [u(Cobj,age)]=Maneuver
&STATUS`REA_MANEUVER`DEFENSE`BONUS`STAT`5 [u(cobj,age)]=switch(%q<rlevel>,1,Moderate,2,Major,3,Massive,0)
&STATUS`REA_MANEUVER`DEFENSE`BONUS`STAT`7 [u(cobj,age)]=switch(%q<rlevel>,1,Moderate,2,Major,3,Massive,0)
&STATUS`REA_MANEUVER`DEFENSE_DECREASE_HITMUL [u(cobj,age)]=@select/inline cand(t(%q<usex>),gt(%q<hitmul>,0.0))=1,{@select/inline lte(u(setr,mandowngrade,rand(1,100)),u(setr,mandownchance,switch(%q<rlevel>,1,10,2,18,3,26)))=1,{th u(setq,hitmul,switch(%q<hitmul>,1.0,0.7,0.7,0.4,0.4,0.0));@attach %!/INC`EANNOUNCE=MANEUVER,ansi(h,%n) uses some slippery moves! Attack downgraded to a [switch(%q<hitmul>,0.7,Solid Hit,0.4,Close Call,0.0,Miss)]!};@attach %!/INC`DEBUG=MANEUVER,Hit Degradation Roll: %q<mandowngrade>/%q<mandownchance>;th unsetq(mandown*)}
&STATUS`REA_MANEUVER`DEFENSE`CRITICAL_DEFENSE`CHANCE [u(Cobj,age)]=switch(get(%0/%q<atk>`LEVEL),2,0.20,3,0.30)
&STATUS`REA_MANEUVER`DEFENSE`CRITICAL_DEFENSE`DAMAGE [u(Cobj,age)]=switch(get(%0/%q<atk>`LEVEL),2,0.20,3,0.30)

&STATUS`REA_COUNTER [u(cobj,age)]=Counter
&STATUS`REA_COUNTER`TYPE [u(cobj,age)]=QUEUE
&STATUS`REA_COUNTER`ATTACK`BONUS`STAT`0 [u(cobj,age)]=switch(get(%0/%q<atk>`LEVEL),1,Moderate,2,Significant,3,Major)
&STATUS`REA_COUNTER`ATTACK`BONUS`STAT`1 [u(cobj,age)]=switch(get(%0/%q<atk>`LEVEL),1,Moderate,2,Significant,3,Major)
&STATUS`REA_COUNTER`ATTACK`BONUS`STAT`2 [u(cobj,age)]=switch(get(%0/%q<atk>`LEVEL),1,Moderate,2,Significant,3,Major)
&STATUS`REA_COUNTER`ATTACK`BONUS`STAT`3 [u(cobj,age)]=switch(get(%0/%q<atk>`LEVEL),1,Moderate,2,Significant,3,Major)
&STATUS`REA_COUNTER`DEFENSE`PENALTY`STAT`4 [u(cobj,age)]=switch(%q<rlevel>,1,Minor,2,Moderate,3,Solid)
&STATUS`REA_COUNTER`DEFENSE`PENALTY`STAT`5 [u(cobj,age)]=switch(%q<rlevel>,1,Minor,2,Moderate,3,Solid)
&STATUS`REA_COUNTER`DEFENSE`PENALTY`STAT`6 [u(cobj,age)]=switch(%q<rlevel>,1,Minor,2,Moderate,3,Solid)
&STATUS`REA_COUNTER`DEFENSE`PENALTY`STAT`7 [u(cobj,age)]=switch(%q<rlevel>,1,Minor,2,Moderate,3,Solid)
&STATUS`REA_COUNTER`DEFENSE`CRITICAL_DEFENSE`CHANCE [u(Cobj,age)]=if(%q<usex>,switch(get(%0/%q<atk>`LEVEL),1,0.1,2,0.18,3,0.24))
&STATUS`REA_COUNTER`DEFENSE`CRITICAL_DEFENSE`DAMAGE [u(Cobj,age)]=if(%q<usex>,switch(get(%0/%q<atk>`LEVEL),1,0.1,2,0.18,3,0.24))

&STATUS`REA_VENT [u(cobj,age)]=Vent
&STATUS`REA_COUNTER`DEFENSE`PENALTY`STAT`4 [u(cobj,age)]=switch(%q<rlevel>,1,Significant,2,Moderate,3,Minor)
&STATUS`REA_COUNTER`DEFENSE`PENALTY`STAT`5 [u(cobj,age)]=switch(%q<rlevel>,1,Significant,2,Moderate,3,Minor)
&STATUS`REA_COUNTER`DEFENSE`PENALTY`STAT`6 [u(cobj,age)]=switch(%q<rlevel>,1,Significant,2,Moderate,3,Minor)
&STATUS`REA_COUNTER`DEFENSE`PENALTY`STAT`7 [u(cobj,age)]=switch(%q<rlevel>,1,Significant,2,Moderate,3,Minor)
&STATUS`REA_COUNTER`DEFENSE_END_TURN [u(cobj,age)]=@attach %!/INC`AUX=%#,add(%q<rlevel>,if(%q<usex>,add(switch(%q<rlevel>,1,0,2,1,3,1),lte(rand(1,100),switch(%q<rlevel>,1,60,2,20,3,80))))),COUNTER

@@ STATUS - Types

&STATUS`TYP_BROAD [u(cobj,age)]=Broad
&STATUS`TYP_BROAD`TAGS [u(cobj,age)]=PACKAGE
&STATUS`TYP_BROAD`STATIC`STAT_GRADE`1 [u(cobj,age)]=2
&STATUS`TYP_BROAD`STATIC`STAT_GRADE`3 [u(cobj,age)]=2

&STATUS`TYP_SCRAPPER [u(cobj,age)]=Scrapper
&STATUS`TYP_SCRAPPER`TAGS [u(cobj,age)]=PACKAGE
&STATUS`TYP_SCRAPPER`STATIC`STAT_GRADE`1 [u(cobj,age)]=3
&STATUS`TYP_SCRAPPER`STATIC`STAT_GRADE`0 [u(cobj,age)]=1

&STATUS`TYP_MARKSMAN [u(cobj,age)]=Marksman
&STATUS`TYP_MARKSMAN`TAGS [u(cobj,age)]=PACKAGE
&STATUS`TYP_MARKSMAN`STATIC`STAT_GRADE`3 [u(cobj,age)]=3
&STATUS`TYP_MARKSMAN`STATIC`STAT_GRADE`2 [u(cobj,age)]=1

&STATUS`TYP_KNIGHT [u(cobj,age)]=Knight
&STATUS`TYP_KNIGHT`TAGS [u(cobj,age)]=PACKAGE
&STATUS`TYP_KNIGHT`STATIC`STAT_GRADE`1 [u(cobj,age)]=2
&STATUS`TYP_KNIGHT`STATIC`STAT_GRADE`4 [u(cobj,age)]=1
&STATUS`TYP_KNIGHT`STATIC`STAT_GRADE`6 [u(cobj,age)]=1

&STATUS`TYP_BASTION [u(cobj,age)]=Bastion
&STATUS`TYP_BASTION`TAGS [u(cobj,age)]=PACKAGE
&STATUS`TYP_BASTION`STATIC`STAT_GRADE`3 [u(cobj,age)]=2
&STATUS`TYP_BASTION`STATIC`STAT_GRADE`4 [u(cobj,age)]=1
&STATUS`TYP_BASTION`STATIC`STAT_GRADE`6 [u(cobj,age)]=1

&STATUS`TYP_STRIKER [u(cobj,age)]=Striker
&STATUS`TYP_STRIKER`TAGS [u(cobj,age)]=PACKAGE
&STATUS`TYP_STRIKER`STATIC`STAT_GRADE`1 [u(cobj,age)]=2
&STATUS`TYP_STRIKER`STATIC`STAT_GRADE`5 [u(cobj,age)]=1
&STATUS`TYP_STRIKER`STATIC`STAT_GRADE`7 [u(cobj,age)]=1

&STATUS`TYP_SKIRMISHER [u(cobj,age)]=Skirmisher
&STATUS`TYP_SKIRMISHER`TAGS [u(cobj,age)]=PACKAGE
&STATUS`TYP_SKIRMISHER`STATIC`STAT_GRADE`3 [u(cobj,age)]=2
&STATUS`TYP_SKIRMISHER`STATIC`STAT_GRADE`5 [u(cobj,age)]=1
&STATUS`TYP_SKIRMISHER`STATIC`STAT_GRADE`7 [u(cobj,age)]=1

&STATUS`TYP_QUIRKY [u(cobj,age)]=Quirky
&STATUS`TYP_QUIRKY`TAGS [u(Cobj,age)]=PACKAGE


@@ Packages - Offenses

&STATUS`OFF_ARSENAL [u(cobj,agedb)]=Arsenal
&STATUS`OFF_ARSENAL`TAGS [u(cobj,age)]=PACKAGE
&STATUS`OFF_ARSENAL`STATIC`STAT_GRADE`0 [u(cobj,age)]=2
&STATUS`OFF_ARSENAL`STATIC`STAT_GRADE`2 [u(cobj,age)]=2

&STATUS`OFF_ASSAULTER [u(cobj,agedb)]=Arsenal
&STATUS`OFF_ASSAULTER`TAGS [u(cobj,age)]=PACKAGE
&STATUS`OFF_ASSAULTER`STATIC`STAT_GRADE`0 [u(cobj,age)]=3
&STATUS`OFF_ASSAULTER`STATIC`STAT_GRADE`1 [u(cobj,age)]=1

&STATUS`OFF_BARRAGER [u(cobj,agedb)]=Barrager
&STATUS`OFF_ASSAULTER`TAGS [u(cobj,age)]=PACKAGE
&STATUS`OFF_ASSAULTER`STATIC`STAT_GRADE`2 [u(cobj,age)]=3
&STATUS`OFF_ASSAULTER`STATIC`STAT_GRADE`3 [u(cobj,age)]=1

&STATUS`OFF_BRAWLER [u(cobj,age)]=Brawler
&STATUS`OFF_BRAWLER`TAGS [u(cobj,age)]=PACKAGE
&STATUS`OFF_BRAWLER`STATIC`STAT_GRADE`0 [u(cobj,age)]=2
&STATUS`OFF_BRAWLER`STATIC`STAT_GRADE`4 [u(cobj,age)]=1
&STATUS`OFF_BRAWLER`STATIC`STAT_GRADE`5 [u(cobj,age)]=1

&STATUS`OFF_GUNFIGHTER [u(cobj,age)]=Gunfighter
&STATUS`OFF_GUNFIGHTER`TAGS [u(cobj,age)]=PACKAGE
&STATUS`OFF_GUNFIGHTER`STATIC`STAT_GRADE`2 [u(cobj,age)]=2
&STATUS`OFF_GUNFIGHTER`STATIC`STAT_GRADE`4 [u(cobj,age)]=1
&STATUS`OFF_GUNFIGHTER`STATIC`STAT_GRADE`5 [u(cobj,age)]=1

&STATUS`OFF_SPECIALIST [u(cobj,age)]=Specialist
&STATUS`OFF_SPECIALIST`TAGS [u(cobj,age)]=PACKAGE
&STATUS`OFF_SPECIALIST`STATIC`STAT_GRADE`0 [u(cobj,age)]=2
&STATUS`OFF_SPECIALIST`STATIC`STAT_GRADE`5 [u(cobj,age)]=1
&STATUS`OFF_SPECIALIST`STATIC`STAT_GRADE`7 [u(cobj,age)]=1

&STATUS`OFF_OPERATOR [u(cobj,age)]=Operator
&STATUS`OFF_OPERATOR`TAGS [u(cobj,age)]=PACKAGE
&STATUS`OFF_OPERATOR`STATIC`STAT_GRADE`2 [u(cobj,age)]=2
&STATUS`OFF_OPERATOR`STATIC`STAT_GRADE`5 [u(cobj,age)]=1
&STATUS`OFF_OPERATOR`STATIC`STAT_GRADE`7 [u(cobj,age)]=1

&STATUS`OFF_TAILORED [u(cobj,age)]=Tailored
&STATUS`OFF_TAILORED`TAGS [u(Cobj,age)]=PACKAGE

@@ Packages - Defenses
&STATUS`DEF_BALANCED [u(cobj,age)]=Balanced
&STATUS`DEF_BALANCED`TAGS [u(cobj,age)]=PACKAGE
&STATUS`DEF_BALANCED`STATIC`STAT_GRADE`4 [u(cobj,age)]=2
&STATUS`DEF_BALANCED`STATIC`STAT_GRADE`5 [u(cobj,age)]=2
&STATUS`DEF_BALANCED`STATIC`STAT_GRADE`6 [u(cobj,age)]=2
&STATUS`DEF_BALANCED`STATIC`STAT_GRADE`7 [u(cobj,age)]=2

&STATUS`DEF_SOLID [u(cobj,age)]=Solid
&STATUS`DEF_SOLID`TAGS [u(cobj,age)]=PACKAGE
&STATUS`DEF_SOLID`STATIC`STAT_GRADE`4 [u(cobj,age)]=3
&STATUS`DEF_SOLID`STATIC`STAT_GRADE`5 [u(cobj,age)]=1
&STATUS`DEF_SOLID`STATIC`STAT_GRADE`6 [u(cobj,age)]=3
&STATUS`DEF_SOLID`STATIC`STAT_GRADE`7 [u(cobj,age)]=1

&STATUS`DEF_AGILE [u(cobj,age)]=Agile
&STATUS`DEF_AGILE`TAGS [u(cobj,age)]=PACKAGE
&STATUS`DEF_AGILE`STATIC`STAT_GRADE`4 [u(cobj,age)]=1
&STATUS`DEF_AGILE`STATIC`STAT_GRADE`5 [u(cobj,age)]=3
&STATUS`DEF_AGILE`STATIC`STAT_GRADE`6 [u(cobj,age)]=1
&STATUS`DEF_AGILE`STATIC`STAT_GRADE`7 [u(cobj,age)]=3

&STATUS`DEF_ADEPT [u(cobj,age)]=Adept
&STATUS`DEF_ADEPT`TAGS [u(cobj,age)]=PACKAGE
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`4 [u(cobj,age)]=3
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`5 [u(cobj,age)]=3
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`6 [u(cobj,age)]=1
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`7 [u(cobj,age)]=1

&STATUS`DEF_ADROIT [u(cobj,age)]=Adroit
&STATUS`DEF_ADROIT`TAGS [u(cobj,age)]=PACKAGE
&STATUS`DEF_ADROIT`STATIC`STAT_GRADE`4 [u(cobj,age)]=1
&STATUS`DEF_ADROIT`STATIC`STAT_GRADE`5 [u(cobj,age)]=1
&STATUS`DEF_ADROIT`STATIC`STAT_GRADE`6 [u(cobj,age)]=3
&STATUS`DEF_ADROIT`STATIC`STAT_GRADE`7 [u(cobj,age)]=3

&STATUS`DEF_RAMPART [u(cobj,age)]=Rampart
&STATUS`DEF_RAMPART`TAGS [u(cobj,age)]=PACKAGE
&STATUS`DEF_RAMPART`STATIC`STAT_GRADE`4 [u(cobj,age)]=4
&STATUS`DEF_RAMPART`STATIC`STAT_GRADE`6 [u(cobj,age)]=4

&STATUS`DEF_UNTOUCHABLE [u(cobj,age)]=Untouchable
&STATUS`DEF_UNTOUCHABLE`TAGS [u(cobj,age)]=PACKAGE
&STATUS`DEF_UNTOUCHABLE`STATIC`STAT_GRADE`5 [u(cobj,age)]=4
&STATUS`DEF_UNTOUCHABLE`STATIC`STAT_GRADE`7 [u(cobj,age)]=4

&STATUS`DEF_BOXER [u(cobj,age)]=Boxer
&STATUS`DEF_BOXER`TAGS [u(cobj,age)]=PACKAGE
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`4 [u(cobj,age)]=2
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`5 [u(cobj,age)]=2
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`6 [u(cobj,age)]=1
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`7 [u(cobj,age)]=1
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`0 [u(cobj,age)]=1
&STATUS`DEF_ADEPT`STATIC`STAT_GRADE`1 [u(cobj,age)]=1

&STATUS`DEF_SHOOTER [u(cobj,age)]=Shooter
&STATUS`DEF_SHOOTER`TAGS [u(cobj,age)]=PACKAGE
&STATUS`DEF_SHOOTER`STATIC`STAT_GRADE`4 [u(cobj,age)]=1
&STATUS`DEF_SHOOTER`STATIC`STAT_GRADE`5 [u(cobj,age)]=1
&STATUS`DEF_SHOOTER`STATIC`STAT_GRADE`6 [u(cobj,age)]=2
&STATUS`DEF_SHOOTER`STATIC`STAT_GRADE`7 [u(cobj,age)]=2
&STATUS`DEF_SHOOTER`STATIC`STAT_GRADE`2 [u(cobj,age)]=1
&STATUS`DEF_SHOOTER`STATIC`STAT_GRADE`3 [u(cobj,age)]=1

&STATUS`DEF_PERSONALIZED [u(cobj,age)]=Personalized
&STATUS`DEF_PERSONALIZED`TAGS [u(Cobj,age)]=PACKAGE


@@ Status - Perks
&STATUS`PRK_STRENGTH_D [u(cobj,age)]=Power Stance
&STATUS`PRK_STRENGTH_D`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_STRENGTH_D`STATUS`REA_CHARGE`DEFENSE`HEAT_COST [u(Cobj,age)]=-5
&STATUS`PRK_STRENGTH_D`ATTACK`CRITICAL_ATTACK`DAMAGE [u(Cobj,age)]=0.05

&STATUS`PRK_STRENGTH_C [u(cobj,age)]=Heavy Hits
&STATUS`PRK_STRENGTH_C`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_STRENGTH_C`ATTACK`CRITICAL_ATTACK`DAMAGE [u(Cobj,age)]=0.1
&STATUS`PRK_STRENGTH_C`ATTACK`BONUS`STAT`0 [u(Cobj,age)]=Minor
&STATUS`PRK_STRENGTH_C`ATTACK`BONUS`STAT`2 [u(Cobj,age)]=Minor

&STATUS`PRK_STRENGTH_B [u(cobj,age)]=Follow Through
&STATUS`PRK_STRENGTH_B`TAGS [u(Cobj,age)]=PERK DISPLAY
&STATUS`PRK_STRENGTH_B`ATTACK_ON_CLOSE_MELEE [u(Cobj,age)]=th u(addto,%q<atker>,D`COMBAT`STATUS`%1`CHARGES,1);@attach %!/INC`EANNOUNCE=FOLLOW THROUGH,[ansi(h,%n)] gains a charge of Follow-Through! (Total: [default(%q<atker>/D`COMBAT`STATUS`%1`CHARGES)])
&STATUS`PRK_STRENGTH_B`ATTACK_ON_MISS [u(cobj,age)]=@attach %!/STATUS`PRK_STRENGTH_B`ATTACK_ON_CLOSE_MELEE
&STATUS`PRK_STRENGTH_B`ATTACK_BEFORE_LAUCH [u(Cobj,age)]=@select/inline t(get(%0/D`COMBAT`STATUS`%1`CHARGES))=1,{@attach %!/INC`SETSTATUS=%0,%0,PRK_STRENGTH_B_ACTIVE,,1,0;th u(addto,%0,D`COMBAT`STATUS`%1`CHARGES,-1);@attach %!/INC`EANNOUNCE=Follow Through,[ansi(h,%n)] consumes a charge of Follow-Through for a power boost! (Remaining: [default(%0/D`COMBAT`STATUS`%1`CHARGES)])}

&STATUS`PRK_STRENGTH_B_ACTIVE [u(cobj,age)]=Follow Through
*STATUS`PRK_STRENGTH_B_ACTIVE`TAGS [u(Cobj,age)]=Display
&STATUS`PRK_STRENGTH_B_ACTIVE`ATTACK`BONUS`POWER [u(cobj,age)]=add(0.3,mul(0.1,sub(get(%0/%q<atk>`STATS`1),1)))

&STATUS`PRK_STRENGTH_A [u(cobj,age)]=Crushing Blow
&STATUS`PRK_STRENGTH_A`TAGS [u(Cobj,age)]=PERK DISPLAY
&STATUS`PRK_STRENGTH_A`ATTACK_ON_CALCULATE [u(cobj,age)]=@select/inline cand(match(MELEE SPECIAL,%q<atkmode>),gte(%q<atklevel>,6))=1,{@attach %!/INC`SETSTATUS=%#,%q<atker>,PRK_STRENGTH_A_ACTIVE,,0,1}

&STATUS`PRK_STRENGTH_A_ACTIVE [u(cobj,age)]=Crushing Blow
&STATUS`PRK_STRENGTH_A_ACTIVE`DEFENSE`PENALTY`STAT`4 [u(cobj,age)]=u(setr,crushing,localize(if(gt(u(setr,gnum,get(%#/D`COMBAT`STATS`4`GRADENUM)),1),sub(u(statmap,%q<gnum>),u(statmap,sub(%q<gnum>,1)))))
&STATUS`PRK_STRENGTH_A_ACTIVE`ATTACK_ON_STRIKE [u(cobj,age)]=@select/inline t(%q<crushing>)=1,{@attach %!/INC`EANNOUNCE=Crushing Blow,[ansi(h,name(%q<atker>))] deals a mighty strike! [ansi(h,%n)]'s Resilience cannot hold up!}

&STATUS`PRK_STRENGTH_S [u(cobj,age)]=Fatal Strike
&STATUS`PRK_STRENGTH_S`TAGS [u(Cobj,age)]=PERK DISPLAY
@@ Unfinished...


&STATUS`PRK_SKILL_D [u(cobj,age)]=Swift Stance
&STATUS`PRK_SKILL_D`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_SKILL_D`STATUS`REA_TARGET`DEFENSE`HEAT_COST [u(Cobj,age)]=-5
&STATUS`PRK_SKILL_D`ATTACK`CRITICAL_ATTACK`CHANCE [u(Cobj,age)]=5

&STATUS`PRK_SKILL_C [u(Cobj,age)]=Lethal Hits
&STATUS`PRK_SKILL_C`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_SKILL_C`ATTACK`CRITICAL_ATTACK`CHANCE [u(Cobj,age)]=10
&STATUS`PRK_SKILL_C`ATTACK`BONUS`STAT`1 [u(Cobj,age)]=Minor
&STATUS`PRK_SKILL_C`ATTACK`BONUS`STAT`3 [u(Cobj,age)]=Minor

&STATUS`PRK_SKILL_B [u(cobj,age)]=Mind's Eye
&STATUS`PRK_SKILL_B`TAGS [u(Cobj,age)]=PERK DISPLAY
&STATUS`PRK_SKILL_B`ATTACK_ON_STRIKE_MELEE [u(Cobj,age)]=th u(addto,%q<atker>,D`COMBAT`ACTIVE`STATUS`PRK_SKILL_B`CHARGES,1);@attach %!/INC`EANNOUNCE=Mind's Eye,[ansi(h,name(%q<atker>))] gains a charge of Mind's Eye! (Total: [default(%q<atker>/D`COMBAT`ACTIVE`STATUS`PRK_SKILL_B`CHARGES,0)])
&STATUS`PRK_SKILL_B`ATTACK_BEFORE_LAUNCH [u(Cobj,age)]=@select/inline t(get(%0/D`COMBAT`ACTIVE`STATUS`PRK_SKILL_B`CHARGES))=1,{@attach %!/INC`SETSTATUS=%0,%0,PRK_SKILL_B_ACTIVE,CHARGES=[get(%0/D`COMBAT`ACTIVE`STATUS`PRK_SKILL_B`CHARGES)],1,0;@@ th u(addto,%0,D`COMBAT`ACTIVE`STATUS`PRK_SKILL_B`CHARGES,-1)}

&STATUS`PRK_SKILL_B_ACTIVE [u(cobj,age)]=Mind's Eye
&STATUS`PRK_SKILL_B_ACTIVE`ATTACK`CRITICAL_ATTACK`CHANCE [u(cobj,age)]=mul(5,get(%#/%q<atk>`ACTIVE`STATUS`%1`CHARGES))
&STATUS`PRK_SKILL_B_ACTIVE`ATTACK`BONUS`POWER [u(cobj,age)]=mul(0.1,get(%#/%q<atk>`ACTIVE`STATUS`%1`CHARGES))

&STATUS`PRK_SKILL_A [u(cobj,age)]=Targeted Strike
&STATUS`PRK_SKILL_A`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_SKILL_A`ATTACK_ON_SOLID_MELEE [u(cobj,age)]=@attach %!/INC`SETSTATUS=%0,%q<atker>,PRK_SKILL_A_ACTIVE,,0,2;@attach %!/INC`EANNOUNCE=Targeted Strike,[ansi(h,%n)]'s blows hit with exacting precision! Penalty to all Defense Stats!
&STATUS`PRK_SKILL_A`ATTACK_ON_DIRECT_MELEE [u(cobj,age)]=@attach %!/STATUS`PRK_SKILL_A`ATTACK_ON_SOLID_MELEE

&STATUS`PRK_SKILL_A_ACTIVE [u(cobj,age)]=Targeted Strike
&STATUS`PRK_SKILL_A_ACTIVE`TAGS [u(cobj,age)]=DISPLAY
&STATUS`PRK_SKILL_A_ACTIVE`DEFENSE`PENALTY`STAT`4 [u(cobj,age)]=if(%q<crit>,Solid,Moderate)
&STATUS`PRK_SKILL_A_ACTIVE`DEFENSE`PENALTY`STAT`5 [u(cobj,age)]=if(%q<crit>,Solid,Moderate)
&STATUS`PRK_SKILL_A_ACTIVE`DEFENSE`PENALTY`STAT`6 [u(cobj,age)]=if(%q<crit>,Solid,Moderate)
&STATUS`PRK_SKILL_A_ACTIVE`DEFENSE`PENALTY`STAT`7 [u(cobj,age)]=if(%q<crit>,Solid,Moderate)

&STATUS`PRK_SKILL_S [u(cobj,age)]=Flow State
&STATUS`PRK_SKILL_S`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_SKILL_S`ATTACK`CRITICAL_ATTACK`CHANCE [u(Cobj,age)]=if(gte(get(%#/%q<atk>``ACTIVE`STATUS`PRK_SKILL_B`CHARGES),3),10)
&STATUS`PRK_SKILL_S`ATTACK`BONUS`STAT`5 [u(cobj,age)]=if(gte(get(%#/%q<atk>`ACTIVE`STATUS`PRK_SKILL_B`CHARGES),3),Moderate)
&STATUS`PRK_SKILL_S`ATTACK`BONUS`STAT`7 [u(cobj,age)]=if(gte(get(%#/%q<atk>`ACTIVE`STATUS`PRK_SKILL_B`CHARGES),3),Moderate)
&STATUS`PRK_SKILL_S`ATTACK_ON_CALCULATE [u(cobj,age)]=@select/inline eq(3,default(%q<atker>/D`COMBAT`ACTIVE`STATUS`PRK_SKILL_B`CHARGES,0))=1,{@attach %!/INC`EANNOUNCE=Flow State,[ansi(h,name(%q<atker>))] gains an instinctive edge to [poss(%q<atker>)] attacks! Watch out!}

@@ Firepower Perks
&STATUS`PRK_FIREPOWER_D [u(cobj,age)]=Siege Stance
&STATUS`PRK_FIREPOWER_D`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_FIREPOWER_D`STATUS`REA_CHARGE`DEFENSE`HEAT_COST [u(Cobj,age)]=-5
&STATUS`PRK_FIREPOWER_D`ATTACK`CRITICAL_ATTACK`DAMAGE [u(Cobj,age)]=0.05

&STATUS`PRK_FIREPOWER_C [u(cobj,age)]=High Calibre
&STATUS`PRK_FIREPOWER_C`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_FIREPOWER_C`DAMAGE_SCATTER`POSITIVE_INCREASE [u(Cobj,age)]=1.33
&STATUS`PRK_FIREPOWER_C`DAMAGE_SCATTER`NEGATIVE_DECREASE [u(Cobj,age)]=0.66

&SCATTER [u(cobj,age)]=if(cor(rand(0,1),%1),fdiv(mul(%0,1.[rjust(rand(0,u(CUST,CORE,SCATTER_POSITIVE)),2,0)],if(%2,%2,1),if(%3,%3,1)),100),fdiv(mul(%0,-1,1.[rjust(rand(0,u(CUST,CORE,SCATTER_NEGATIVE)),2,0)],if(%4,%4,1),if(%5,%5,1)),100))
@@ %0 - Input value. %1 - bool to block negatives. %2 - Scatter Positive Increase mul. %3 - Scatter Positive Decrease Mul. %4 - Scatter Negative Increase Mul. %5 - Scatter negative decrease mul.

&STATUS`PRK_FIREPOWER_B [u(cobj,age)]=Full Barrage
&STATUS`PRK_FIREPOWER_B`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_FIREPOWER_B`ATTACK`CRITICAL_ATTACK`DAMAGE [u(Cobj,age)]=0.05
&STATUS`PRK_FIREPOWER_B`ATTACK`BONUS`POWER [u(cobj,age)]=if(gte(%q<hitmul>,0.7),mul(0.1,sub(get(%0/%q<atk>`STATS`2),1)))
&STATUS`PRK_FIREPOWER_B`ATTACK_INCREASE_HITMUL [u(cobj,age)]=@select/inline cand(match(RANGED SPECIAL,%q<atkmode>),lte(u(setr,barrand,rand(1,100)),30),eq(%q<hitmul>,0.4))=1,{th u(setq,hitmul,0.7);@attach %!/INC`EANNOUNCE=FULL BARRAGE,[ansi(hw,name(%q<atker>))] fills the skies with danger\, leaving little room to dodge! Strike upgraded from a Close Call to a Solid Hit!;@attach %!/INC`DEBUG=FULL BARRAGE,Attack Increase Hitmul Rand: %q<barrand>/30};th unsetq(barrand)

&STATUS`PRK_FIREPOWER_A [u(cobj,age)]=Specialty Ammo
&STATUS`PRK_FIREPOWER_A`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_FIREPOWER_A`ATTACK`BONUS`POWER [u(cobj,age)]=if(cand(%q<atkpowerbonus>,match(SPECIAL RANGED,%q<atkmode>)),0.35)

&STATUS`PRK_FIREPOWER_S [u(cobj,age)]=Alpha Strike
&STATUS`PRK_FIREPOWER_S`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_FIREPOWER_S`ATTACK_POST_DAMAGE [u(cobj,age)]=@select/inline cand(match(RANGED SPECIAL,%q<atkmode>),gte(%q<atkpower>,8))=1,{@select/inline u(setr,alphaheat,div(%q<damage>,100))=>0,{@attach %!/INC`HEAT=%0,%q<alphaheat>,Alpha Strike}}

@@ Aim Perks
&STATUS`PRK_AIM_D [u(cobj,age)]=Shooting Stance
&STATUS`PRK_AIM_D`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AIM_D`STATUS`REA_TARGET`DEFENSE`HEAT_COST [u(Cobj,age)]=-5
&STATUS`PRK_AIM_D`ATTACK`CRITICAL_ATTACK`CHANCE [u(Cobj,age)]=5

&STATUS`PRK_AIM_C [u(cobj,age)]=Leading
&STATUS`PRK_AIM_C`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AIM_C`DAMAGE_SCATTER`POSITIVE_INCREASE [u(Cobj,age)]=1.33
&STATUS`PRK_AIM_C`DAMAGE_SCATTER`NEGATIVE_DECREASE [u(Cobj,age)]=0.66

&STATUS`PRK_AIM_B [u(cobj,age)]=Lock-On
&STATUS`PRK_AIM_B`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AIM_B`ATTACK`CRITICAL_ATTACK`CHANCE [u(Cobj,age)]=5
&STATUS`PRK_AIM_B`ATTACK_ON_SOLID_RANGED [u(cobj,age)]=th u(addto,%q<atker>,D`COMBAT`ACTIVE`STATUS`PRK_AIM_B`CHARGES,1);@attach %!/INC`EANNOUNCE=Lock-On,[ansi(h,name(%q<atker>))] gains a charge of Lock-On! (Total: [default(%q<atker>/D`COMBAT`ACTIVE`STATUS`PRK_AIM_B`CHARGES,0)])
&STATUS`PRK_AIM_B`ATTACK_ON_DIRECT_RANGED [u(cobj,age)]=th u(addto,%q<atker>,D`COMBAT`ACTIVE`STATUS`PRK_AIM_B`CHARGES,2);@attach %!/INC`EANNOUNCE=Lock-On,[ansi(h,name(%q<atker>))] gains two charges of Lock-On! (Total: [default(%q<atker>/D`COMBAT`ACTIVE`STATUS`PRK_AIM_B`CHARGES,0)])
&STATUS`PRK_AIM_B`ATTACK_INCREASE_HITMUL [u(cobj,age)]=@select/inline cand(lte(%q<hitmul>,0.7),lte(u(setr,lockonrand,rand(1,100)),u(setr,lockonchance,mul(5,get(%0/%q<atk>`ACTIVE`STATUS`PRK_AIM_B`CHARGES)))),match(SPECIAL RANGED,%q<atkmode>))=1,{th u(setq,hitmul,switch(%q<hitmul>,0.0,0.4,0.4,0.7,0.7,1.0));@attach %!/INC`EANNOUNCE=Lock-On,[ansi(hw,name(%q<atker>))] has %n in [poss(%q<atker>)] sights! There's no escape! Hit upgraded to a [switch(%q<hitmul>,0.4,Close Call,0.7,Solid Hit,1.0,Direct Hit)]!;@attach %!/INC`DEBUG=Lock-On,Attack Increase Hitmul Chance: %q<lockonrand>/%q<lockonchance>};th unsetq(lockon*)

&STATUS`PRK_AIM_A [u(cobj,age)]=Hypervelocity
&STATUS`PRK_AIM_A`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AIM_A`ATTACK_ON_SOLID_RANGED [u(cobj,age)]=th u(setq,atkpowerbonus,add(%q<atkpowerbonus>,0.3));@attach %!/INC`EANNOUNCE=Hypervelocity,[ansi(h,name(%q<atker>))]'s blasts are quick as lightning! Attack power up!
&STATUS`PRK_AIM_A`ATTACK_ON_DIRECT_RANGED [u(cobj,age)]=th u(setq,atkpowerbonus,add(%q<atkpowerbonus>,0.45));@attach %!/INC`EANNOUNCE=Hypervelocity,[ansi(h,name(%q<atker>))]'s blasts are quick as lightning! Attack power up!

&STATUS`PRK_AIM_S [u(cobj,age)]=One Shot, One Kill
&STATUS`PRK_AIM_S`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AIM_S`ATTACK_POST_HITMUL [u(cobj,age)]=th u(setq,blockdefdechitmul,1)
&STATUS`PRK_AIM_S`DAMAGE_SCATTER`BLOCK_NEGATIVE [u(cobj,age)]=if(cand(gte(%q<atklevel>,5),match(SPECIAL RANGED,%q<atkmode>)),1,0)
@@ Unfinished...

@@ Agility Perks
&STATUS`PRK_AGILITY_D [u(cobj,age)]=Agility D
&STATUS`PRK_AGILITY_D`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AGILITY_D`STATUS`REA_MANEUVER`DEFENSE`HEAT_COST [u(Cobj,age)]=-5
&STATUS`PRK_AGILITY_D`DEFENSE`CRITICAL_DEFENSE`CHANCE [u(Cobj,age)]=10

&STATUS`PRK_AGILITY_C [u(cobj,age)]=Agility C
&STATUS`PRK_AGILITY_C`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AGILITY_C`DEFENSE`CRITICAL_DEFENSE`CHANCE [u(Cobj,age)]=10
&STATUS`PRK_AGILITY_C`DEFENSE_ON_MISS [u(cobj,age)]=@attach %!/INC`HEAT=%0,-10,Agility C
&STATUS`PRK_AGILITY_C`DEFENSE_ON_CRITICAL_DEFENSE [u(cobj,age)]=@attach %!/INC`HEAT=%0,-10,Agility C

&STATUS`PRK_AGILITY_B [u(cobj,age)]=Agility B
&STATUS`PRK_AGILITY_B`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AGILITY_B`DEFENSE`CRITICAL_DEFENSE`CHANCE [u(Cobj,age)]=5
&STATUS`PRK_AGILITY_B`DEFENSE`BONUS`STAT`5 [u(cobj,age)]=if(cand(match(MELEE SPECIAL,%q<atkmode>),lte(%q<atklevel>,4)),Solid)


&STATUS`PRK_AGILITY_A [u(cobj,age)]=Agility A
&STATUS`PRK_AGILITY_A`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AGILITY_A`DEFENSE_ON_CLOSE_MELEE [u(cobj,age)]=th u(setq,blockatkinflict,1);@attach %!/INC`EANNOUNCE=Agility-A,[ansi(h,%n)] narrowly escapes any pesky complications!
&STATUS`PRK_AGILITY_A`DEFENSE_ON_CRITICAL_DEFENSE_MELEE [u(cobj,age)]=th u(setq,blockatkinflict,1);@attach %!/INC`EANNOUNCE=Agility-A,[ansi(h,%n)] narrowly escapes any pesky complications!

&STATUS`PRK_AGILITY_S [u(cobj,age)]=Agility S
&STATUS`PRK_AGILITY_S`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_AGILITY_S`DEFENSE_DECREASE_HITMUL [u(cobj,age)]=@select/inline cand(eq(%q<hitmul>,0.4),lte(u(setr,agis,rand(1,100)),20))=1,{th u(setq,hitmul,0.0);@attach %!/INC`EANNOUNCE=Agility-S,Auto-Dodge engaged! [ansi(h,%n)] sidesteps the danger like a steel shadow!;@attach %!/INC`DEBUG=Agility-S,Defense Decrease Hitmul Rand: %q<agis>/20};th unsetq(agis)

@@ Resilience Perks
&STATUS`PRK_RESILIENCE_D [u(cobj,age)]=Resilience D
&STATUS`PRK_RESILIENCE_D`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_RESILIENCE_D`STATUS`REA_GUARD`DEFENSE`HEAT_COST [u(Cobj,age)]=-5
&STATUS`PRK_RESILIENCE_D`DEFENSE`CRITICAL_DEFENSE`DAMAGE [u(Cobj,age)]=0.1

&STATUS`PRK_RESILIENCE_C [u(cobj,age)]=Resilience C
&STATUS`PRK_RESILIENCE_C`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_RESILIENCE_C`DEFENSE`CRITICAL_DEFENSE`DAMAGE [u(Cobj,age)]=0.1
&STATUS`PRK_RESILIENCE_C`DEFENSE_AFTER_CRITICAL_DEFENSE [u(Cobj,age)]=@select/inline u(setr,crtdmgnegated,round(sub(%q<damagecritatk>,%q<damagecritdef>),0))=>199,{@attach %!/INC`AUX=%#,div(%q<crtdmgnegated>,200),Resilience C}

&STATUS`PRK_RESILIENCE_B [u(cobj,age)]=Resilience B
&STATUS`PRK_RESILIENCE_B`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_RESILIENCE_B`DEFENSE`CRITICAL_DEFENSE`DAMAGE [u(Cobj,age)]=0.05
&STATUS`PRK_RESILIENCE_B`DEFENSE`PENALTY`POWER [u(cobj,age)]=if(cand(match(MELEE SPECIAL,%q<atkmode>),lte(%q<atklevel>,4)),0.75)

&APPEND [u(Cobj,age)]=u(setr,%0,linsert(r(%0),-,1,%2))

&STATUS`PRK_RESILIENCE_A [u(cobj,age)]=Resilience A
&STATUS`PRK_RESILIENCE_A`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_RESILIENCE_A`DEFENSE_DECREASE_DAMAGE_2_FINAL [u(cobj,age)]=@select/inline cand(match(MELEE SPECIAL,%q<atkmode>),lte(%q<damagepre>,u(hitpercent,%#,0.15,1)))=1,{th u(append,defdec2damagefin,u(setr,resila,u(scatter,30)));@attach %!/INC`DEBUG=Resilience A,Defense Decrease Damage Multiplier: %q<resila>;@attach %!/INC`EANNOUNCE=Resilience A,[ansi(h,%n)] is built out of tough stuff! Weak attacks mean nothing!;th unsetq(resila)}

&STATUS`PRK_RESILIENCE_S [u(cobj,age)]=Resilience S
&STATUS`PRK_RESILIENCE_S`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_RESILIENCE_S`DEFENSE_DECREASE_DAMAGE_FINAL [u(Cobj,age)]=@select/inline t(match(MELEE SPECIAL,%q<atkmode>))=1,{@attach %!/INC`EANNOUNCE=Resilience S,[ansi(hw,name(%q<atker>))]'s attack barely scratches [ansi(hw,%n)] at all!;th u(append,defdecdamagefin,mul(floor(%q<atkpower>),25))}

@@ Mobility Perks
&STATUS`PRK_MOBILITY_D [u(cobj,age)]=Mobility D
&STATUS`PRK_MOBILITY_D`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_MOBILITY_D`STATUS`REA_MANEUVER`DEFENSE`HEAT_COST [u(Cobj,age)]=-5
&STATUS`PRK_MOBILITY_D`STATIC`MAXIMUM`HP [u(Cobj,age)]=200

&STATUS`PRK_MOBILITY_C [u(cobj,age)]=Mobility C
&STATUS`PRK_MOBILITY_C`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_MOBILITY_C`ATTACK`BONUS`STAT`5 [u(Cobj,age)]=Minor
&STATUS`PRK_MOBILITY_C`ATTACK`BONUS`STAT`7 [u(Cobj,age)]=Minor
&STATUS`PRK_MOBILITY_C`STATIC`MAXIMUM`HP [u(Cobj,age)]=300

&STATUS`PRK_MOBILITY_B [u(cobj,age)]=Mobility B
&STATUS`PRK_MOBILITY_B`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_MOBILITY_B`ATTACK`BONUS`STAT`7 [u(Cobj,age)]=if(cand(match(RANGED SPECIAL,%q<atkmode>),gte(%q<atklevel>,4)),Solid,0)
&STATUS`PRK_MOBILITY_B`DEFENSE`CRITICAL_DEFENSE`CHANCE [u(Cobj,age)]=5

&STATUS`PRK_MOBILITY_A [u(cobj,age)]=Mobility A
&STATUS`PRK_MOBILITY_A`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_MOBILITY_A`DEFENSE_ON_MISS_RANGED [u(cobj,age)]=@attach %!/INC`AUX=%#,1,Mobility A
&STATUS`PRK_MOBILITY_A`DEFENSE_ON_CLOSE_RANGED [u(Cobj,age)]=@attach %!/STATUS`PRK_MOBILITY_A`DEFENSE_ON_MISS_RANGED
&STATUS`PRK_MOBILITY_A`DEFENSE`CRITICAL_DEFENSE`CHANCE [u(Cobj,age)]=5

&STATUS`PRK_MOBILITY_S [u(cobj,age)]=Mobility S
&STATUS`PRK_MOBILITY_S`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_MOBILITY_S`DEFENSE_ON_MISS_RANGED [u(cobj,age)]=@attach %!/INC`VENT=%#,-5,Mobility S
&STATUS`PRK_MOBILITY_A`DEFENSE_ON_CLOSE_RANGED [u(Cobj,age)]=@attach %!/STATUS`PRK_MOBILITY_S`DEFENSE_ON_MISS_RANGED


@@ Armor Perks
&STATUS`PRK_ARMOR_D [u(cobj,age)]=Armor D
&STATUS`PRK_ARMOR_D`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_ARMOR_D`STATUS`REA_GUARD`DEFENSE`HEAT_COST [u(Cobj,age)]=-5
&STATUS`PRK_ARMOR_D`STATIC`MAXIMUM`HP [u(Cobj,age)]=200

&STATUS`PRK_ARMOR_C [u(cobj,age)]=Armor C
&STATUS`PRK_ARMOR_C`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_ARMOR_C`ATTACK`BONUS`STAT`4 [u(Cobj,age)]=Minor
&STATUS`PRK_ARMOR_C`ATTACK`BONUS`STAT`6 [u(Cobj,age)]=Minor
&STATUS`PRK_ARMOR_C`STATUS`REA_GUARD`DEFENSE_COST [u(Cobj,age)]=-5
&STATUS`PRK_ARMOR_C`STATIC`MAXIMUM`HP [u(Cobj,age)]=200

&STATUS`PRK_ARMOR_B [u(cobj,age)]=Armor B
&STATUS`PRK_ARMOR_B`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_ARMOR_B`DEFENSE`PENALTY`POWER [u(cobj,age)]=if(cand(match(SPECIAL RANGED,%q<atkmode>),gte(%q<atklevel>,4)),1.0)

&STATUS`PRK_ARMOR_A [u(cobj,age)]=Armor A
&STATUS`PRK_ARMOR_A`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_ARMOR_A`DEFENSE_POST_DAMAGE [u(cobj,age)]=@select/inline cand(match(SPECIAL RANGED,%q<atkmode>),lte(fdiv(get(%#/D`COMBAT`HEALTH),%q<damagespc>),0.25))={th u(setq,blockatkinflict,1)}
&STATUS`PRK_ARMOR_A`DEFENSE`CRITICAL_DEFENSE`DAMAGE [u(Cobj,age)]=0.05

&STATUS`PRK_ARMOR_S [u(cobj,age)]=Armor S
&STATUS`PRK_ARMOR_S`TAGS [u(cobj,age)]=PERK DISPLAY
&STATUS`PRK_ARMOR_S`DEFENSE_DECREASE_HITMUL [u(cobj,age)]=@select/inline cand(gte(%q<hitmul>,0.7),match(SPECIAL RANGED,%q<atkmode>))=1,{@select/inline lte(u(setq,armorsrand,die(1,100)),20)=1,{th u(setq,hitmul,switch(%q<hitmul>,1.0,0.7,0.7,0.4));@attach %!/INC`EANNOUNCE=Armor S,[ansi(h,%n)] is tough as nails! Strike downgraded to a [switch(%q<hitmul>,0.7,Solid,Close)]!}}


@@ STATUS - Pushes



&KILLSTATUS [u(Cobj,age)]=th u(setq,blockkill,0);@dolist/inline setdiff(iter(get(%0/D`COMBAT`STATUS`%1`SOURCE),num(%i0)),num(%0))={@dolist/inline get(%i0/D`COMBAT`ACTIVE`STATUS)={@attach %!/STATUS`[before(%i0,$)]`BLOCK_OPPONENT_KILL_STATUS=%i1,%i0,%0,%1,%2}};@select/inline %q<blockkill>=0,{@dolist/inline setdiff(iter(get(%0/D`COMBAT`STATUS`%1`SOURCE),num(%i0)),num(%0))={@dolist/inline get(%i0/D`COMBAT`ACTIVE`STATUS)={@attach %!/STATUS`[before(%i0,$)]`ON_OPPONENT_KILL_STATUS=%i1,%i0,%0,%1,%2}}};@select/inline %q<blockkill>=0,{@dolist/inline setdiff(get(%0/D`COMBAT`ACTIVE`STATUS),%1)={@attach %!/STATUS`[before(%i0,$)]`ON_KILL_OTHER_STATUS=%0,%1,%2};@attach %!/STATUS`[before(%1,$)]`ON_KILL_STATUS=%0,%1,%2;@attach %!/WIPE=%0,D`COMBAT`STATUS`%1;th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`ATTACK,setdiff(get(%0/D`COMBAT`ACTIVE`STATUS`ATTACK),%1));th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`DEFENSE,setdiff(get(%0/D`COMBAT`ACTIVE`STATUS`DEFENSE),%1));th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`[before(%1,$)],setdiff(get(%0/D`COMBAT`ACTIVE`STATUS`[before(%1,$)]),%1));@dolist/inline get(u(cobj,age)/STATUS`[before(%1,$)]`TAGS)={th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`TAGS`%i0,setdiff(get(%0/D`COMBAT`ACTIVE`STATUS`TAGS`%i0),%1))};th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS,setdiff(get(%0/D`COMBAT`ACTIVE`STATUS),%1));@select/inline words(u(setr,getstack,get(%0/D`COMBAT`QUEUE`[before(%1,$)])),^)=>0,{th u(setq,stackdat,first(%q<getstack>,^));th u(attrib_set,%0,D`COMBAT`QUEUE`[before(%1,$)],ldelete(%q<getstack>,1,^));@attach %!/INC`SETSTATUS=%0,elements(%q<stackdat>,1,~),before(%1,$),elements(%q<stackdat>,2,~),elements(%q<stackdat>,3,~),elements(%q<stackdat>,4,~)};@dolist/inline/nobreak edit(lattr(%!/STATUS`[before(%1,$)]`**),STATUS`[before(%1,$)]`,)={@check strlen(get(%!/STATUS`[before(%1,$)]`%i0));@stop match(TYPE TAGS DESCRIPTION,elements(%i0,1,`));th u(attrib_set,%0,D`COMBAT`HOOKS`%i0,setdff(get(%0/D`COMBAT`HOOKS`%i0),%1))}}


@@ COMBAT CODE

&CMD`COMBAT [u(cobj,age)]=$^(?s)\+(attack|react|stats|sheet|reset|boost|queue|cancel|health|boss|scan|support|keeps|forgive|quirk|sig|signature|meister|pull|scale|restrain|sell|hardsell|takehit)(?\:/(\S+))?(?\: +(.+?))?(?\:/(.+?)?)?(?\:=(.*))?$:th u(setq,command,switch(%1,sig,SIGNATURE,%1));th u(setq,sysname,COMBAT);@attach %!/INC`GETSWITCH=%2;@attach %!/INC`CHECKPC=%#,1;@attach %!/INC`%q<sysname>`%q<command>`[u(strfirstof,%q<switch>,MAIN)]=%3,%4,%5
@set [u(cobj,age)]/CMD`COMBAT=regexp

&COMBAT`BOOST`PLAYER [u(cobj,age)]=LIST
&COMBAT`BOOST`ADMIN [u(cobj,age)]=

@@ Takehit
&INC`COMBAT`TAKEHIT`MAIN [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not combat-ready!;@check strlen(%0)=@attach %!/INC`MSG=ERROR: Consequences severity field empty.;@attach %!/INC`PARTIAL=%0,MILD|MODERATE|SEVERE|NONE,|,severity;@check gt(u(setr,newcon,switch(%q<severity>,NONE,0,MILD,1,MODERATE,2,SEVERE,3)),get(%#/D`CONSEQUENCES))=@attach %!/INC`MSG=ERROR: You can only Takehit for more intense Consequences than you already have.;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will guarantee at least %q<severity> Consequences after this fight. Did you enter the right grade? Enter this command again within ten seconds to verify.,TAKEHIT %q<severity>;@attach %!/INC`EANNOUNCE=TAKEHIT,[ansi(hw,%n)] will voluntarily take [capstr(lcstr(switch(%q<severity>,NONE,No,%q<severity>)))] Consequences this day!;@attach %!/INC`CONSEQUENCES`SET=%#,get(%#/D`COMBAT`MANTLE`LINK),%q<newcon>

@@ SCALE

&COMBAT`SCALE`PLAYER [u(Cobj,age)]=CHANGE
@@ @check get(%#/D`CSYS`MANTLE`LOCKED)=@attach %!/INC`MSG=ERROR: Can only use +boss with loaner Mantles.;

&INC`COMBAT`SCALE`MAIN [u(cobj,age)]=@attach %!/INC`COMBAT`SCALE`CHANGE

@@ @check isint(get(%#/D`CSYS`MANTLE))=@attach %!/INC`MSG=ERROR: Your Mantle is not set.;@stop get(%#/D`CSYS`MANTLE`LOCKED)=@attach %!/INC`MSG=ERROR: Can only use +scale with your own Mantles.;@attach %!/INC`VALID`POSINT=%0;@stop lt(%q<value>,2)=@attach %!/INC`MSG=ERROR: Scale requires a value 2 or greater!;@attach %!/INC`MSG=You will Scale %q<value> opponents when you next +reset!;&D`CSYS`OPPONENTS %#=%q<value>;&D`CSYS`MODE %#=SCALE;

&INC`COMBAT`SCALE`CHANGE [u(cobj,age)]=@check isint(get(%#/D`CSYS`MANTLE))=@attach %!/INC`MSG=ERROR: Your Mantle is not set.;@stop get(%#/D`CSYS`MANTLE`LOCKED)=@attach %!/INC`MSG=ERROR: Can only use +scale with your own Mantles.;@stop match(BOSS,get(%#/D`COMBAT`MODE))=@attach %!/INC`MSG=ERROR: Cannot change to Scale mode from Boss mode.;@attach %!/INC`VALID`POSINT=%0;@attach %!/INC`COMBAT`SCALE`CHANGE`DO=%#,%q<value>;@attach %!/INC`EANNOUNCE=SCALE,%n is now tanking for %q<value> opponents!

&INC`COMBAT`SCALE`CHANGE`DO [u(cobj,age)]=th u(attrib_set,%0,D`COMBAT`OPPONENTS,%1);th u(attrib_set,%0,D`COMBAT`MODE,SCALE);th u(setq,damper,u(percent,%0));th u(setq,drper,u(dpercent,%0));th u(setq,hper,u(hpercent,%0));th u(attrib_set,%0,D`COMBAT`HEALTH,round(mul(get(%0/D`COMBAT`HEALTH`ORIGINAL),get(%0/D`COMBAT`OPPONENTS)),0));th u(attrib_set,%0,D`COMBAT`DAMAGE,round(mul(get(%0/D`COMBAT`HEALTH),sub(1,%q<damper>)),0));th u(attrib_set,%0,D`COMBAT`HEAT`MAXIMUM,round(mul(get(%0/D`COMBAT`HEAT`MAXIMUM`ORIGINAL),get(%0/D`COMBAT`OPPONENTS)),0));th u(attrib_set,%0,D`COMBAT`HEAT,round(mul(get(%0/D`COMBAT`HEAT`MAXIMUM),%q<drper>),0));th u(attrib_set,%0,D`COMBAT`TENSION`MAXIMUM,round(mul(get(%0/D`COMBAT`TENSION`MAXIMUM`ORIGINAL),get(%0/D`COMBAT`OPPONENTS)),0));th u(attrib_set,%0,D`COMBAT`TENSION,round(mul(get(%0/D`COMBAT`TENSION`MAXIMUM),%q<hper>),0))

@@ Boss
&COMBAT`BOSS`PLAYER [u(cobj,age)]=CASUAL|NORMAL|SERIOUS

&INC`COMBAT`BOSS`MAIN [u(cobj,age)]=@attach %!/INC`COMBAT`BOSS`NORMAL

&INC`COMBAT`BOSS`CASUAL [u(cobj,age)]=@attach %!/INC`COMBAT`BOSS`CHANGE=%0,CASUAL
&INC`COMBAT`BOSS`NORMAL [u(cobj,age)]=@attach %!/INC`COMBAT`BOSS`CHANGE=%0,NORMAL
&INC`COMBAT`BOSS`SERIOUS [u(cobj,age)]=@attach %!/INC`COMBAT`BOSS`CHANGE=%0,SERIOUS

&INC`COMBAT`BOSS`CHANGE [u(cobj,age)]=@check isint(get(%#/D`ARMORY`MAIN`MANTLE`LINK))=@attach %!/INC`MSG=ERROR: Your Mantle is not set.;@attach %!/INC`VALID`POSINT=%0;@attach %!/INC`COMBAT`BOSS`CHANGE`DO=%#,%q<value>,%1;@attach %!/INC`EANNOUNCE=BOSS,%n is [switch(%q<value>,1,no longer in Boss mode!,now [ansi(switch(%1,casual,hg,normal,hy,serious,hr,hw),capstr(lcstr(%1)))] Boss'ing for %q<value> opponents!)]

&INC`COMBAT`BOSS`CHANGE`DO [u(cobj,age)]=th u(attrib_set,%0,D`COMBAT`OPPONENTS,%1);th u(setq,damper,u(percent,%0));th u(setq,drper,u(dpercent,%0));th u(setq,hper,u(hpercent,%0));@select/inline %1=>1,{th u(attrib_set,%0,D`COMBAT`MODE,BOSS);th u(attrib_set,%0,D`COMBAT`BOSSMODE,%2)},1,{@attach %!/WIPE=%0,D`COMBAT`*MODE};th u(attrib_set,%0,D`COMBAT`HEALTH,round(mul(get(%0/D`COMBAT`HEALTH`ORIGINAL),add(1,mul(u(conf,BOSS_EXTRA_HP),sub(%1,1)))),0));th u(attrib_set,%0,D`COMBAT`TENSION`MAXIMUM,switch(%1,1,get(%0/D`COMBAT`TENSION`MAXIMUM`ORIGINAL),mul(get(%0/D`COMBAT`TENSION`MAXIMUM`ORIGINAL),%1)));th u(attrib_set,%0,D`COMBAT`HEAT`MAXIMUM,switch(%1,1,get(%0/D`COMBAT`HEAT`MAXIMUM`ORIGINAL),mul(get(%0/D`COMBAT`HEAT`MAXIMUM`ORIGINAL),%1)));th u(attrib_set,%0,D`COMBAT`DAMAGE,round(mul(get(%0/D`COMBAT`HEALTH),sub(1,%q<damper>)),0));th u(attrib_set,%0,D`COMBAT`TENSION,round(mul(get(%0/D`COMBAT`TENSION`MAXIMUM),%q<hper>),0));th u(attrib_set,%0,D`COMBAT`HEAT,round(mul(get(%0/D`COMBAT`HEAT`MAXIMUM),%q<drper>),0))


@@ Quirk
&COMBAT`QUIRK`PLAYER [u(cobj,age)]=ADD|REMOVE|WIPE

&INC`COMBAT`QUIRK`MANTLE [u(Cobj,age)]=@check u(setr,clink_id,get(%#/D`ARMORY`MAIN`MANTLE`LINK))=@attach %!/INC`MSG=ERROR: No Mantle selected!;@stop get(%#/D`ARMORY`MAIN`MANTLE`LOCKED)=@attach %!/INC`MSG=ERROR: This Mantle is read-only.

&INC`COMBAT`QUIRK`TARGET [u(Cobj,age)]=@check strlen(%0)=@attach %!/INC`MSG=ERROR: No Quirk name entered!;@check u(setr,quirk_id,u(FIND_TRAIT,QRK,%0))=@attach %!/INC`MSG=ERROR: Could not find Quirk named '%0'.

&INC`COMBAT`QUIRK`MAIN [u(cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;@attach %!/INC`MSG=You are currently using Quirks: [iter(u(mysql,SELECT`MANTLE_LINK`QUIRK,%q<clink_id>),default(u(cobj,agedb)/QRK`%i0,<unset>),%b,\,%b)]

&INC`COMBAT`QUIRK`ADD [u(cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;th u(setq,maxquirks,add(3,get(u(cobj,age)/STATUS`[get(u(cobj,agedb)/ARC`[get(%#/D`ARMORY`MAIN`MANTLE`ARCHETYPE)]`STATUS)]`STATIC`MAXIMUM`QUIRKS)));@stop gte(u(mysql,COUNT`MANTLE_LINK`QUIRK,%q<clink_id>),%q<maxquirks>)=@attach %!/INC`MSG=ERROR: You are already at your maximum of %q<maxquirks> Quirks.;@attach %!/INC`COMBAT`QUIRK`TARGET;@stop u(mysql,EXIST`MANTLE_LINK`QUIRK,%q<clink_id>,%q<quirk_id>)=@attach %!/INC`MSG=ERROR: You already are using that Quirk.;@attach %!/INC`DOSQL=ADD`MANTLE_LINK`QUIRK,%q<clink_id>,%q<quirk_id>;@attach %!/INC`MSG=You have selected the '[default(u(cobj,agedb)/QRK`%q<quirk_id>,<unset>)]' Quirk! You must +reset for this to reflect in your +stats.

&INC`COMBAT`QUIRK`REMOVE [u(cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;@attach %!/INC`COMBAT`QUIRK`TARGET;@check u(mysql,EXIST`MANTLE_LINK`QUIRK,%q<clink_id>,%q<quirk_id>)=@attach %!/INC`MSG=ERROR: You are not using that Quirk.;@attach %!/INC`DOSQL=REMOVE`MANTLE_LINK`QUIRK,%q<clink_id>,%q<quirk_id>;@attach %!/INC`MSG=You have removed the '[default(u(cobj,agedb)/QRK`%q<quirk_id>,<unset>)]' Quirk! You must +reset for this to reflect in your +stats.

&INC`COMBAT`QUIRK`WIPE [u(Cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will remove all Quirks from your Mantle. Are you sure? Enter the command again to verify.,WIPE %q<clink_id> QUIRKS;@attach %!/INC`DOSQL=WIPE`MANTLE_LINK`QUIRK,%q<clink_id>;@attach %!/INC`MSG=All Quirks wiped! You must +reset for this to reflect in your +stats.

&Q`EXIST`MANTLE_LINK`QUIRK [u(cobj,age)]=SELECT trait_value FROM vol_clink_trait where trait_type=2 AND clink_id=? AND trait_id=?
&Q`ADD`MANTLE_LINK`QUIRK [u(cobj,age)]=INSERT INTO vol_clink_trait (clink_id,trait_id,trait_type,trait_value) VALUES (?,?,2,1)
&Q`REMOVE`MANTLE_LINK`QUIRK [u(cobj,age)]=DELETE FROM vol_clink_trait WHERE clink_id=? AND trait_type=2 AND trait_id=?
&Q`WIPE`MANTLE_LINK`QUIRK [u(cobj,age)]=DELETE FROM vol_clink_trait WHERE clink_id=? AND trait_type=2
&Q`SELECT`MANTLE_LINK`QUIRK [u(cobj,age)]=SELECT trait_id FROM vol_clink_trait WHERE clink_id=? AND trait_type=2
&Q`COUNT`MANTLE_LINK`QUIRK [u(cobj,age)]=SELECT COUNT(*) FROM vol_clink_trait WHERE clink_id=? AND trait_type=2

@@ Signature

&COMBAT`SIGNATURE`PLAYER [u(cobj,age)]=SET|WIPE

&INC`COMBAT`SIGNATURE`TARGET [u(Cobj,age)]=@check strlen(%0)=@attach %!/INC`MSG=ERROR: No Signature name entered!;@check u(setr,sig_id,u(FIND_TRAIT,SIG,%0))=@attach %!/INC`MSG=ERROR: Could not find Signature named '%0'.

&INC`COMBAT`SIGNATURE`MAIN [u(cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not combat ready!;@check words(u(setr,sigs,get(%#/D`COMBAT`ACTIVE`STATUS`TAGS`SIGMOVE)))=@attach %!/INC`MSG=ERROR: You have no Signature Ability to activate! Sucks.;@dolist/inline %q<sigs>={@attach %!/STATUS`[before(%i0,$)]`SIGNATURE=%#,%i0}

&INC`COMBAT`SIGNATURE`SET [u(cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;@attach %!/INC`COMBAT`SIGNATURE`TARGET;@stop u(mysql,EXIST`SIGLINK,%q<clink_id>,%q<sig_id>)=@attach %!/INC`MSG=[ansi(hr,ERROR:)] You have already equipped that Signature technique!;@attach %!/INC`DOSQL=WIPE`MANTLE_LINK`SIG,%q<clink_id>;@attach %!/INC`DOSQL=ADD`MANTLE_LINK`SIG,%q<clink_id>,%q<sig_id>;@attach %!/INC`MSG=You have selected the '[default(u(cobj,agedb)/SIG`%q<sig_id>,<unset>)]' Signature Ability! You must +reset for this to reflect in your +stats.

&INC`COMBAT`SIGNATURE`WIPE [u(Cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will remove all Signatures from your Mantle excluding Meister Signature. Are you sure? Enter the command again to verify.,WIPE %q<clink_id> SIGNATURE;@attach %!/INC`DOSQL=WIPE`MANTLE_LINK`SIG,%q<clink_id>;@attach %!/INC`MSG=Signature wiped! You must +reset for this to reflect in your +stats.

&Q`ADD`MANTLE_LINK`SIG [u(cobj,age)]=INSERT INTO vol_clink_trait (clink_id,trait_id,trait_type,trait_value) VALUES (?,?,4,1)
&Q`WIPE`MANTLE_LINK`SIG [u(cobj,age)]=DELETE FROM vol_clink_trait WHERE clink_id=? AND trait_type=4
&Q`EXIST`SIGLINK [u(cobj,age)]=SELECT trait_id FROM vol_clink_trait WHERE clink_id=? AND trait_id=? AND trait_type IN (4,5)

@@ Meister
&COMBAT`MEISTER`PLAYER [u(cobj,age)]=SET|CLEAR|WIPE

&INC`COMBAT`MEISTER`MAIN [u(cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not combat ready!;@check eq(124,get(%#/D`ARMORY`MAIN`MANTLE`ARCHETYPE))=@attach %!/INC`MSG=ERROR: You are not a Meister!;@check words(u(setr,sigs,get(%#/D`COMBAT`ACTIVE`STATUS`TAGS`MEISTER)))=@attach %!/INC`MSG=ERROR: You have no Meister Signature Ability to activate! Sucks.;@dolist/inline %q<sigs>={@attach %!/STATUS`[before(%i0,$)]`SIGNATURE=%#,%i0}

&INC`COMBAT`MEISTER`SET [u(cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;@check eq(124,get(%#/D`ARMORY`MAIN`MANTLE`ARCHETYPE))=@attach %!/INC`MSG=ERROR: You are not a Meister!;@attach %!/INC`COMBAT`SIGNATURE`TARGET;@stop u(mysql,EXIST`SIGLINK,%q<clink_id>,%q<sig_id>)=@attach %!/INC`MSG=[ansi(hr,ERROR:)] You have already equipped that Signature technique!;@attach %!/INC`DOSQL=WIPE`MANTLE_LINK`MEISTER,%q<clink_id>;@attach %!/INC`DOSQL=ADD`MANTLE_LINK`MEISTER,%q<clink_id>,%q<sig_id>;@attach %!/INC`MSG=You have selected the '[default(u(cobj,agedb)/SIG`%q<sig_id>,<unset>)]' Signature Ability! You must +reset for this to reflect in your +stats.

&Q`ADD`MANTLE_LINK`MEISTER [u(cobj,age)]=INSERT INTO vol_clink_trait (clink_id,trait_id,trait_type,trait_value) VALUES (?,?,5,1)
&Q`WIPE`MANTLE_LINK`MEISTER [u(cobj,age)]=DELETE FROM vol_clink_trait WHERE clink_id=? AND trait_type=5

&INC`COMBAT`MEISTER`WIPE [u(Cobj,age)]=@attach %!/INC`COMBAT`QUIRK`MANTLE;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will remove all Meister Signatures from your Mantle. Are you sure? Enter the command again to verify.,WIPE %q<clink_id> MEISTER;@attach %!/INC`DOSQL=WIPE`MANTLE_LINK`MEISTER,%q<clink_id>;@attach %!/INC`MSG=Signature wiped! You must +reset for this to reflect in your +stats.

@@ Forgive
&COMBAT`FORGIVE`ADMIN [u(cobj,age)]=ALL

&INC`COMBAT`FORGIVE`ALL [u(cobj,age)]=@attach %!/INC`CHECKPC=%0,1;@check nattr(%q<t1>/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: %q<t1name> is not combat-ready!;@check nattr(%q<t1>/D`CONSEQUENCES`**)=@attach %!/INC`MSG=ERROR: %q<t1name> suffers from no consequences.;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will clear all Consequences from %q<t1name> and force them to reset. Do not use in the middle of a fight. Are you sure? Enter the same command again to continue.,FORGIVE ALL %q<t1>;@attach %!/INC`DOSQL=FORGIVE`CONSEQUENCES,%q<t1id>;@attach %!/INC`MSG=Consequences forgiven!;@attach %!/INC`MSG`CHAN=Forgave All Consequences for %q<t1name>;@attach %!/INC`MSG=Your combat Consequences have been fully forgiven and combat status reset!,%q<t1>;@attach %!/INC`COMBAT`READYCHARACTER=%q<t1objid>,get(%q<t1>/D`ARMORY`MAIN`MANTLE`LINK)

&INC`COMBAT`FORGIVE`MAIN [u(cobj,age)]=

&Q`FORGIVE`CONSEQUENCES [u(cobj,age)]=UPDATE vol_clink SET consequences_date_timeout=SET_NULL,consequences_date_gained=SET_NULL WHERE character_id=?

@@ Support
&INC`COMBAT`SUPPORT`MAIN [u(cobj,age)]=@check hasattr(%#/D`COMBAT`SUPPORTING)=@attach %!/INC`MSG=ERROR: You are not a Synergist Archetype!;@check gt(u(percent,%#),0)=@attach %!/INC`MSG=ERROR: You are KO'd!;@check strmatch(objid(get(%#/D`COMBAT`SUPPORTING)),%:)=@attach %!/INC`MSG=ERROR: Support Effect has already been assigned!;@attach %!/INC`CHECKPC=%0,2;@check nattr(%q<t2>/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: %q<t2name> is not combat ready!;@check gt(u(percent,%q<t2>),0)=@attach %!/INC`MSG=ERROR: %q<t2name> is KO'd!;@check strmatch(loc(%q<t2>),%l)=@attach %!/INC`MSG=ERROR: %q<t2name> is not present!;@check hasflag(%q<t2>,CONNECTED)=@attach %!/INC`MSG=ERROR: %q<t2name> is not connected!;@check strlen(u(setr,supactive,get(%#/D`COMBAT`ACTIVE`STATUS`[u(setr,supname,get(%#/D`COMBAT`SUPPORT))])))=@attach %!/INC`MSG=ERROR: Code Error. Synergist is not properly configured. Contact Volund.;@attach %!/KILLSTATUS=%#,%q<supactive>;@attach %!/INC`SETSTATUS=%q<t2>,%#,%q<supname>,,X,X;&D`COMBAT`SUPPORTING %#=%q<t2objid>;@dolist/inline get(%#/D`COMBAT`ACTIVE`STATUS)={@attach %!/STATUS`[before(%i0,$)]`ON_SUPPORT=%#,%i0,%q<t2objid>};@attach %!/INC`ANNOUNCE=[ansi(hw,%n)] lends Synergist Support to [ansi(hw,%q<t2name>)]!;@attach %!/WIPE=%#,D`COMBACK

@@ Cancel

&INC`COMBAT`CANCEL`MAIN [u(cobj,age)]=@check nattr(%#/D`COMBACK`**)=@attach %!/INC`MSG=ERROR: You cannot restore a previous state now.;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will restore combat state before launching any attacks or using Pushes. Are you sure? Enter the same command again to verify.,COMBAT RESTORE;@dolist/inline get(%#/D`COMCHECK`ATTACKED)={@attach %!/WIPE=%i0,D`COMBAT`Q`%#;@pemit %i0=[ansi(90,COMBAT:)]%B[ansi(hw,%n)] withdrew their attack against you!};@attach %!/WIPE=%#,D`COMCHECK`ATTACKED;@attach %!/WIPE=%#,D`COMBAT;@attach %!/INC`MVTREE=%#,D`COMBACK,%#,D`COMBAT;@attach %!/INC`ANNOUNCE=[ansi(hw,%n)] undid canceled all combat actions!

@@ Scan
&INC`COMBAT`SCAN`MAIN [u(cobj,age)]=@pemit %#=u(header,Combatants);@pemit %#=ansi(u(color,%#,COLUMN_NAMES),align(15 15 10 10 10 12,Name,Archetype,Weight,Heat,HP,Consequences));@pemit %#=u(separator);@dolist/inline u(filter,COMBATREADY,lplayers(%l))={@pemit %#=align(15 15 10 10 10 12,u(getmoniker,%i0),u(GET`ARCHETYPE,%i0)[if(get(%i0/D`COMBAT`MANTLE`LOCKED),\(P\))],ansi(u(scalecolor,get(%i0/D`COMBAT`STATS`4)),u(fancyweight,%i0)),get(%i0/D`COMBAT`HEAT`STATUS),ansi(u(ryg,sub(100,bound(u(setr,hp,round(mul(u(percent,%i0),100),0)),0))),%q<hp>\%),u(fancycon,%i0))};@pemit %#=u(footer)

&FANCYCON [u(cobj,age)]=switch(%0,1,ansi(228,Mild),2,ansi(215,Moderate),3,ansi(202,Severe),ansi(hx,None))
&FANCYCON2 [u(cobj,age)]=switch(%0,1,ansi(228,Mild),2,ansi(215,Moderate),3,ansi(202,Severe),ansi(hx,No Consequences))

&FIL`COMBATREADY [u(cobj,age)]=cand(hasflag(%0,CONNECTED),nattr(%0/D`COMBAT`**))

@@ MANTLE SELECT


@@ CSETUP

&INC`MATRIX`CSETUP [u(cobj,age)]=@check u(tester,%#)=@attach %!/INC`MSG=ERROR: Permission denied.;@attach %!/INC`CHECKPC=%0,1;@force/inline %q<t1>={+mantle %q<t1name>;+reset;+reset};@@ @attach %!/INC`COMBAT`READYCHARACTER=%q<t1objid>,get(%q<t1>/D`ARMORY`MAIn`MANTLE`LINK);@attach %!/INC`MSG=You have setup %q<t1name> for battle!




@@ RADAR
&INC`COMBAT`RADAR`MAIN [u(cobj,age)]=@select/inline strlen(%0)=>0,{@attach %!/INC`CHECKPC=%0,1;th u(setq,radar,%q<t1>)},{th u(setq,radar,u(filter,RADAR,u(lvplayers,%l)))};@check words(%q<radar>)=@attach %!/INC`MSG=Nobody to show up on your radar. Bummer!;@pemit %#=u(header,Radar Display);@pemit %#=ansi(u(color,%#,COMBAT,COLUMN_NAMES),align(20 25 12 8 10,Pilot,Mecha,Size,Health,Heat));@pemit %#=u(separator);@dolist/inline %q<radar>={@pemit %#=align(20 25 12 8 10,u(getproperty,%i0,BANNER)[if(strmatch(u(setr,pilname,get(%i0/D`COMBAT`STATS`PILOT)),name(%i0)),,%b\(as %q<pilname>\))],get(%i0/D`COMBAT`STATS`MECHA),u(mechsize,%i0),u(RADARHP,%i0),u(heatstatus,%i0))};@pemit %#=u(footer)

&FIL`RADAR [u(cobj,age)]=t(cand(nattr(%0/D`COMBAT`**),not(get(%0/D`OBSERVER))))

&RADARHP [u(cobj,age)]=switch(before(mul(u(percent,%0),100),.),100,Perfect,>79,Excellent,>59,Good,>39,Fine,>19,Damaged,>0,Critical,Scrap)

@@ READY CHARACTER

&Q`LOAD`CLINK [u(cobj,age)]=SELECT clink_id,character_id,character_name,character_objid,clink_approved,clink_loan_from,loan_from_name,loan_from_objid,clink_type,clink_locked,consequences_date_gained_secs,consequences_date_timeout_secs,consequences_scenes,centity_id,centity_name,centity_type,centity_version,centity_owner,centity_owner_name,centity_owner_type,centity_owner_objid,centity_date_created_secs,centity_claim_lock,centity_approved FROM volv_clink WHERE clink_id=?
&FIELD`CLINK [u(Cobj,age)]=id linkowner linkownername linkownerobjid linkapproved loanfrom loanfromname loanfromobjid linktype linklocked congained contimeout conscenes centity centityname centitytype centityver centityowner centityownername centityownertype centityownerobjid centitycreated centityclaimlock centityapproved

&INC`COMBAT`READYCHARACTER [u(cobj,age)]=@attach %!/WIPE=%0,D`COMBAT;@attach %!/WIPE=%0,D`COMBACK;@dolist/inline MODE OPPONENTS={th u(attrib_set,%0,D`COMBAT`%i0,get(%0/D`CSYS`%i0));@attach %!/WIPE=%0,D`CSYS`%i0};th u(attrib_set,%0,D`COMBAT`OPPONENTS,1);@attach %!/INC`LOADSQL=CLINK,%1,,c1;th u(attrib_set,%0,D`COMBAT`PILOT`LINK,%1);th u(attrib_set,%0,D`COMBAT`PILOT`LOCKED,%q<cl.linklocked>);@attach %!/INC`LOADSQL=CLINK,%2,,c2;th u(attrib_set,%0,D`COMBAT`MECHA`LINK,%1);th u(attrib_set,%0,D`COMBAT`MECHA`LOCKED,%q<c2.linklocked>);th u(attrib_set,%0,D`COMBAT`PILOT`NAME,%q<c1.centityname>);th u(attrib_set,%0,D`COMBAT`MECHA`NAME,%q<c2.centityname>);@attach %!/INC`COMBAT`READYCHARACTER`BEGIN;@attach %!/INC`COMBAT`READYCHARACTER`FINISH

&INC`COMBAT`READYCHARACTER`BEGIN [u(cobj,age)]=@dolist/inline/nobreak PILOT~0~%q<c1.centity> MECHA~1~%q<c2.centity>={@dolist/inline/nobreak/delimit [chr(176)] [u(mysql3,READYCHARACTER`TRAITS,elements(%i0,3,~))]={@check hasattr(u(cobj,agedb)/[u(setr,entype,ENTITY`[elements(%i1,2,~)]`TRAIT`[elements(%i0,1,chr(177))])]);@check strlen(u(setr,prefix,get(u(cobj,agedb)/%q<entype>`PREFIX)));@check strlen(u(setr,found,get(u(cobj,agedb)/%q<prefix>`[elements(%i0,2,chr(177))]`STATUS)));@dolist/inline lnum(elements(%i0,3,chr(177)))={@attach %!/INC`SETSTATUS=%0,%0,%q<found>,,X,X};th u(attrib_set,%0,D`COMBAT`[elements(%i1,1,~)]`TRAITS`[elements(%i0,1,chr(177))],sortkey(#lambda/get(u(cobj,agedb)/%q<prefix>`\%0),setunion(get(%0/D`COMBAT`[elements(%i1,1,~)]`TRAITS`[elements(%i0,1,chr(177))]),elements(%i0,2,chr(177))),i))}};@dolist/inline/nobreak PILOT~0~%q<c1.centity> MECHA~1~%q<c2.centity>={@dolist/inline/nobreak/delimit [chr(176)] [u(mysql3,READYCHARACTER`STATS,elements(%i0,3,~))]={th u(attrib_set,%0,D`COMBAT`[elements(%i1,1,~)]`STATS`[elements(%i0,1,chr(177))],u(setr,statnum,add(elements(%i0,2,chr(177)),)));th u(attrib_set,%0,D`COMBAT`[elements(%i1,1,~)]`STATS`[elements(%i0,1,chr(177))]`GRADE,u(statletter,%q<statnum>))}};@dolist/inline lnum(0,7)={th u(attrib_set,%0,D`COMBAT`STATS`%i0`GRADENUM,u(setr,finalstat,add(0,get(%0/D`COMBAT`PILOT`STATS`%i0),get(%0/D`COMBAT`MECHA`STATS`%i0),u(ladd,iter(get(%0/D`COMBAT`ACTIVE`STATUS),get(u(cobj,age)/STATUS`[before(%i0,$)]`STATIC`STAT_GRADE`%i1))))));th u(attrib_set,%0,D`COMBAT`STATS`%i0`GRADE,u(statletter,%q<finalstat>));th u(attrib_set,%0,D`COMBAT`STATS`%i0,u(statmap,%q<finalstat>));@dolist/inline lnum(1,9)={@select/inline gte(%q<finalstat>,%i0)=1,{@select/inline hasattr(%!/STATUS`PRK_[u(statbyid,%i1)]_[u(statletter,%i0)])=1,{@attach %!/INC`SETSTATUS=%0,%0,PRK_[u(statbyid,%i1)]_[u(statletter,%i0)],,X,X}}}}

&STATMAP [u(cobj,age)]=switch(%0,0,30,1,40,2,50,3,60,4,70,5,80,6,95,7,110,8,125)

&STATBYID [u(cobj,age)]=switch(%0,0,STRENGTH,1,SKILL,2,FIREPOWER,3,AIM,4,RESILIENCE,5,AGILITY,6,ARMOR,7,MOBILITY)

&Q`READYCHARACTER`STATS [u(cobj,age)]=SELECT trait_id,trait_value FROM vol_ctrait WHERE centity_id=? AND trait_type=0 ORDER BY trait_id
&Q`READYCHARACTER`TRAITS [u(cobj,age)]=SELECT trait_type,trait_id,trait_value FROM vol_ctrait WHERE centity_id=? AND trait_type>0 ORDER BY trait_type,trait_id

&INC`COMBAT`READYCHARACTER`FINISH [u(cobj,age)]=@attach %!/INC`COMBAT`READYCHARACTER`FINISH`STARTING;@attach/localize %!/INC`COMBAT`READYCHARACTER`FINISH`STATIC;th u(attrib_set,%0,D`COMBAT`HEALTH`ORIGINAL,get(%0/D`COMBAT`HEALTH));@select/inline cand(not(%q<cl.linklocked>),u(setr,con,u(consequences,%q<cl.contimeout>)))=1,{th u(attrib_set,%0,D`COMBAT`HEALTH,round(mul(get(%0/D`COMBAT`HEALTH),switch(%q<con>,1,0.9,2,0.75,3,0.6)),0))};@@ @select/inline strlen(get(%0/D`COMBAT`MODE))=>0,{@attach %!/INC`COMBAT`READYCHARACTER`FINISH`[get(%0/D`COMBAT`MODE)]};&D`COMBAT`HEAT`STATUS %0=u(heatstatus,%0)

&INC`COMBAT`READYCHARACTER`FINISH`SCALE [u(cobj,age)]=th u(attrib_set,%0,D`COMBAT`HEALTH,round(mul(get(%0/D`COMBAT`HEALTH`ORIGINAL),default(%0/D`COMBAT`OPPONENTS,1)),0));th u(attrib_set,%0,D`COMBAT`HEAT`MAXIMUM,mul(get(%0/D`COMBAT`HEAT`MAXIMUM),get(%0/D`COMBAT`OPPONENTS)));th u(attrib_set,%0,D`COMBAT`HEAT,mul(get(%0/D`COMBAT`HEAT),get(%0/D`COMBAT`OPPONENTS)));th u(attrib_set,%0,D`COMBAT`TENSION`MAXIMUM,mul(get(%0/D`COMBAT`TENSION`MAXIMUM),get(%0/D`COMBAT`OPPONENTS)))

&INC`COMBAT`READYCHARACTER`FINISH`BOSS [u(cobj,age)]=th u(addto,%0,D`COMBAT`HEALTH,round(mul(get(%0/D`COMBAT`HEALTH`ORIGINAL),sub(get(%0/D`COMBAT`OPPONENTS),1),switch(%q<wt>,LIGHT,0.8,MEDIUM,0.7,HEAVY,0.6,SUPERHEAVY,0.6,BOSS,0.5)),0));th u(attrib_set,%0,D`COMBAT`TENSION`MAXIMUM,mul(get(%0/D`COMBAT`TENSION`MAXIMUM),get(%0/D`COMBAT`OPPONENTS)));th u(addto,%0,D`COMBAT`HEAT`MAXIMUM,round(mul(100,get(%#/D`COMBAT`OPPONENTS),switch(%q<wt>,LIGHT,0.8,MEDIUM,0.7,HEAVY,0.6,SUPERHEAVY,0.6,BOSS,0.5)),0))

&INC`COMBAT`READYCHARACTER`FINISH`STARTING [u(cobj,age)]=&D`COMBAT`HEALTH %0=10000;&D`COMBAT`HEAT %0=0;&D`COMBAT`HEAT`LOSE %0=40;&D`COMBAT`HEAT`MAXIMUM %0=200;&D`COMBAT`HEAT`COST %0=0;&D`COMBAT`HEAT`EXHAUSTION_MULTIPLIER %0=1;&D`COMBAT`HEAT`PENALTY_MULTIPLIER %0=1;&D`COMBAT`HEAT`BONUS_MULTIPLIER %0=1;&D`COMBAT`DAMAGE %0=0;&D`COMBAT`TENSION %0=0;&D`COMBAT`TENSION`MAXIMUM %0=10;&D`COMBAT`TENSION`GAIN %0=2;&D`COMBAT`AUX %0=0;&D`COMBAT`AUX`MAXIMUM %0=10;&D`COMBAT`AUX`GAIN %0=2;&D`COMBAT`AUX`MINIMUM %0=0;

&INC`COMBAT`READYCHARACTER`FINISH`STATIC [u(cobj,age)]=@dolist/inline edit(u(lattr,%0/D`COMBAT`STATUS`*),D`COMBAT`STATUS`,)={th u(addto,%0,D`COMBAT`HEALTH,get(u(cobj,age)/STATUS`[before(%i0,$)]`STATIC`MAXIMUM`HP));th u(addto,%0,D`COMBAT`HEAT`VENT,get(u(cobj,age)/STATUS`[before(%i0,$)]`STATIC`VENT`HEAT));th u(addto,%0,D`COMBAT`HEAT,get(u(cobj,age)/STATUS`[before(%i0,$)]`STATIC`START`HEAT));th u(addto,%0,D`COMBAT`HEAT`MAXIMUM,get(u(cobj,age)/STATUS`[before(%i0,$)]`STATIC`MAXIMUM`HEAT));th u(attrib_set,%0,D`COMBAT`HEAT`MAXIMUM`ORIGINAL,get(%0/D`COMBAT`HEAT`MAXIMUM));th u(addto,%0,D`COMBAT`TENSION`GAIN,get(u(cobj,age)/STATUS`[before(%i0,$)]`STATIC`GAIN`TENSION));th u(addto,%0,D`COMBAT`TENSION,mul(get(u(cobj,age)/STATUS`[before(%i0,$)]`STATIC`START`TENSION),default(%0/D`COMBAT`OPPONENTS,1)));th u(addto,%0,D`COMBAT`TENSION`MAXIMUM,get(u(cobj,age)/STATUS`[before(%i0,$)]`STATIC`MAXIMUM`TENSION));th u(attrib_set,%0,D`COMBAT`TENSION`MAXIMUM`ORIGINAL,get(%0/D`COMBAT`TENSION`MAXIMUM));th u(attrib_set,%0,D`COMBAT`BANNED`OFF,setunion(get(%0/D`COMBAT`BANNED`OFF),get(u(cobj,age)/STATUS`[before(%i0,$)]`BANNED`OFF)));th u(attrib_set,%0,D`COMBAT`BANNED`DEF,setunion(get(%0/D`COMBAT`BANNED`DEF),get(u(cobj,age)/STATUS`[before(%i0,$)]`BANNED`DEF)));th u(attrib_set,%0,D`COMBAT`BANNED`PUSH,setunion(get(%0/D`COMBAT`BANNED`PUSH),get(u(cobj,age)/STATUS`[before(%i0,$)]`BANNED`PUSH)));@dolist/inline EXHAUSTION PENALTY BONUS={th u(addto,%0,D`COMBAT`HEAT`%i0_MULTIPLIER,get(u(cobj,age)/STATUS`[before(%i1,$)]`HEAT`%i0_MULTIPLIER))}};th u(addto,%0,D`COMBAT`HEAT,20);th u(addto,%0,D`COMBAT`HEAT`VENT,40);

&ADDTO [u(cobj,age)]=u(attrib_set,%0,%1,add(%2,default(%0/%1,0)))


@@ - RESET
&INC`COMBAT`RESET`MAIN [u(cobj,age)]=@check isint(u(setr,pl,get(%#/D`ARMORY`MAIN`PILOT`LINK)))=@attach %!/INC`MSG=ERROR: Your Pilot is not set.;@check u(setr,linkid,u(mysql,RESET_EXIST,%q<pl>,get(%#/D`ID)))=@attach %!/INC`MSG=ERROR: Your Pilot is invalid. Re-select one.;@check isint(u(setr,pl,get(%#/D`ARMORY`MAIN`MECHA`LINK)))=@attach %!/INC`MSG=ERROR: Your Mecha is not set.;@check u(setr,linkid,u(mysql,RESET_EXIST,%q<pl>,get(%#/D`ID)))=@attach %!/INC`MSG=ERROR: Your Mecha is invalid. Re-select one.;@select/inline t(nattr(%#/D`COMBAT`**))=1,{@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will reset you to base combat readiness\, and clear any attacks. ARE YOU SURE? Enter the same command again within ten seconds to continue.,RESET CSYS};@select/inline cand(hasattr(%#/D`COMBAT`SUPPORTING),not(strmatch(get(%#/D`COMBAT`SUPPORTING),%:)))=1,{@attach %!/KILLSTATUS=get(%#/D`COMBAT`SUPPORTING),first(get(get(%#/D`COMBAT`SUPPORTING)/D`COMBAT`ACTIVE`STATUS`[get(%#/D`COMBAT`SUPPORT)]))};@attach %!/INC`ANNOUNCE=[ansi(hw,%n)] has reset!;@attach %!/INC`COMBAT`READYCHARACTER=%:,get(%#/D`ARMORY`MAIN`PILOT`LINK),get(%#/D`ARMORY`MAIN`MECHA`LINK)

&Q`RESET_EXIST [u(Cobj,age)]=SELECT clink_id FROM vol_clink WHERE clink_id=? AND character_id=? LIMIT 1

&INC`CONSEQUENCES [u(cobj,age)]=@select/inline cand(not(strmatch(u(conf,EXEMPT_DISTRICT),objid(parent(loc(%0))))),not(get(%0/D`COMBAT`MANTLE`LOCKED)))=1,{@attach %!/INC`DOSQL=SCENE`CONSEQUENCES,setunion(u(mysql,GET`CONSEQUENCES_SCENE,get(%0/D`COMBAT`MANTLE`LINK)),get(%0/D`SCENE)),get(%0/D`COMBAT`MANTLE`LINK);@select/inline default(%0/D`COMBAT`KEEPS,0)=0,{th u(setq,newcon,if(lte(u(percent,%0),0.35),1,0))},1,{th u(setq,newcon,if(lt(u(percent,%0),0.25),3,if(lt(u(percent,%0),0.5),2,1)))};th u(setq,newcon,max(%q<newcon>,default(%0/D`COMBAT`TAKEHIT,0)));@select/inline gt(%q<newcon>,u(consequences,u(mysql,GET`CONSEQUENCES_TIMEOUT,get(%0/D`COMBAT`MANTLE`LINK))))=1,{@attach %!/INC`CONSEQUENCES`SET=%0,get(%0/D`COMBAT`MANTLE`LINK),%q<newcon>}}

&Q`GET`CONSEQUENCES_SCENE [u(cobj,age)]=SELECT consequences_scenes FROM vol_clink WHERE clink_id=?
&Q`GET`CONSEQUENCES_TIMEOUT [u(Cobj,age)]=SELECT consequences_date_timeout_secs FROM volv_clink WHERE clink_id=?

&INC`CONSEQUENCES`SET [u(cobj,age)]=@attach %!/INC`EPRIVATE=CONSEQUENCES,You now suffer [switch(%2,1,Mild,2,Moderate,3,Severe)] Consequences! Maximum HP will be reduced next +reset!,%0;@attach %!/INC`DOSQL=SET`CONSEQUENCES,secs(),u(setr,timeout,add(secs(),mul(60,60,24,7,switch(%2,1,1,2,4,3,10)))),%1

&Q`SET`CONSEQUENCES [u(cobj,age)]=UPDATE vol_clink SET consequences_date_gained=FROM_UNIXTIME(?),consequences_date_timeout=FROM_UNIXTIME(?) WHERE clink_id=?

&Q`SCENE`CONSEQUENCES [u(cobj,age)]=UPDATE vol_clink SET consequences_scenes='!' WHERE clink_id=?

&CONSEQUENCES [u(cobj,age)]=switch(sub(%0,secs()),<[mul(60,60,12)],0,<=[mul(60,60,24,7,1)],1,<=[mul(60,60,24,7,4)],2,<=[mul(60,60,24,7,10)],3)
&CONSEQUENCES`REMAINING [u(cobj,age)]=bound(switch(u(consequences,%0),0,1,sub(%0,secs(),mul(60,60,12)),2,sub(%0,secs(),mul(60,60,24,7,1)),3,sub(%0,secs(),mul(60,60,24,7,4))),0)

&Q`GET`CONSEQUENCES_SCENE_NAME [u(cobj,age)]=SELECT clink_id,centity_name,consequences_scenes,centity_id FROM volv_clink WHERE character_id=? AND clink_locked=0 AND consequences_date_timeout>=UTC_TIMESTAMP()

&INC`CONSEQUENCES`REDUCE [u(cobj,age)]=@dolist/inline/nobreak/delimit [chr(176)] [u(mysql3,GET`CONSEQUENCES_SCENE_NAME,get(%0/D`ID))]={@stop match(elements(%i0,3,chr(177)),%1);@attach %!/INC`DOSQL=REDUCE`CONSEQUENCES,elements(%i0,1,chr(177));@attach %!/INC`EPRIVATE=CONSEQUENCES,Consequences for '[elements(%i0,4,chr(177))]: [elements(%i0,2,chr(177))]' was reduced by one week from Scene %1 being marked Finished!,%0}

&Q`REDUCE`CONSEQUENCES [u(cobj,age)]=UPDATE vol_clink SET consequences_date_timeout=consequences_date_timeout - INTERVAL 7 DAY WHERE clink_id=?

&SCENE`CHANGE_STATUS [u(cobj,age)]=@select/inline cand(eq(%2,3),t(%4))=1,{@dolist/inline [u(filter,ISOBJID,u(mysql,SCENE`ACTORS,%0))]={@attach %!/INC`CONSEQUENCES`REDUCE=%i0,%0,%5}}

&Q`SCENE`ACTORS [u(cobj,age)]=SELECT character_objid FROM volv_actor_agg WHERE scene_id=? AND action_count>0

&LOOP`CONSEQUENCES [u(cobj,age)]=@attach %!/INC`DOSQL=CLEAR`CONSEQUENCES;@wait 60={@trigger me/LOOP`CONSEQUENCES}

@STARTUP [u(Cobj,age)]=@trigger me/LOOP`CONSEQUENCES

&Q`CLEAR`CONSEQUENCES [u(cobj,age)]=UPDATE vol_consequences SET consequences_scenes=SET_NULL,consequences_date_timeout=SET_NULL,consequences_date_gained=SET_NULL WHERE consequences_date_timeout IS NOT NULL AND consequences_date_timeout<UTC_TIMESTAMP + INTERVAL 12 HOUR

@@ - KEEPS
&INC`COMBAT`KEEPS`MAIN [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not readied for battle.;@check get(%#/D`COMBAT`ARCHETYPE)=@attach %!/INC`MSG=ERROR: Unshaped Mantles may not use +keeps.;@stop strmatch(u(conf,EXEMPT_DISTRICT),objid(parent(%l)))=@attach %!/INC`MSG=ERROR: Keeps cannot be used in a Consequences-Free area.;@stop get(%#/D`COMBAT`KEEPS)=@attach %!/INC`MSG=ERROR: Keeps is already active! Go the distance!;@check strlen(%0)=@attach %!/INC`MSG=ERROR: Reason empty!;@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] Consequences await. Are you SURE you want to use Keeps this fight? Type +keeps again to verify!,KEEPS;th u(attrib_set,%#,D`COMBAT`PULL,0);th u(attrib_set,%#,D`COMBAT`WEIGHT,u(setr,newwt,u(WEIGHT`UPGRADE,get(%#/D`COMBAT`WEIGHT`ORIGINAL))));th u(attrib_set,%#,D`COMBAT`KEEPS,1);@attach %!/INC`SETSTATUS=%#,%#,SPC_KEEPS,,1,1;@attach %!/INC`EANNOUNCE=KEEPS,Look out! [ansi(hw,%n)] is fighting for Keeps! Weight upgraded to [ansi(hw,capstr(%q<newwt>))];@attach %!/INC`MSG`CHAN=%n is fighting for Keeps! (%0);@attach %!/INC`DOSQL=LOG`KEEPS,get(%#/D`ID),%0;@attach %!/INC`CONSEQUENCES=%#

&Q`LOG`KEEPS [u(Cobj,age)]=INSERT INTO vol_clog (character_id,clog_date_created,clog_type,clog_text) VALUES (?,UTC_TIMESTAMP(),0,?)

&KEEPBONUS [u(Cobj,age)]=3

&STATUS`SPC_KEEPS [u(Cobj,age)]=Keeps
&STATUS`SPC_KEEPS`ATTACK`BONUS`STAT`0 [u(cobj,age)]=mul(v(KEEPBONUS),default(%0/D`COMBAT`NUMBERS`TIMES_ATTACKED,0))
&STATUS`SPC_KEEPS`DEFENSE`BONUS`STAT`1 [u(cobj,age)]=mul(v(KEEPBONUS),default(%0/D`COMBAT`NUMBERS`TIMES_DEFENDED,0))
&STATUS`SPC_KEEPS`ATTACK`BONUS`STAT`2 [u(cobj,age)]=mul(v(KEEPBONUS),default(%0/D`COMBAT`NUMBERS`TIMES_ATTACKED,0))
&STATUS`SPC_KEEPS`DEFENSE`BONUS`STAT`3 [u(cobj,age)]=mul(v(KEEPBONUS),default(%0/D`COMBAT`NUMBERS`TIMES_DEFENDED,0))

&INC`COMBAT`KEEPS`CHECK [u(cobj,age)]=

@@ - STATS

@@ SELL
&INC`COMBAT`SELL`MAIN [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not readied for battle.;@select/inline default(%#/D`COMBAT`SELL,0)=0,{@attach %!/INC`EPRIVATE=SELL,The other guy is seemingly awfully scary now.,%#},1,{@attach %!/INC`EPRIVATE=SELL,Who are you kidding? They're not scary at all!,%#};&D`COMBAT`HARDSELL %#=0;&D`COMBAT`SELL %#=not(get(%#/D`COMBAT`SELL))

@@ HARDSELL
&INC`COMBAT`HARDSELL`MAIN [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not readied for battle.;@select/inline default(%#/D`COMBAT`HARDSELL,0)=0,{@attach %!/INC`EPRIVATE=HARDSELL,The other guy is seemingly INCREDIBLY scary now.,%#},1,{@attach %!/INC`EPRIVATE=HARDSELL,Who are you kidding? They're not scary at all! Not even a bit!,%#};&D`COMBAT`SELL %#=0;&D`COMBAT`HARDSELL %#=not(get(%#/D`COMBAT`HARDSELL))

@@ - PULL
&INC`COMBAT`PULL`MAIN [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not readied for battle.;@stop get(%#/D`COMBAT`KEEPS)=@attach %!/INC`MSG=ERROR: Keeps is active! There's no backing down now. Go the distance!;@stop strmatch(LIGHT,get(%#/D`COMBAT`WEIGHT`ORIGINAL))=@attach %!/INC`MSG=ERROR: Maybe if you were a little beefier...;@select/inline default(%#/D`COMBAT`PULL,0)=0,{th u(attrib_set,%#,D`COMBAT`WEIGHT,u(setr,newwt,u(WEIGHT`DOWNGRADE,get(%#/D`COMBAT`WEIGHT`ORIGINAL))));th u(attrib_set,%#,D`COMBAT`PULL,1);@attach %!/INC`EANNOUNCE=PULL,[ansi(hw,%n)] decides to take it easy for now. Weight downgraded to [ansi(hw,capstr(%q<newwt>))]!},1,{th u(attrib_set,%#,D`COMBAT`WEIGHT,get(%#/D`COMBAT`WEIGHT`ORIGINAL));@attach %!/INC`EANNOUNCE=PULL,[ansi(hw,%n)] stops holding back! Original Weight class restored.;&D`COMBAT`PULL %#=0}

@@ - RESTRAIN
&INC`COMBAT`RESTRAIN`MAIN [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not readied for battle.;@select/inline default(%#/D`COMBAT`RESTRAIN,0)=0,{@attach %!/INC`EANNOUNCE=RESTRAIN,[ansi(hw,%n)] pulls [poss(%#)] punches a little!},1,{@attach %!/INC`EANNOUNCE=RESTRAIN,No holding back anymore! [ansi(hw,%n)] is going at it full steam!};th u(attrib_set,%#,D`COMBAT`RESTRAIN,not(get(%#/D`COMBAT`RESTRAIN)))

&TESTER [u(cobj,age)]=testlock(V`GROUP`2451:<=9001|V`ADMIN:>0|FLAG^ROYALTY|FLAG^WIZARD,%0)

&SCALECOLOR [u(Cobj,age)]=switch(%0,1,45,2,113,3,220,4,198,5,196)
&SCALECOLOR`WEIGHT [u(Cobj,age)]=switch(%0,LIGHT,45,MEDIUM,113,HEAVY,220,SUPERHEAVY,198,BOSS,196)

&FANCYWEIGHT [u(cobj,age)]=ansi(u(setr,qcolor,u(scalecolor`weight,get(%0/D`COMBAT`WEIGHT))),[if(get(%0/D`COMBAT`KEEPS),+,if(get(%0/D`COMBAT`PULL),-))][capstr(lcstr(if(%1,left(get(%0/D`COMBAT`WEIGHT),1),get(%0/D`COMBAT`WEIGHT))))])

&INC`COMBAT`SHEET`MAIN [u(cobj,age)]=@attach %!/INC`COMBAT`STATS`MAIN
&INC`COMBAT`STATS`MAIN [u(cobj,age)]=@attach %!/INC`CHECKPC=u(strfirstof,if(u(tester,%#),%0),%#),1;@check nattr(%q<t1>/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: %q<t1name> is not readied for battle.;@pemit %#=u(header,%q<t1name> - Stats);@attach %!/INC`COMBAT`STATS`DISPLAY;@pemit %#=u(footer)


&INC`COMBAT`STATS`DISPLAY [u(cobj,age)]=th u(setr,bor,ansi(u(color,%#,BORDER),|));@pemit %#=align(1. 50 1. 23 1.,%q<bor>,Pilot: [get(%q<t1>/D`COMBAT`PILOT`NAME)] | Mecha: [get(%q<t1>/D`COMBAT`MECHA`NAME)][rjust(u(fancycon2,u(setr,conseq,u(consequences,u(setr,conseqtime,u(mysql,GET`CONSEQUENCES_TIMEOUT,get(%0/D`COMBAT`MANTLE`LINK))))))[if(%q<conseq>,%B\([squish(etime(u(consequences`remaining,%q<conseqtime>),6))]\))],sub(60,strlen(%q<startsec>),10))]%R[rjust(ansi(h,HP:),6)] [ansi(h,<<)][iter(lnum(1,20),if(lte(fdiv(u(setr,perc,mul(%i0,5)),100),u(percent,%q<t1>)),ansi(u(ryg,sub(100,%q<perc>)),|),%B),%b,)][ansi(h,>>)]%B[ansi(h,[sub(get(%q<t1>/D`COMBAT`HEALTH),get(%q<t1>/D`COMBAT`DAMAGE))]/[get(%q<t1>/D`COMBAT`HEALTH)]%B\([before(round(mul(u(percent,%q<t1>),100),0),.)]\%\))]%R[rjust(ansi(u(setr,dcol,if(get(%q<t1>/D`COMBAT`STATS`5`ACC),hyu,h)),Heat:),6)] [ansi(%q<dcol>,<<)][iter(lnum(1,20),if(lte(fdiv(mul(%i0,5),100),fdiv(get(%q<t1>/D`COMBAT`HEAT),get(%q<t1>/D`COMBAT`HEAT`MAXIMUM))),ansi(u(heatbar,%i0),|),%b),%b,)][ansi(%q<dcol>,>>)]%B[ansi(h,[get(%q<t1>/D`COMBAT`HEAT)]/[get(%q<t1>/D`COMBAT`HEAT`MAXIMUM)]%B\([switch(get(%q<t1>/D`COMBAT`HEAT`STATUS),Overextended,Overex.,get(%q<t1>/D`COMBAT`HEAT`STATUS))]\))]%R[rjust(ansi(h,Tension:),6)] [ansi(h,<<)][iter(lnum(1,20),if(lte(fdiv(mul(%i0,5),100),fdiv(get(%q<t1>/D`COMBAT`TENSION),get(%q<t1>/D`COMBAT`TENSION`MAXIMUM))),ansi(u(hypebar,%i0),|),%b),%b,)][ansi(h,>>)]%B[ansi(h,[get(%q<t1>/D`COMBAT`TENSION)]/[get(%q<t1>/D`COMBAT`TENSION`MAXIMUM)])]%R[rjust(ansi(h,Aux:),6)] [ansi(h,<<)][iter(lnum(1,20),if(lte(fdiv(mul(%i0,5),100),fdiv(get(%q<t1>/D`COMBAT`AUX),get(%q<t1>/D`COMBAT`AUX`MAXIMUM))),ansi(u(hypebar,%i0),|),%b),%b,)][ansi(h,>>)]%B[ansi(h,[get(%q<t1>/D`COMBAT`AUX)]/[get(%q<t1>/D`COMBAT`AUX`MAXIMUM)])],%q<bor>,[center(ansi(hg,Packages),23)]%R[iter(PILOT~Type~TYP~1|MECHA~Offense~OFF~1|MECHA~Defense~DEF~2,center(ansi(g,elements(%i0,2,~)),23)%R[iter(get(%q<t1>/D`COMBAT`[elements(%i0,1,~)]`TRAITS`[elements(%i0,4,~)]),ansi(h,default(u(cobj,agedb)/[elements(%i1,3,~)]`%i0,<unknown>)),%b,%R)],|,%R)],%q<bor>);@pemit %#=u(separator);@pemit %#=align(1. 76 1.,%q<bor>,u(SHEET`STAT,%q<t1>,Strength,0)[u(SHEET`STAT,%q<t1>,Firepower,2)]%R[u(SHEET`STAT,%q<t1>,Skill,1)][u(SHEET`STAT,%q<t1>,Aim,3)]%R[u(SHEET`STAT,%q<t1>,Resilience,4)][u(SHEET`STAT,%q<t1>,Armor,6)]%R[u(SHEET`STAT,%q<t1>,Agility,5)][u(SHEET`STAT,%q<t1>,Mobility,7)],%q<bor>);

&HEATBAR [u(cobj,age)]=switch(1,t(match(1 2 3 4,%0)),27,t(match(5 6 7 8 9 10 11,%0)),75,t(match(12 13 14 15 16,%0)),117,t(match(17 18 19 20,%0)),159)

&TENSIONBAR [u(cobj,age)]=switch(1,t(match(1 2,%0)),56,t(match(3 4,%0)),93,t(match(5 6,%0)),129,t(match(7 8,%0)),165,t(match(9 10,%0)),201,t(match(11 12,%0)),207,t(match(13 14,%0)),213,t(match(15 16,%0)),219,t(match(17 18,%0)),225,t(match(19 20,%0)),231)

&SHEET`STAT [u(cobj,age)]=localize(ansi(hw,rjust(%1,10):)%B[ljust(if(get(%0/D`COMBAT`MANTLE`LOCKED),Public,ansi(u(statcolor,u(setr,val,get(%0/D`COMBAT`STATS`%2`GRADE))),%q<val>%B[if(get(%0/D`COMBAT`STATS`%2`ACC),+)])),20)])

&STATCOLOR [u(cobj,age)]=switch(%0,1,208,2,191,3,76,4,39,5,141)

@@ - ATTACK
&INC`COMBAT`ATTACK`MAIN [u(cobj,age)]=@attach %!/INC`COMBAT`ATTACK`MAIN`TARGET;@attach %!/INC`COMBAT`ATTACK`MAIN`ATTACK;@@ @attach %!/INC`COMBAT`ATTACK`MAIN`SELF_EFFECTS;@@ @attach %!/INC`COMBAT`ATTACK`MAIN`BONUSES;@attach %!/INC`COMBAT`ATTACK`MAIN`LAUNCH;@attach %!/INC`COMBAT`ATTACK`MAIN`ENDTURN

&INC`COMBAT`ATTACK`MAIN`TARGET [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not combat ready. Make sure your Pilot and Mecha are set and use +reset.;@stop gte(get(%#/D`COMBAT`DAMAGE),get(%#/D`COMBAT`HEALTH))=@attach %!/INC`MSG=ERROR: The defeated can do no such thing!;@check strlen(%0)=@attach %!/INC`MSG=ERROR: Nobody entered to attack.;@stop strmatch(%0,*\,*)=@attach %!/INC`MSG=ERROR: Multi-targeting is currently disabled.;@check strlen(%2)=@attach %!/INC`MSG=ERROR: No attack name entered.;th u(setq,allplayers,u(setr,players,lvplayers(%l)));@dolist/inline/delimit \, %0={@check isdbref(u(setr,ply,namegrab(%q<players>,%i0)))=@attach %!/INC`MSG=ERROR: '%i0' does not match a present player.;th u(setq,players,setdiff(%q<players>,%q<ply>))};th u(setq,targets,setdiff(%q<allplayers>,%q<players>));@dolist/inline %q<targets>={@check nattr(%i0/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: [name(%i0)] is not ready for battle.;@stop hasattr(%i0/D`COMBAT`Q`%#)=@attach %!/INC`MSG=ERROR: You have already attacked [name(%i0)]!;@stop gte(get(%i0/D`COMBAT`DAMAGE),get(%i0/D`COMBAT`HEALTH))=@attach %!/INC`MSG=ERROR: [name(%i0)] is already down!}

&INC`COMBAT`ATTACK`MAIN`ATTACK [u(cobj,age)]=@attach %!/INC`VALID`POSINT=before(%2,/);@check cand(gt(u(setr,atklevel,%q<value>),0),lte(%q<atklevel>,10))=@attach %!/INC`MSG=ERROR: Attacks must be between levels 1-10.;@@ @check match(get(u(cobj,agedb)/ATTACKS),u(setr,atklevel,%q<value>),|)=@attach %!/INC`MSG=ERROR: No Attack Number for %q<value>!;@check strlen(before(after(%2,/),\,))=@attach %!/INC`MSG=ERROR: Must enter an Attack Style!;@check u(setr,sty,u(FIND_TRAIT,ATK,before(after(%2,/),\,)))=@attach %!/INC`MSG=ERROR: Not an Attack Style!;@stop t(match(get(%#/D`COMBAT`BANNED`OFF),%q<sty>))=@attach %!/INC`MSG=ERROR: You may not use that Attack Style!;@check strlen(before(after(%2,\,),:))=@attach %!/INC`MSG=ERROR: You must enter an Attack Mode!;@attach %!/INC`PARTIAL=before(after(%2,\,),:),RANGED|MELEE,|,atkmode;th u(setq,atkname,after(after(%2,\,),:));@attach %!/INC`SETSTATUS=%#,%#,u(setr,atkstatusid,get(u(cobj,agedb)/ATK`%q<sty>`STATUS)),LEVEL=%q<atklevel>,get(u(cobj,agedb)/ATK`%q<sty>`ATTACK_TURNS),get(u(cobj,agedb)/ATK`%q<sty>`DEFENSE_TURNS);@dolist/inline get(%#/D`COMBAT`HOOKS`ATK`%q<sty>`ACTIVATE)={@attach %!/STATUS`[before(%i0,$)]`ATK`%q<sty>`ACTIVATE=%#,%i0};@dolist/inline get(%#/D`COMBAT`HOOKS`ATTACK_BEFORE_LAUNCH)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_BEFORE_LAUNCH=%#,%i0}


@@ &INC`COMBAT`ATTACK`MAIN`SELF_EFFECTS [u(cobj,age)]=@dolist/inline/nobreak [get(%#/%q<atk>`EFFECTS`PRIORITY)]={@attach %!/EFFECT`%i0`PRIORITY=%#};@dolist/inline/nobreak setunion(setunion(get(%#/%q<atk>`EFFECTS`SELF`LINGER),get(%#/%q<atk>`EFFECTS`SELF`INSTANT)),filterbool(#lambda/match(v(EFFECT`\%0`CATEGORIES),self),%q<extraeff>))={@attach %!/INC`SETSTATUS=%#,%i0};th u(setq,extargeffs,filterbool(#lambda/match(v(EFFECT`\%0`CATEGORIES),target),%q<extraeff>));

@@ &INC`COMBAT`ATTACK`MAIN`BONUSES [u(cobj,age)]=th u(setq,bonuses,add(get(%#/%q<atk>`PRECALC`ATTACK),u(heatbonus,%#),u(dynamic,%#,ATTACK,ATTACK)));th u(setq,multiplier,add(get(%#/%q<atk>`PRECALC`ATTACK`MULTIPLIER),u(dynamic,%#,ATTACK,ATTACK`MULTIPLIER)));

&FIL`TAGFILTER [u(cobj,age)]=t(match(v(%1`[before(%0,~)]`%2),%3))

&INC`HEAT [u(Cobj,age)]=th u(setq,undercap,lte(u(setr,curheat,get(%0/D`COMBAT`HEAT)),u(setr,minheat,get(%0/D`COMBAT`HEAT`MINIMUM))));th u(setq,newheat,add(%1,%q<curheat>));@select/inline gt(%q<newheat>,%q<curheat>)=1,{th u(attrib_set,%0,D`COMBAT`HEAT,%q<newheat>)},0,{th u(attrib_set,%0,D`COMBAT`HEAT,switch(t(%6)%q<undercap>,1*,%q<newheat>,01,%q<curheat>,00,%q<newheat>))};@select/inline not(%7)=1,{@select/inline not(%3)=1,{@attach %!/INC`EANNOUNCE=%2,[ansi(hw,name(%0))] [if(lte(%1,0),vents,generates)] [ansi(118,abs(%1))] [ansi(118,Heat)]![if(%6,%B\(Break the limit!\))]},0,{@attach %!/INC`EANNOUNCE=%2,%3}};&D`COMBAT`HEAT`STATUS %0=u(heatstatus,%0);@select/inline cand(strlen(%4),gte(%1,0))=1,{th u(addto,%0,D`COMBAT`HEAT`TALLY,bound(sub(%1,%4),0))};@select/inline t(%5)=1,{&D`COMBAT`HEAT`STATUS`ATTACK %0=get(%0/D`COMBAT`HEAT`STATUS)};th unsetq(overcap minheat newheat)
}
@@ %0 - Target. %1 - Heat to add/subtract. %2 - EFFECT NAME, %3 - Message. %4 - Exempt up to this amount from the Heat Tally. %5 - Toggle for calculating Heat after an attack. %6 - This add bypasses Minimums. %7 - No message at all!

&INC`TENSION [u(Cobj,age)]=th u(setq,overcap,gte(u(setr,curhype,get(%0/D`COMBAT`TENSION)),u(setr,maxhype,get(%0/D`COMBAT`TENSION`MAXIMUM))));th u(setq,newhype,add(%1,%q<curhype>));@select/inline lt(%q<newhype>,%q<curhype>)=1,{th u(attrib_set,%0,D`COMBAT`TENSION,%q<newhype>)},0,{th u(attrib_set,%0,D`COMBAT`TENSION,switch(t(%6)%q<overcap>,1*,%q<newhype>,01,%q<curhype>,00,%q<newhype>))};@select/inline not(%7)=1,{@select/inline not(%3)=1,{@attach %!/INC`EANNOUNCE=%2,[ansi(hw,name(%0))] [if(lte(%1,0),loses,gains)] [ansi(118,abs(%1))] [ansi(118,Tension)]![if(%6,%B\(Break the limit!\))]},0,{@attach %!/INC`EANNOUNCE=%2,%3}};@select/inline cand(strlen(%4),gte(%1,0))=1,{th u(addto,%0,D`COMBAT`TENSION`TALLY,sub(%1,%4))}
@@ %0 - Target. %1 - Heat to add/subtract. %2 - EFFECT NAME, %3 - Message. %4 - Exempt this amount from the Tension Tally. %5 - Toggle for calculating Tension after an attack. (unused) %6 - This add bypasses Maximums. %7 - No message at all!

&INC`AUX [u(Cobj,age)]=th u(setq,overcap,gte(u(setr,curaux,get(%0/D`COMBAT`AUX)),u(setr,maxaux,get(%0/D`COMBAT`AUX`MAXIMUM))));th u(setq,newaux,add(%1,%q<curaux>));@select/inline lt(%q<newaux>,%q<curaux>)=1,{th u(attrib_set,%0,D`COMBAT`AUX,%q<newaux>)},0,{th u(attrib_set,%0,D`COMBAT`AUX,switch(t(%6)%q<overcap>,1*,%q<newaux>,01,%q<curaux>,00,%q<newaux>))};@select/inline not(%7)=1,{@select/inline not(%3)=1,{@attach %!/INC`EANNOUNCE=%2,[ansi(hw,name(%0))] [if(lte(%1,0),loses,gains)] [ansi(118,abs(%1))] [ansi(118,Aux)]![if(%6,%B\(Break the limit!\))]},0,{@attach %!/INC`EANNOUNCE=%2,%3}};@select/inline cand(strlen(%4),gte(%1,0))=1,{th u(addto,%0,D`COMBAT`AUX`TALLY,sub(%1,%4))}
@@ %0 - Target. %1 - Heat to add/subtract. %2 - EFFECT NAME, %3 - Message. %4 - Exempt this amount from the Tension Tally. %5 - Toggle for calculating Tension after an attack. (unused) %6 - This add bypasses Maximums. %7 - No message at all!

@@ th u(addto,%0,D`COMBAT`TENSION,%1);@select/inline gte(get(%0/D`COMBAT`TENSION),get(%0/D`COMBAT`TENSION`MAXIMUM))=1,{&D`COMBAT`TENSION %0=get(%0/D`COMBAT`TENSION`MAXIMUM)};@select/inline not(%3)=1,{@attach %!/INC`ANNOUNCE=[ansi(hw,name(%0))] [if(gte(%1,0),gains,loses)] [ansi(118,abs(%1))] [ansi(118,Tension)] from [ansi(hw,%2)]!}

&INC`COMBAT`ATTACK`MAIN`LAUNCH [u(cobj,age)]=th [u(setq,fullname,[if(strlen(%q<atkname>),'%q<atkname>' \([get(u(cobj,agedb)/ATK`%q<sty>)] Level %q<atklevel>\),[get(u(cobj,agedb)/ATK`%q<sty>)] [capstr(lcstr(%q<atkmode>))] Level %q<atklevel>)])];th u(setq,boss,strmatch(get(%#/D`COMBAT`BOSS),BOSS));@select/inline u(setr,dafter,add(get(%#/D`COMBAT`HEAT),mul(u(setr,hcost,add(mul(%q<atklevel>,10),u(ladd,iter(setinter(get(%#/D`COMBAT`HOOKS`ATTACK`HEAT_COST),get(%#/D`COMBAT`ACTIVE`STATUS`ATTACK)),u(getstatus,%#,%i0,ATTACK,HEAT_COST))))),1)))=>150,{@attach %!/INC`HEAT=%#,mul(%q<hcost>,1),ATTACK,,if(eq(%q<atklevel>,1),abs(u(cust,ATTACKS,1`COST))),1,,1;@attach %!/INC`ANNOUNCE=[if(gt(%q<boss>,1),ansi(hr,<BOSS-%q<boss>>)%B)][ansi(hw,%n)] tries to launch a [ansi(u(scalecolor,%q<atklevel>),Level %q<atklevel> [u(u(cobj,agedb)/ATK`%q<sty>)])]%B[if(strlen(%q<atkname>),%q<atkname>,Attack)] at [u(itemize,iter(u(sortname,%q<targets>),ansi(hw,name(%i0)),%B,\,|),|,and,\,)]! ... but overheats and explodes!;@select/inline gt(u(setr,overe,u(overexert,%#)),0)=1,{@attach %!/INC`DAMAGE=%#,floor(mul(get(%#/D`COMBAT`HEALTH),%q<overe>)),Overheating!}},{@dolist/inline/nobreak %q<targets>={@attach %!/INC`COMBAT`ATTACK`LAUNCH=%#,%i0,%q<extargeffs>,%q<fullname>};&D`COMCHECK`ATTACKED %#=%q<targets>;@attach %!/INC`ANNOUNCE=[if(gt(%q<boss>,1),ansi(hr,<BOSS-%q<boss>>)%B)][ansi(hw,%n)] launched a [ansi(u(scalecolor,%q<atklevel>),Level %q<atklevel> [u(u(cobj,agedb)/ATK`%q<sty>)])]%B[if(strlen(%q<atkname>),%q<atkname>,Attack)] at [u(itemize,iter(u(sortname,%q<targets>),ansi(hw,name(%i0)),%B,\,|),|,and,\,)]! [ansi(hg,abs(%q<hcost>))] Heat [if(strmatch(%q<hcost>,-*),vented,generated)]!;@attach %!/INC`PRIVATE=[if(gt(%q<boss>,1),ansi(hr,<BOSS-%q<boss>>)%B)][ansi(hw,%n)] attacked you! Respond with [ansi(hw,+react %n=<choice>)],%q<targets>;@attach %!/INC`HEAT=%#,mul(%q<hcost>,1),ATTACK,,add(if(eq(%q<atklevel>,1),abs(u(cust,ATTACKS,1`COST))),u(ladd,iter(setinter(get(%#/D`COMBAT`HOOKS`ATTACK`HEAT_COST`EXEMPT),get(%#/D`COMBAT`ACTIVE`STATUS`ATTACK)),u(getstatus,%#,%i0,ATTACK,HEAT_COST`EXEMPT)))),1,,1;@select/inline gt(u(setr,overe,u(overexert,%#)),0)=1,{@attach %!/INC`DAMAGE=%#,floor(mul(get(%#/D`COMBAT`HEALTH),%q<overe>)),Overheating!};@select/inline u(setr,dot,round(u(ladd,iter(setinter(get(%#/D`COMBAT`HOOKS`ATTACK`DOT),get(%#/D`COMBAT`ACTIVE`STATUS`ATTACK)),u(getstatus,%#,%i0,ATTACK,DOT))),0))=>0,{@attach %!/INC`DAMAGE=%#,%q<dot>,Damage Over Time}};

&INC`COMBAT`ATTACK`LAUNCH [u(cobj,age)]=th u(attrib_set,%1,u(setr,atkattr,D`COMBAT`Q`%0),%3);@attach %!/INC`CPTREE=%#,D`COMBAT`STATS,%1,%q<atkattr>`STATS;&%q<atkattr>`ATK %1=%q<atklevel>;&%q<atkattr>`OFF %1=%q<sty>;&%q<atkattr>`ARCHETYPE %1=get(%0/D`COMBAT`ARCHETYPE);&%q<atkattr>`ATKMODE %1=%q<atkmode>;&%q<atkattr>`TIMESTAMP %1=secs();@attach %!/INC`CPTREE=%#,D`COMBAT`STATUS,%1,%q<atkattr>`STATUS;@attach %!/INC`CPTREE=%#,D`COMBAT`HOOKS,%1,%q<atkattr>`HOOKS;@attach %!/INC`CPTREE=%#,D`COMBAT`ACTIVE,%1,%q<atkattr>`ACTIVE;@dolist/inline SELL HARDSELL PULL KEEPS RESTRAIN MODE OPPONENTS BOSSMODE={@cpattr %#/D`COMBAT`##=%1/%q<atkattr>`##};th u(attrib_set,%1,%q<atkattr>`HEATSTATUS,u(heatstatus,%#));@attach %!/INC`CPTREE=%0,D`COMBAT`HEAT,%1,%q<atkattr>`HEAT

&INC`COMBAT`ATTACK`MAIN`ENDTURN [u(cobj,age)]=th u(addto,%#,D`COMBAT`NUMBERS`TIMES_ATTACKED,1);@dolist/inline get(%#/D`COMBAT`ACTIVE`STATUS`ATTACK)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_END_TURN=%#,%i0};@attach/nobreak %!/INC`COMBAT`ATTACK`MAIN`ENDTURN`STATUS=%#;@dolist/inline get(%#/D`COMBAT`ACTIVE`STATUS)={@attach %!/STATUS`[before(%i0,$)]`OFF`%q<off>`END_TURN=%#,%i0};&D`COMBAT`TENSION`USED %#=0;&D`COMBAT`SELL %#=0;&D`COMBAT`HARDSELL %#=0;&D`COMBAT`HISTORY`HEAT_SPENT_SELFLESS %#=%q<dcost>;&D`COMBAT`HEAT`TALLY %#=0

&INC`COMBAT`ATTACK`MAIN`ENDTURN`STATUS [u(cobj,age)]=@dolist/inline/nobreak get(%0/D`COMBAT`ACTIVE`STATUS`ATTACK)={@select/inline u(setr,srem,get(%0/D`COMBAT`STATUS`%i0`ATTACK_TURNS))=X,{},>0,{th u(attrib_set,%0,D`COMBAT`STATUS`%i0`ATTACK_TURNS,sub(%q<srem>,1));@stop get(%0/D`COMBAT`STATUS`%i0`ATTACK_TURNS);th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`ATTACK,setdiff(get(%0/D`COMBAT`ACTIVE`STATUS`ATTACK),%i0));@stop cor(strmatch(get(%0/D`COMBAT`STATUS`%i0`DEFENSE_TURNS),X),gt(u(lmax,iter(ATTACK DEFENSE,get(%0/D`COMBAT`STATUS`%i1`%i0_TURNS))),0));@attach %!/KILLSTATUS=%0,%i0}};

&INC`DAMAGE [u(cobj,age)]=@select/inline not(%4)=1,{@attach %!/INC`ANNOUNCE=[if(%3,%3,[u(getmoniker,%0)] took [ansi(h,%1)] damage from %2!)]};th u(setq,predam,get(%0/D`COMBAT`DAMAGE));th u(setq,prebon,u(healthbonus,%0));th u(addto,%0,D`COMBAT`DAMAGE,%1);th u(setq,postbon,u(healthbonus,%0));th u(setq,afterper,u(percent,%0));@dolist/inline/nobreak iter(revwords(lnum(0,19)),mul(%i0,5))={@attach %!/INC`DAMAGETIER=%0,%i0};@select/inline cand(lte(%q<afterper>,0),not(%4))=1,{@attach %!/INC`ANNOUNCE=[ansi(hr,name(%0) has been Defeated! *BOOM*)]};&D`COMBAT`DAMAGE`TIMESTAMP %0=secs();@select/inline t(get(%0/D`COMBAT`MANTLE`LOCKED))=0,{@attach %!/INC`CONSEQUENCES=%0}

&INC`DAMAGETIER [u(cobj,age)]=@select/inline cand(lte(%q<afterper>,fdiv(%1,100)),not(hasattr(%0/D`COMBAT`PERCENT`%1)))=1,{&D`COMBAT`PERCENT`%1 %0=1;@dolist/inline/nobreak get(%0/D`COMBAT`ACTIVE`STATUS)={@attach %!/STATUS`[before(%i0,$)]`BELOW_%1_HEALTH=%0,%i0}};


@@ - DEFEND
&INC`COMBAT`REACT`MAIN [u(cobj,age)]=@attach %!/INC`COMBAT`DEFEND`MAIN`TARGET;@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE;@attach %!/INC`COMBAT`DEFEND`MAIN`STRIKE;@attach %!/INC`COMBAT`DEFEND`MAIN`ENDTURN;@attach %!/INC`COMBAT`DEFEND`MAIN`DEBUG;

&REG`DEFEND [u(cobj,age)]=(?P<reaname>\w+)?(?:\/(?P<level>\d+)?(?P<usex>x)?(?:\:(?P<defname>.*))?)?

&INC`COMBAT`DEFEND`MAIN`TARGET [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not combat ready. Make sure your Pilot and Mecha are set and use +reset.;@stop gte(get(%#/D`COMBAT`DAMAGE),get(%#/D`COMBAT`HEALTH))=@attach %!/INC`MSG=ERROR: The defeated can do no such thing!;@check nattr(%#/D`COMBAT`Q`*)=@attach %!/INC`MSG=ERROR: You have no attacks to deal with!;@check strlen(%0)=@attach %!/INC`MSG=ERROR: Nobody entered to defend against.;@check isdbref(u(setr,atker,namegrab(iter(lattr(%#/D`COMBAT`Q`*),last(%i0,`)),%0)))=@attach %!/INC`MSG=ERROR: No Attacker called '%0'!;th u(setq,atk,D`COMBAT`Q`%q<atker>);th regmatchi(%2,get(%!/REG`DEFEND),reaname:reaname level:rlevel usex:usex defname:defname);@check strlen(%q<reaname>)=@attach %!/INC`MSG=ERROR: No Reaction method entered.;@check u(setr,def,u(FIND_TRAIT,REA,%q<reaname>))=@attach %!/INC`MSG=ERROR: No Reaction named '%q<reaname>'!;@stop t(match(get(%#/D`COMBAT`BANNED`DEF),%q<def>))=@attach %!/INC`MSG=ERROR: You may not use that Reaction!;@check match(1 2 3,u(setr,rlevel,u(strfirstof,%q<rlevel>,1)))=@attach %!/INC`MSG=ERROR: Reaction levels must be between 1 and 3.;@select/inline gte(get(%#/D`COMBAT`TENSION),u(setr,deftencost,if(%q<usex>,u(cust,REA,%q<def>`COST`%q<rlevel>`X),0)))=0,{@stop 1=@attach %!/INC`MSG=ERROR: You don't have the Tension to X-ify your Defense!};th u(setq,sty,get(%#/%q<atk>`OFF));th u(setq,atkmode,get(%#/%q<atk>`atkmode));@attach %!/INC`SETSTATUS=%#,%#,u(setr,defstatus,get(u(cobj,agedb)/REA`%q<def>`STATUS)),LEVEL=%q<rlevel>|X=[t(%q<usex>)],get(u(cobj,agedb)/REA`%q<def>`ATTACK_TURNS),get(u(cobj,agedb)/REA`%q<def>`DEFENSE_TURNS);@dolist/inline get(%#/D`COMBAT`HOOKS`DEF`%q<def>`ACTIVATE)={@attach %!/STATUS`[before(%i0,$)]`DEF`%q<def>`ACTIVATE=%#,%i0}

&DYNAMIC [u(cobj,age)]=add(u(ladd,iter(get(%0/D`COMBAT`ACTIVE_EFFECTS`%1),udefault(%!/EFFECT`[before(%i0,~)]`%2,0,%0),|,%b)),u(ladd,iter(get(%0/D`COMBAT`ACTIVE_BOOSTS`%1),udefault(%!/BOOST`[before(%i0,~)]`%2,0,%0),|,%b)),u(ladd,iter(get(%0/D`COMBAT`ABILITIES`%1),udefault(%!/ABIL`[before(%i0,~)]`%2,0,%0,after(%i0,~)),|,%b)))

&GET`WEIGHT [u(cobj,age)]=localize(if(cand(strlen(u(setr,wt,get(%0/D`COMBAT`WEIGHT))),hasattr(u(cobj,agedb)/WEIGHTS`%q<wt>)),u(u(cobj,agedb)/WEIGHTS`%q<wt>[if(%1,`%1)])))

&GET`HEAT [u(cobj,age)]=localize(if(cand(strlen(u(setr,dr,if(%2,u(strfirstof,get(%0/D`COMBAT`HEAT`STATUS`ATTACK),get(%0/D`COMBAT`HEAT`STATUS)),get(%0/D`COMBAT`HEAT`STATUS)))),hasattr(u(cobj,agedb)/HEATS`%q<dr>)),u(u(cobj,agedb)/HEATS`%q<dr>[if(%1,`%1)])))

&CALCSTATMOD [u(cobj,age)]=add(u(adj,u(GET`HEAT,%0,%2`BONUS`STAT`%1,%4,%5)),u(ladd,iter(setinter(get(%0/D`COMBAT`HOOKS`%2`BONUS`STAT`%1),get(%0/D`COMBAT`ACTIVE`STATUS`%2)),u(getstatus,%0,%i0,%2,BONUS`STAT`%1))),mul(-1,add(u(adj,u(GET`HEAT,%0,%2`PENALTY`STAT`%1,%4,%5)),u(ladd,iter(setinter(get(%0/D`COMBAT`HOOKS`%2`PENALTY`STAT`%1),get(%0/D`COMBAT`ACTIVE`STATUS`%2)),u(getstatus,%0,%i0,%2,PENALTY`STAT`%1))))))

&CALCOFF [u(cobj,age)]=power(fdiv(u(ladd,iter(%1,u(cust,ENTITY`0`STAT`%i0,SCALE))),words(%1)),fdiv(sub(%0,fdiv(u(ladd,iter(%1,u(cust,ENTITY`0`STAT`%i0,DIAL))),words(%1))),5))

&CALCDEF [u(cobj,age)]=power(fdiv(u(ladd,iter(%1,u(cust,ENTITY`0`STAT`%i0,SCALE))),words(%1)),fdiv(sub(fdiv(u(ladd,iter(%1,u(cust,ENTITY`0`STAT`%i0,DIAL))),words(%1)),%0),5))

@@ &CALCOFF [u(cobj,age)]=add(1,fdiv(sub(fdiv(%0,u(u(cobj,agedb)/ENTITY`0`STAT`%1`DIAL)),1),1.5))

@@ &CALCDEF [u(cobj,age)]=add(1,fdiv(sub(fdiv(u(u(cobj,agedb)/ENTITY`0`STAT`%1`DIAL),%0),1),1.5))

&INC`RUNSTATUS [u(Cobj,age)]=@dolist/inline edit(u(lattr,%0/D`COMBAT`STATUS`*),D`COMBAT`STATUS`,)={@attach %!/STATUS`%i0`%1=%0,%2,%3,%4,%5,%6,%7,%8,%9}

&MEDEFSTAT [u(Cobj,age)]=if(%0,setinter(get(%#/D`COMBAT`HOOKS`%0),get(%#/D`COMBAT`ACTIVE`STATUS`DEFENSE)),get(%#/D`COMBAT`ACTIVE`STATUS`DEFENSE))

&ATKERATKSTAT [u(cobj,age)]=if(%0,setinter(get(%#/%q<atk>`HOOKS`%0),%q<atkeratkstat>),%q<atkeratkstat>)

&INC`COMBAT`DEFEND`MAIN`CALCULATE [u(cobj,age)]=th u(setq,atklevel,get(%#/%q<atk>`ATK));th u(setq,atkeratkstat,get(%#/%q<atk>`ACTIVE`STATUS`ATTACK));@dolist/inline u(ATKERATKSTAT,ATTACK_ON_CALCULATE)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_CALCULATE=%#,%i0};@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`ATKPOWER;@select/inline gt(add(%q<xconorig>,u(ladd,%q<xcon>)),0)=1,{@dolist/inline u(MEDEFSTAT,DEFENSE_ON_CALCULATE)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_CALCULATE=%#,%i0};@dolist/inline BALANCE ATKMODE DAMAGEMOD ACCURACYMOD ON_HIT_CHECK ROLL THRESHOLD PRE_REROLL REROLL HITMUL_HOOKS CRITICAL SCATTER DAMAGE={@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`%i0};@select/inline gte(%q<hitmul>,0)=1,{@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`ON_STRIKE};@dolist/inline DAMAGE_RAW ON_STRIKE_TYPE HEATNORMALIZE DAMAGE_NET NORMALIZE DAMAGE_PREFINAL DAMAGE_CRITICAL DAMAGE_FINAL={@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`%i0};@@ @stop 1=@pemit %#=STOPPING HERE!;@dolist/inline u(MEDEFSTAT,DEFENSE_INFLICT_STATUS)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_INFLICT_STATUS=%#,%i0};th u(setq,dot,round(u(ladd,iter(get(%#/D`COMBAT`ACTIVE`STATUS`DEFENSE),u(getstatus,%#,%i0,DEFENSE,DOT))),0));@select/inline strlen(u(setr,offmode,get(%#/%q<atk>`MODE)))=>0,{@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`ATTACK_MODE`%q<offmode>};@select/inline strlen(u(setr,defmode,get(%#/D`COMBAT`MODE)))=>0,{@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`DEFENSE_MODE`%q<defmode>};@dolist/inline DAMAGE_SPECIAL DAMAGE_POST={@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`%i0};@select/inline cand(cor(gt(%q<hitmul>,0),%q<atkinflictoverride>),not(%q<atkinflictblock>))=1,{@dolist/inline u(ATKERATKSTAT,ATTACK_INFLICT_STATUS)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_INFLICT_STATUS=%#,%i0}}}

&INC`COMBAT`DEFEND`MAIN`CALCULATE`ATKPOWER [u(cobj,age)]=th u(setq,xconorig,u(CUST,ATTACKS,%q<atklevel>));th u(setq,xcon,squish(iter(u(ATKERATKSTAT,ATTACK`BONUS`POWER),u(STATUS`[before(%i0,$)]`ATTACK`BONUS`POWER,%#,%i0)) [iter(u(ATKERATKSTAT,ATTACK`PENALTY`POWER),mul(u(STATUS`[before(%i0,$)]`ATTACK`PENALTY`POWER,%#,%i0),-1))] [iter(u(MEDEFSTAT,DEFENSE`BONUS`POWER),mul(u(STATUS`[before(%i0,$)]`DEFENSE`BONUS`POWER,%#,%i0),-1))] [iter(u(MEDEFSTAT,DEFENSE`PENALTY`POWER),u(STATUS`[before(%i0,$)]`DEFENSE`PENALTY`POWER,%#,%i0))]))

&INC`COMBAT`DEFEND`MAIN`CALCULATE`ON_HIT_CHECK [u(Cobj,age)]=@dolist/inline u(ATKERATKSTAT,ATTACK_ON_HITCHECK)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_HITCHECK=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_ON_HITCHECK)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_HITCHECK=%#,%i0};

&INC`COMBAT`DEFEND`MAIN`CALCULATE`PRE_REROLL [u(cobj,age)]=@dolist/inline u(MEDEFSTAT,DEFENSE_PRE_REROLL)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_PRE_REROLL=%#,%i0};@dolist/inline u(ATKERATKSTAT,ATTACK_PRE_REROLL)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_PRE_REROLL=%#,%i0};

&INC`COMBAT`DEFEND`MAIN`CALCULATE`REROLL [u(cobj,age)]=@select/inline not(%q<disablereroll>)=1,{@dolist/inline u(ATKERATKSTAT,ATTACK_REROLL)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_REROLL=%#,%i0}};

&INC`COMBAT`DEFEND`MAIN`CALCULATE`CRITICAL [u(cobj,age)]=@dolist/inline critatkchance~CRITICAL_ATTACK`CHANCE critatkpower~CRITICAL_ATTACK`POWER critdefchance~CRITICAL_DEFENSE`CHANCE critdefpower~CRITICAL_DEFENSE`POWER={th u(setq,before(%i0,~),add(r(before(%i0,~)),u(ladd,iter(u(ATKERATKSTAT,ATTACK`[after(%i0,~)]),u(STATUS`[before(%i0,$)]`ATTACK`[after(%i1,~)],%#,%i0))),u(ladd,iter(u(MEDEFSTAT,DEFENSE`[after(%i0,~)]),u(STATUS`[before(%i0,$)]`DEFENSE`[after(%i1,~)],%#,%i0)))))};th u(setq,critatk,lte(u(setr,critatkrand,rand(1,100)),%q<critatkchance>));@attach %!/INC`DEBUG=CRITICAL ATTACK, Critical Atttack Chance Roll: [u(setr,critatkdeb,%q<critatkrand>/%q<critatkchance>)];th u(setq,critdef,lte(u(setr,critdefrand,rand(1,100)),%q<critdefchance>));@attach %!/INC`DEBUG=CRITICAL DEFENSE, Critical Defense Chance Roll: [u(setr,critdefdeb,%q<critdefrand>/%q<critdefchance>)];

&INC`COMBAT`DEFEND`MAIN`CALCULATE`HITMUL_HOOKS [u(cobj,age)]=th u(setq,orighitmul,%q<hitmul>);@dolist/inline INCREASE DECREASE MODIFY FINAL={@dolist/inline u(ATKERATKSTAT,ATTACK_%i0_HITMUL)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_%i1_HITMUL=%#,%i0}};@dolist/inline u(MEDEFSTAT,DEFENSE_REROLL)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_REROLL=%#,%i0};@dolist/inline INCREASE DECREASE MODIFY FINAL={@dolist/inline u(MEDEFSTAT,DEFENSE_%i0_HITMUL)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_%i1_HITMUL=%#,%i0}};

&INC`COMBAT`DEFEND`MAIN`CALCULATE`ON_STRIKE [u(cobj,age)]=@dolist/inline u(ATKERATKSTAT,ATTACK_ON_STRIKE)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_STRIKE=%#,%i0;@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_STRIKE_%q<atkmode>=%#,%i0};@dolist/inline u(ATKERATKSTAT,ATTACK_ON_STRIKE_%q<atkmode>)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_STRIKE_%q<atkmode>=%#,%i0};@select/inline t(%q<critatk>)=1,{@dolist/inline u(ATKERATKSTAT,ATTACK_ON_CRITICAL_ATTACK)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_CRITICAL_ATTACK=%#,%i0;@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_STRIKE_%q<atkmode>=%#,%i0};@dolist/inline u(ATKERATKSTAT,ATTACK_ON_CRITICAL_ATTACK_%q<atkmode>)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_CRITICAL_ATTACK_%q<atkmode>=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_ON_CRITICAL_ATTACK)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_CRITICAL_ATTACK=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_ON_CRITICAL_ATTACK_%q<atkmode>)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_CRITICAL_ATTACK_%q<atkmode>=%#,%i0}};@dolist/inline u(MEDEFSTAT,DEFENSE_ON_STRIKE)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_STRIKE=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_ON_STRIKE_%q<atkmode>)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_STRIKE_%q<atkmode>=%#,%i0};@select/inline t(%q<critdef>)=1,{@dolist/inline u(MEDEFSTAT,DEFENSE_ON_CRITICAL_DEFENSE)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_CRITICAL_DEFENSE=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_ON_CRITICAL_DEFENSE_%q<atkmode>)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_CRITICAL_DEFENSE_%q<atkmode>=%#,%i0};@dolist/inline u(ATKERATKSTAT,ATTACK_ON_CRITICAL_DEFENSE)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_CRITICAL_DEFENSE=%#,%i0;@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_STRIKE_%q<atkmode>=%#,%i0};@dolist/inline u(ATKERATKSTAT,ATTACK_ON_CRITICAL_DEFENSE_%q<atkmode>)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_CRITICAL_DEFENSE_%q<atkmode>=%#,%i0};}

&INC`COMBAT`DEFEND`MAIN`CALCULATE`ON_STRIKE_TYPE [u(cobj,age)]=th u(setq,htype,if(gt(%q<hitmul>,0.0),if(gte(%q<hitmul>,1.0),DIRECT,if(gte(%q<hitmul>,0.7),SOLID,CLOSE)),MISS));@dolist/inline u(ATKERATKSTAT,ATTACK_ON_%q<htype>)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_%q<htype>=%#,%i0};@dolist/inline u(ATKERATKSTAT,ATTACK_ON_%q<htype>_%q<atkmode>)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_%q<htype>_%q<atkmode>=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_ON_%q<htype>)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_%q<htype>=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_ON_%q<htype>_%q<atkmode>)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_%q<htype>_%q<atkmode>=%#,%i0};

@@ %0 - new damage variable. %1 - input damage variable. %2 - Hook identifier. NET, PREFINAL, FINAL, SPECIAL, etc. %3 - Hook prefix for variables. net, pre, fin, spc, etc.
&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_MOD [u(cobj,age)]=th u(setq,%0,r(%1));@select/inline t(%q<hitmul>)=1,{@dolist/inline INCREASE_DAMAGE DECREASE_DAMAGE INCREASE_DAMAGE_2 DECREASE_DAMAGE_2={@dolist/inline u(ATKERATKSTAT,ATTACK_%i0_%2)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_%i1_%2=%#,%i0;@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGEMOD_%i1=%0,atk[switch(%i1,INCREASE*,inc,DECREASE*,dec)][switch(%i1,*_2,2)]%3damage}};@dolist/inline INCREASE_DAMAGE DECREASE_DAMAGE INCREASE_DAMAGE_2 DECREASE_DAMAGE_2={@dolist/inline u(MEDEFSTAT,DEFENSE_%i0_%2)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_%i1_%2=%#,%i0;@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGEMOD_%i1=%0,def[switch(%i1,INCREASE*,inc,DECREASE*,dec)][switch(%i1,*_2,2)]%3damage}}};

&INC`COMBAT`DEFEND`MAIN`CALCULATE`HEATNORMALIZE [u(cobj,age)]=th u(setq,damageheat,%q<damageraw>);@select/inline gt(%q<damageheat>,0)=1,{th u(setq,damageheat,fdiv(%q<damageheat>,add(1,fdiv(mul(get(%#/%q<atk>`HEAT`TALLY),2.4),100))))}

&INC`COMBAT`DEFEND`MAIN`CALCULATE`NORMALIZE [u(cobj,age)]=th u(setq,damagenorm,%q<damagenet>);@select/inline gt(%q<damagenorm>,0)=1,{th u(setq,damagenorm,add(u(setr,yfac,mul(get(%#/D`COMBAT`HEALTH`ORIGINAL),u(cust,ATTACKS,%q<atklevel>`PERCENTAGE))),fdiv(sub(%q<damage>,%q<yfac>),u(cust,CORE,NORMALIZE))))}

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_NET [u(cobj,age)]=@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_MOD=damagenet,damageheat,NET,net

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_PREFINAL [u(cobj,age)]=@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_MOD=damagepre,damagenorm,PREFINAL,pre

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_FINAL [u(cobj,age)]=@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_MOD=damagefin,damagepre,FINAL,fin

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_SPECIAL [u(cobj,age)]=@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_MOD=damagespc,damagefin,SPECIAL,spc;th u(setq,damagespc,round(%q<damagespc>,0))

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_POST [u(cobj,age)]=@select/inline gt(%q<damage>,0)=1,{@dolist/inline u(ATKERATKSTAT,ATTACK_POST_DAMAGE)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_POST_DAMAGE=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_POST_DAMAGE)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_POST_DAMAGE=%#,%i0}};

@@ %0 - Damage register to save to. %1 - register to apply.
&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGEMOD_INCREASE_DAMAGE [u(cobj,age)]=@select/inline words(%1)=>0,{th u(setq,%0,add(r(%0),u(ladd,iter(%1))))}
&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGEMOD_INCREASE_DAMAGE_2 [u(cobj,age)]=@select/inline words(%1)=>0,{th u(setq,%0,mul(r(%0),add(1,u(ladd,%1))))}
&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGEMOD_DECREASE_DAMAGE [u(cobj,age)]=@select/inline words(%1)=>0,{th u(setq,%0,sub(r(%0),u(lsub,iter(%1))))}
&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGEMOD_DECREASE_DAMAGE_2 [u(cobj,age)]=@select/inline words(%1)=>0,{th u(setq,%0,mul(r(%0),lmath(mul,iter(%1,sub(1.0,%i0)))))}

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE_CRITICAL [u(cobj,age)]=th u(setq,damagecritatk,%q<damagepre>);@select/inline t(%q<critatk>)=1,{th u(setq,damagecritatk,mul(%q<damagecritatk>,add(1,%q<critatkpower>)));@dolist/inline u(ATKERATKSTAT,ATTACK_AFTER_CRITICAL_ATTACK)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_AFTER_CRITICAL_ATTACK=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_AFTER_CRITICAL_ATTACK)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_ON_CRITICAL_ATTACK=%#,%i0}};th u(setq,damagecritdef,%q<damagecritatk>);@select/inline t(%q<critdef>)=1,{th u(setq,damagecritdef,mul(%q<damagecritdef>,sub(1.0,%q<critdefpower>)));@dolist/inline u(MEDEFSTAT,DEFENSE_AFTER_CRITICAL_DEFENSE)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_AFTER_CRITICAL_DEFENSE=%#,%i0};dolist/inline u(ATKERATKSTAT,ATTACK_AFTER_CRITICAL_DEFENSE)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_AFTER_CRITICAL_DEFENSE=%#,%i0}}

&CALCSTAT`ATK [u(cobj,age)]=add(get(%0/%1`STATS`%2),)
&CALCSTAT [u(cobj,age)]=add(get(%0/D`COMBAT`STATS`%1),)

&INC`COMBAT`DEFEND`MAIN`CALCULATE`ATKMODE [u(cobj,age)]=

&INC`COMBAT`DEFEND`MAIN`CALCULATE`BALANCE [u(cobj,age)]=@dolist/inline lnum(0,7)={th u(setq,bastat%i0,add(u(setr,astat%i0,u(CALCSTAT`ATK,%#,%q<atk>,%i0)),u(adj,u(cust,HEATS,[get(%#/%q<atk>`HEATSTATUS)]`ATTACK`BONUS`STAT`%i0),mul(u(adj,u(cust,HEATS,[get(%#/%q<atk>`HEATSTATUS)]`ATTACK`PENALTY`STAT`%i0)),-1),u(ladd,iter(u(ATKERATKSTAT,ATTACK`BONUS`STAT`%i0),u(getstatus,%#,%i0,ATTACK,BONUS`STAT`%i0,%q<atk>))),mul(u(ladd,iter(u(ATKERATKSTAT,ATTACK`PENALTY`STAT`%i0),u(getstatus,%#,%i0,ATTACK,PENALTY`STAT`%i0,%q<atk>))),-1))));th u(setq,bdstat%i0,add(u(setr,dstat%i0,u(CALCSTAT,%#,%i0)),u(adj,u(cust,HEATS,[get(%#/D`COMBAT`HEAT`STATUS)]`DEFENSE`BONUS`STAT`%i0),mul(u(adj,u(cust,HEATS,[get(%#/D`COMBAT`HEAT`STATUS)]`DEFENSE`PENALTY`STAT`%i0)),-1),u(ladd,iter(u(MEDEFSTAT,DEFENSE`BONUS`STAT`%i0),u(getstatus,%#,%i0,DEFENSE,BONUS`STAT`%i0,%q<atk>))),mul(u(ladd,iter(u(MEDEFSTAT,DEFENSE`PENALTY`STAT`%i0),u(getstatus,%#,%i0,ATTACK,PENALTY`STAT`%i0,%q<atk>))),-1))))}

@@ @dolist/inline 0-4 4-0 1-5 5-1 2-6 6-2 3-7 7-3={@select/inline u(setr,diff,sub(u(setr,astat,u(CALCSTAT`ATK,%#,%q<atk>,before(%i0,-))),u(setr,dstat,u(CALCSTAT,%#,after(%i0,-),1))))=0,{th u(setq,bdstat[after(%i0,-)],%q<dstat>);th u(setq,bastat[before(%i0,-)],add(%q<astat>,u(adj,u(cust,HEATS,[get(%#/%q<atk>`HEATSTATUS)]`ATTACK`BONUS`STAT`[before(%i0,-)]),mul(u(adj,u(cust,HEATS,[get(%#/%q<atk>`HEATSTATUS)]`ATTACK`PENALTY`STAT`[before(%i0,-)])),-1),u(ladd,iter(setinter(get(%#/%q<atk>`ACTIVE`STATUS`ATTACK),get(%#/%q<atk>`HOOKS`ATTACK`BONUS`STAT`[before(%i0,-)])),u(getstatus,%#,%i0,ATTACK,BONUS`STAT`[before(%i0,-)],%q<atk>))),mul(u(ladd,iter(setinter(get(%#/%q<atk>`ACTIVE`STATUS`ATTACK),get(%#/%q<atk>`HOOKS`ATTACK`PENALTY`STAT`[before(%i0,-)])),u(getstatus,%#,%i0,ATTACK,PENALTY`STAT`[before(%i0,-)],%q<atk>))),-1))))},>0,{th u(setq,bdiff,abs(%q<diff>));th u(setq,bdstat[after(%i0,-)],%q<dstat>);th u(setq,bastat[before(%i0,-)],add(%q<dstat>,if(u(cust,CORE,BALANCE),fdiv(%q<bdiff>,u(cust,CORE,BALANCE)),0)))},<0,{th u(setq,bdiff,abs(%q<diff>));th u(setq,bdstat[after(%i0,-)],add(%q<astat>,if(u(cust,CORE,BALANCE),fdiv(%q<bdiff>,u(cust,CORE,BALANCE)),0)));th u(setq,bastat[before(%i0,-)],%q<astat>)}};th unsetq(astat dstat)

&INC`COMBAT`DEFEND`MAIN`CALCULATE`ATTACK_MODE`BOSS [u(cobj,age)]=@select/inline t(%q<damage>)=1,{th u(setq,damage,u(setr,atkbosspostdam,mul(u(setr,atkbosspredam,%q<damage>),mul(u(setr,atkbossdmgmul,u(cust,BOSS,[u(setr,atkopp,bound(get(%#/%q<atk>`OPPONENTS),2,10))]`DMG_MUL)),u(setr,atkbosssqrt,sqrt(u(cust,BOSS,%q<atkopp>`[get(%#/%q<atk>`BOSSMODE)])))))))}

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DEFENSE_MODE`BOSS [u(cobj,age)]=@select/inline t(%q<damage>)=1,{th u(setq,damage,u(setr,defbosspostdam,mul(u(setr,defbosspredam,%q<damage>),fdiv(u(setr,defbossdefmul,u(cust,BOSS,[u(setr,defopp,bound(get(%#/D`COMBAT`OPPONENTS),2,10))]`REA_MUL)),u(setr,defbosssqrt,sqrt(u(cust,BOSS,%q<defopp>`[get(%#/D`COMBAT`BOSSMODE)])))))))}

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGEMOD [u(cobj,age)]=th u(setq,damagemod,mul(u(calcoff,add(switch(%q<atkmode>,MELEE,%q<bastat0>,RANGED,%q<bastat2>,SPECIAL,fdiv(add(%q<bastat0>,%q<bastat2>),2)),),switch(%q<atkmode>,MELEE,0,RANGED,2,SPECIAL,0 2)),u(calcdef,add(switch(%q<atkmode>,MELEE,%q<bdstat4>,RANGED,%q<bdstat6>,SPECIAL,fdiv(add(%q<bdstat4>,%q<bdstat6>),2)),fdiv(u(ladd,iter(switch(%q<atkmode>,MELEE,4,RANGED,6,SPECIAL,4 6),u(calcstatmod,%#,%i0,DEFENSE,%q<def>,1))),switch(%q<atkmode>,SPECIAL,2,1))),switch(%q<atkmode>,MELEE,4,RANGED,6,SPECIAL,4 6)),if(get(%#/%q<atk>`HARDSELL),0.9,if(get(%#/%q<atk>`SELL),0.95,1)),if(get(%#/D`COMBAT`HARDSELL),1.1,if(get(%#/D`COMBAT`SELL),1.05,1))));

&INC`COMBAT`DEFEND`MAIN`CALCULATE`ACCURACYMOD [u(Cobj,age)]=th u(setq,accuracymod,mul(u(calcoff,add(switch(%q<atkmode>,MELEE,%q<bastat1>,RANGED,%q<bastat3>,SPECIAL,fdiv(add(%q<bastat1>,%q<bastat3>),2)),),switch(%q<atkmode>,MELEE,1,RANGED,3,SPECIAL,1 3)),u(calcdef,add(switch(%q<atkmode>,MELEE,%q<bdstat5>,RANGED,%q<bdstat7>,SPECIAL,fdiv(add(%q<bdstat5>,%q<bdstat7>),2)),fdiv(u(ladd,iter(switch(%q<atkmode>,MELEE,5,RANGED,7,SPECIAL,5 7),u(calcstatmod,%#,%i0,DEFENSE,%q<def>,1))),switch(%q<atkmode>,SPECIAL,2,1))),switch(%q<atkmode>,MELEE,5,RANGED,7,SPECIAL,5 7)),if(get(%#/%q<atk>`HARDSELL),0.75,if(get(%#/%q<atk>`SELL),0.85,1)),if(get(%#/D`COMBAT`HARDSELL),1.25,if(get(%#/D`COMBAT`SELL),1.15,1))));

&INC`COMBAT`DEFEND`MAIN`CALCULATE`ROLL [u(Cobj,age)]=@select/inline hasattr(%#/D`ROLLFORCE)=1,{th u(setq,roll,get(%#/D`ROLLFORCE));@attach %!/WIPE=%#,D`ROLLFORCE},0,{th u(setq,roll,die(1,100))};

&FULLDAMAGE [u(cobj,age)]=add(%q<damage>,%q<dot>)

&THRESHOLD [u(cobj,age)]=switch(1,eq(%0,1),0,cand(lt(%0,1.0),gte(%0,0.63)),1,lt(%0,0.63),2,cand(gte(%0,1.0),lte(%0,1.3666)),3,cand(gt(%0,1.3666),lte(%0,1.5388)),4,gte(%0,1.5388),5)

&INC`COMBAT`DEFEND`MAIN`CALCULATE`THRESHOLD [u(cobj,age)]=th u(setq,tmode,u(THRESHOLD,%q<accuracymod>));@attach %!/INC`COMBAT`DEFEND`MAIN`CALCULATE`THRESHOLD`%q<tmode>;

&INC`COMBAT`DEFEND`MAIN`CALCULATE`THRESHOLD`0 [u(cobj,age)]=th u(setq,hitmul,switch(%q<roll>,<=10,0.0,<=50,0.4,<=90,0.7,>=91,1.0))

&INC`COMBAT`DEFEND`MAIN`CALCULATE`THRESHOLD`1 [u(cobj,age)]=th u(setq,athresh,mul(sub(1,%q<accuracymod>),24.54));th u(setq,hitmul,if(lte(%q<roll>,round(add(10,%q<athresh>),0)),0.0,if(lte(%q<roll>,round(mul(5,add(10,%q<athresh>)),0)),0.4,if(cand(gt(%q<roll>,round(mul(5,add(10,%q<athresh>)),0)),lte(%q<roll>,round(add(90,%q<athresh>),0))),0.7,if(gt(%q<roll>,round(add(90,%q<athresh>),0)),1.0)))))

&INC`COMBAT`DEFEND`MAIN`CALCULATE`THRESHOLD`2 [u(cobj,age)]=th u(setq,athresh,mul(sub(1,%q<accuracymod>),135.65));th u(setq,hitmul,if(lte(%q<roll>,round(add(19,%q<athresh>),0)),0.0,if(cand(gt(%q<roll>,round(add(19,%q<athresh>),0)),lt(%q<roll>,95)),0.4,if(cand(lt(%q<roll>,100),gte(%q<roll>,95)),0.7,if(eq(%q<roll>,100),1.0)))))

&INC`COMBAT`DEFEND`MAIN`CALCULATE`THRESHOLD`3 [u(cobj,age)]=th u(setq,athresh,mul(sub(%q<accuracymod>,1),24.54));th u(setq,hitmul,if(lte(%q<roll>,round(sub(10,%q<athresh>),0)),0.0,if(lte(%q<roll>,round(mul(5,sub(10,%q<athresh>)),0)),0.4,if(cand(gt(%q<roll>,round(mul(5,sub(10,%q<athresh>)),0)),lte(%q<roll>,round(sub(90,%q<athresh>),0))),0.7,if(gt(%q<roll>,round(sub(90,%q<athresh>),0)),1.0)))))

&INC`COMBAT`DEFEND`MAIN`CALCULATE`THRESHOLD`4 [u(cobj,age)]=th u(setq,athresh,mul(sub(%q<accuracymod>,1.3666),180.18));th u(setq,hitmul,if(eq(%q<roll>,1),0.0,if(lte(%q<roll>,5),0.4,if(cand(gt(%q<roll>,5),lte(%q<roll>,round(sub(81,%q<athresh>),0))),0.7,if(gt(%q<roll>,sub(81,%q<athresh>)),1.0)))))

&INC`COMBAT`DEFEND`MAIN`CALCULATE`THRESHOLD`5 [u(cobj,age)]=th u(setq,hitmul,if(eq(%q<roll>,1),0.0,if(lte(%q<roll>,5),0.4,if(cand(gt(%q<roll>,5),lte(%q<roll>,50)),0.7,if(gt(%q<roll>,50),add(1.0,mul(1.076,sub(%q<accuracymod>,1.588))))))))

&INC`COMBAT`DEFEND`MAIN`CALCULATE`SCATTER [u(cobj,age)]=th u(setq,scatterblock,max(u(lmax,iter(u(ATKERATKSTAT,DAMAGE_SCATTER`BLOCK_NEGATIVE),u(STATUS`[before(%i0,$)]`DAMAGE_SCATTER`BLOCK_NEGATIVE,%#,%i0))),u(lmax,iter(u(MEDEFSTAT,DAMAGE_SCATTER`BLOCK_NEGATIVE),u(STATUS`[before(%i0,$)]`DAMAGE_SCATTER`BLOCK_NEGATIVE,%#,%i0)))));@dolist/inline posinc~POSITIVE_INCREASE posdec~POSITIVE_DECREASE neginc~NEGATIVE_INCREASE negdec~NEGATIVE_DECREASE={th u(setq,scatter[before(%i0,~)],mul(lmath(mul,iter(u(ATKERATKSTAT,DAMAGE_SCATTER`[after(%i0,~)]),u(STATUS`[before(%i0,$)]`DAMAGE_SCATTER`[after(%i1,~)],%#,%i0))),lmath(mul,iter(u(MEDEFSTAT,DAMAGE_SCATTER`[after(%i0,~)]),u(STATUS`[before(%i0,$)]`DAMAGE_SCATTER`[after(%i1,~)],%#,%i0)))))};

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE [u(cobj,age)]=th u(setr,damage,u(setr,preflux,mul(u(cust,CORE,BASEDAMAGE),%q<damagemod>,add(%q<xconorig>,u(ladd,%q<xcon>)),%q<hitmul>)));th u(setq,fudge,add(1.0,u(setr,flux,mul([if(rand(0,1),-,)]1,0.[rjust(rand(0,u(cust,CORE,FUDGESCATTER)),2,0)]))));th u(setr,startdamage,u(setr,damage,floor(mul(add(%q<damage>,%q<adamage>),%q<fudge>))));th u(setq,incdamagemul,1.0);th u(setq,damageraw,%q<damage>)

&INC`COMBAT`DEFEND`MAIN`CALCULATE`DAMAGE`MULTIPLIERS [u(cobj,age)]=

&INC`COMBAT`DEFEND`MAIN`STRIKE [u(cobj,age)]=th u(setq,boss,strmatch(get(%#/D`COMBAT`MODE),BOSS));@attach %!/INC`ANNOUNCE=[ansi(hw,%n)] Lvl %q<rlevel>%q<usex> [ansi(118,get(u(cobj,agedb)/REA`%q<def>`ACTION))] against [ansi(hw,name(%q<atker>))][if(strlen(%q<defname>),%busing %q<defname>)]! [ansi(118,if(%q<hitmul>,if(gte(%q<hitmul>,1.0),A Direct Hit![u(setq,htype,DIRECT)],if(gte(%q<hitmul>,0.7),A Solid Hit![u(setq,htype,SOLID)],A Close Call![u(setq,htype,CLOSE)])),It Missed![u(setq,htype,MISS)]))];@attach %!/INC`ANNOUNCE=[u(u(cobj,agedb)/REA`%q<def>`%q<htype>,%q<atklevel>,ansi(hw,%n),ansi(hw,name(%q<atker>)),ansi(,u(u(cobj,agedb)/ATK`[get(%#/%q<atk>`OFF)]`DESCRIPTION,%q<atklevel>)))]%B[ansi(226,%q<damage>)] [ansi(hw,damage)]![if(%q<dot>,%B[ansi(hr,%q<dot>)] more from Damage over Time!)];@attach %!/INC`DAMAGE=%#,add(%q<damagespc>,%q<dot>),Normal Combat,,1;@select/inline gte(get(%#/D`COMBAT`DAMAGE),get(%#/D`COMBAT`HEALTH))=1,{@attach %!/INC`ANNOUNCE=[ansi(hr,%n has been defeated!)]};@@ th u(setq,trgbons,iter(0 1 2 3 4 5 6 7,u(calcstatmod,%#,%i0,DEFENSE,%q<def>,1)));

&INC`COMBAT`DEFEND`MAIN`ENDTURN [u(cobj,age)]=&D`COMBAT`HISTORY`LAST_REA_CHOICE %#=%q<def>;th u(addto,%#,D`COMBAT`NUMBERS`TIMES_DEFENDED,1);@attach %!/INC`HEAT=%#,u(setr,heatchange,add(u(cust,REA,%q<def>`COST`%q<rlevel>),u(ladd,iter(u(MEDEFSTAT,STATUS`%q<defstatus>`DEFENSE`HEAT_COST),u(STATUS`[before(%i0,$)]`STATUS`%q<defstatus>`DEFENSE`HEAT_COST,%#,%i0))),u(setr,passiveheat,mul(add(get(%#/D`COMBAT`HEAT`VENT),u(ladd,iter(u(MEDEFSTAT,BONUS`HEAT_VENT),u(getstatus,%#,%i0,DEFENSE,BONUS`HEAT_VENT)))),-1)))),DEFENSE TURN,,add(5,u(ladd,iter(u(MEDEFSTAT,BONUS`HEAT_VENT`EXEMPT),u(getstatus,%#,%i0,DEFENSE,BONUS`HEAT_GAIN`EXEMPT)))),,,1;@attach %!/INC`TENSION=%#,add(mul(%q<deftencost>,-1),u(setr,passivetension,add(get(%#/D`COMBAT`TENSION`GAIN),u(ladd,iter(u(MDEFEFSTAT,DEFENSE`BONUS`TENSION_GAIN),u(getstatus,%#,%i0,DEFENSE,BONUS`TENSION_GAIN)))))),DEFENSE TURN,,,,,1;@attach %!/INC`EANNOUNCE=DEFENSE TURN,ansi(h,%n) [if(strmatch(%q<heatchange>,-*),vented,generated)] [ansi(hg,abs(%q<heatchange>))] Heat and [if(strmatch(%q<passivetension>,-*),lost,gained)] [ansi(hg,%q<passivetension>)] Tension!;th u(attrib_set,%#,D`COMBAT`HISTORY`LAST_SUFFERED_HITMUL,%q<hitmul>);th u(attrib_set,%#,D`COMBAT`HISTORY`LAST_SUFFERED_DAMAGE,%q<damage>);@select/inline t(%q<damage>)=1,{@dolist/inline get(%#/D`COMBAT`ACTIVE`STATUS`TAGS`FIFO_DAMAGE)={@attach %!/STATUS`[before(##,$)]`ON_FIFO_DAMAGE=%#,##,%q<damage>;th u(attrib_set,%#,D`COMBAT`STATUS`##`FIFO_DAMAGE,linsert(get(%#/D`COMBAT`STATUS`##`FIFO_DAMAGE),-1,%q<damage>))}};@dolist/inline u(MEDEFSTAT,DEFENSE_PRE_BONUS)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_PRE_BONUS=%#,%i0};@dolist/inline u(MEDEFSTAT,DEFENSE_END_TURN)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_END_TURN=%#,%i0};@dolist/inline u(atkeratkstat,ATTACK_ON_DEFENSE_ENDTURN)={@attach %!/STATUS`[before(%i0,$)]`ATTACK_ON_DEFENSE_ENDTURN=%#,%i0};@attach %!/INC`COMBAT`DEFEND`MAIN`ENDTURN`STATUS=%#;@dolist/inline u(MEDEFSTAT,DEFENSE_FINAL_ENDTURN)={@attach %!/STATUS`[before(%i0,$)]`DEFENSE_FINAL_ENDTURN=%#,%i0};@select/inline u(setr,ftb,cand(not(get(%#/D`COMBAT`NO_FIRST_BONUS)),eq(get(%#/D`COMBAT`NUMBERS`TIMES_DEFENDED),get(%#/D`COMBAT`OPPONENTS)),not(get(%#/D`COMBAT`NUMBERS`TIMES_ATTACKED))))=1,{@@ @attach %!/INC`HEAT=%#,mul(25,get(%#/D`COMBAT`OPPONENTS)),FIRST TURN BONUS,,mul(25,get(%#/D`COMBAT`OPPONENTS)),,1};&D`COMBAT`TENSION`USED %#=0;&D`COMBAT`SELL %#=0;&D`COMBAT`HARDSELL %#=0;@attach %!/WIPE=%#,D`COMBACK

&INC`COMBAT`DEFEND`MAIN`ENDTURN`STATUS [u(cobj,age)]=@dolist/inline/nobreak u(setr,sall,get(%0/D`COMBAT`ACTIVE`STATUS`DEFENSE))={th u(addto,%0,D`COMBAT`STATUS`%i0`INCREMENT,1);@select/inline u(setr,srem,get(%0/D`COMBAT`STATUS`%i0`DEFENSE_TURNS))=X,{},>0,{th u(attrib_set,%0,D`COMBAT`STATUS`%i0`DEFENSE_TURNS,sub(%q<srem>,1));@stop get(%0/D`COMBAT`STATUS`%i0`DEFENSE_TURNS);th u(attrib_set,%0,D`COMBAT`ACTIVE`STATUS`DEFENSE,setdiff(get(%0/D`COMBAT`ACTIVE`STATUS`DEFENSE),%i0));@stop cor(strmatch(get(%0/D`COMBAT`STATUS`%i0`ATTACK_TURNS),X),gt(u(lmax,iter(ATTACK DEFENSE,get(%0/D`COMBAT`STATUS`%i1`%i0_TURNS))),0));@attach %!/KILLSTATUS=%0,%i0}};

&INC`COMBAT`DEFEND`MAIN`DEBUG [u(cobj,age)]=th u(setq,testers,u(filter,TESTER,lplayers(%l)));@pemit/list %q<testers>=u(setr,deboutput,center(Debug: [ansi(hw,%n)] defending against [ansi(hw,name(%q<atker>))],78,ansi(hm,=))%R[align(39 1. 36,Stats: Str Skl Fir Aim Res Agi Arm Mob%RAtker: [iter(0 1 2 3 4 5 6 7,ljust(get(%#/%q<atk>`STATS`%i0`GRADE),3))]%RBonus: [iter(0 1 2 3 4 5 6 7,ljust(sub(r(bastat%i0),r(astat%i0)),3))]%RDfder: [iter(0 1 2 3 4 5 6 7,ljust(get(%#/D`COMBAT`STATS`%i0`GRADE),3))]%RBonus: [iter(0 1 2 3 4 5 6 7,ljust(sub(r(bdstat%i0),r(dstat%i0)),3))]%RCritAtk: %q<critatkdeb> +%q<critatkpower> | CritDef: %q<critdefdeb> +%q<critdefpower>,|%R,AccMod: %q<accuracymod> | DmgMod: %q<damagemod>%RBtrack: %q<tmode> | Hitmul: %q<hitmul>%RStatDam: [round(%q<preflux>,2)] | Flux: %q<flux>%RXCON: %q<xconorig> + \([iter(%q<xcon>,%i0,%b,%b+%b)]\)%RRawDmg: %q<damageraw> | HetDmg: %q<damageheat>%RNetDmg: %q<damagenet> | NrmDmg: %q<damagenorm>%RPreDmg: %q<damagepre> | CrtDmg: %q<damagecritatk>/%q<damagecritdef>%RFinDmg: %q<damagefin> | SpcDmg: %q<damagespc>[if(gt(%q<atkopp>,1),%RAttacker [ansi(hr,Boss)] [ansi(hy,%q<atkopp>)]: %q<atkbosspredam> * (%q<atkbossdmgmul> * %q<atkbosssqrt>) = %q<atkbosspostdam>)][if(gt(%q<defopp>,1),%RDefender [ansi(hr,Boss)] [ansi(hy,%q<defopp>)]: %q<defbosspredam> * (%q<defbossdefmul> / %q<defbosssqrt>) = %q<defbosspostdam>)])]%R[center(Lvl %q<atklevel> [u(u(cobj,agedb)/ATK`[get(%#/%q<atk>`OFF)],%q<atklevel>)] Atk VS Lvl %q<rlevel>%q<usex> [u(u(cobj,agedb)/REA`%q<def>,%q<atklevel>)] Def,78,ansi(hm,=))]);@nscemit/noisy ***Combat System***=[ansi(hw,%n)] defending against [ansi(hw,name(%q<atker>))]%R%q<deboutput>;@attach %!/WIPE=%#,%q<atk>;@select/inline nattr(%#/D`COMBAT`Q`*)=0,{@attach %!/INC`CPTREE=%#,D`COMBAT,%#,D`COMBACK}

&COLORSTAT [u(cobj,age)]=ansi(switch(%0,0,hr,1,hg,2,hy,3,hc,h),%1)

th u(setq,colorstats,ansi(hr,0) [ansi(hg,1)] [ansi(hy,2)] [ansi(hc,3)]);

&FIL`TESTER [u(cobj,age)]=cand(u(tester,%0),get(%0/D`MATRIX),hasflag(%0,CONNECTED))

&OVEREXERT [u(cobj,age)]=localize(u(setq,origdamage,mul(get(%0/D`COMBAT`HEAT`EXHAUSTION_MULTIPLIER),u(cust,HEATS,[get(%0/D`COMBAT`HEAT`STATUS)]`DAMAGE)))[if(u(setr,maxcap,lmath(min,filterbool(#lambda/gt(\%0,0),iter(get(%0/D`COMBAT`ACTIVE`STATUS`ATTACK),u(getstatus,%0,%i0,ATTACK,OVEREXERT_MAX_PERCENTAGE))))),min(u(hitpercent,%0,%q<maxcap>,1),%q<origdamage>),%q<origdamage>)])

@@ BOOST CODE
&INC`COMBAT`BOOST`MAIN [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not combat ready.;@stop gte(get(%#/D`COMBAT`DAMAGE),get(%#/D`COMBAT`HEALTH))=@attach %!/INC`MSG=ERROR: The defeated can do no such thing!;@check strlen(%0)=@attach %!/INC`MSG=ERROR: No Boost entered to activate.;@check strlen(u(setr,boost,u(FIND_MULTI,BOOST,%0)))=@attach %!/INC`MSG=ERROR: Boost not found!;@stop gt(words(%q<boost>),1)=@attach %!/INC`MSG=ERROR: That matches Boosts: [iter(%q<boost>,get(u(cobj,agedb)/BOOST`%i0),%b,\,%b)]. Please be more specific.;@select/inline words(u(setr,tensioncost,get(u(cobj,agedb)/BOOST`%q<boost>`CHOICES)),|)=>1,{@check strlen(%1)=@attach %!/INC`MSG=ERROR: No cost chosen!;@attach %!/INC`PARTIAL=%1,%q<tensioncost>,|,tensioncost};@check gte(u(setr,starttension,get(%#/D`COMBAT`TENSION)),%q<tensioncost>)=@attach %!/INC`MSG=ERROR: Not enough Tension!;@attach [u(cobj,agedb)]/BOOST`%q<boost>`ACTIVATE=%#,%2,%q<tensioncost>;th u(addto,%#,D`COMBAT`TENSION,mul(-1,%q<tensioncost>));th u(setq,aftertension,get(%#/D`COMBAT`TENSION));@attach %!/INC`ANNOUNCE=[if(gt(%q<boss>,1),ansi(hr,<BOSS-%q<boss>>%B))][ansi(hw,%n)] uses a [ansi(118,Boost)]!;@attach %!/INC`EPRIVATE=BOOST,You used [ansi(118,Boost)]: [get(u(cobj,agedb)/BOOST`%q<boost>)];th u(setq,testers,u(filter,TESTER,lplayers(%l)));@attach %!/INC`DEBUG=BOOST,%n used: [get(u(cobj,agedb)/BOOST`%q<boost>)][if(%q<boostchoice>,%B\(%q<boostchoice>\))];@dolist/inline edit(lattr(%#/D`COMBAT`STATUS`*),D`COMBAT`STATUS`,)={@attach %!/STATUS`[before(%i0,$)]`BOOST_ON_ACTIVATE=%#,%i0,%q<push>,%q<statid>};th u(addto,%#,D`COMBAT`TENSION`USED,%q<tensioncost>)

&INC`COMBAT`BOOST`LIST [u(cobj,age)]=@pemit %#=u(header,Available Boosts);@dolist/inline u(sortattr,u(lattr,u(cobj,agedb)/BOOST`*))={@pemit %#=u(separator,get(u(cobj,agedb)/%i0));@dolist/inline/delimit | [get(u(Cobj,agedb)/%i0`CHOICES)]={@pemit %#=[ansi(h,%i0 Tension:)]%B[get(u(cobj,agedb)/%i1`%i0)]}};@pemit %#=u(footer)

&INC`HEAL [u(cobj,age)]=&D`COMBAT`DAMAGE %0=bound(sub(get(%0/D`COMBAT`DAMAGE),u(setr,regain,%1)),0,get(%0/D`COMBAT`HEALTH));@select/inline not(%3)=1,{@attach %!/INC`ANNOUNCE=[name(%0)] gained %1 Health from: %2},0,{@attach %!/INC`EANNOUNCE=%3,%4}

@@ QUEUE CODE
&INC`COMBAT`QUEUE`MAIN [u(cobj,age)]=@check nattr(%#/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: You are not combat ready. Make sure your Pilot/Mecha are set and use +reset.;@check nattr(%#/D`COMBAT`Q`**)=@attach %!/INC`MSG=ERROR: You have no incoming attacks to deal with!;@pemit %#=u(header,Combat Queue);@pemit %#=ansi(u(color,%#,COLOR,COLUMN_NAMES),align(17 18 1 10 15 12,Source,Name,L,Type,Mechanism,Effect));@pemit %#=u(separator);@dolist/inline sortkey(#lambda/get(%#/\%0`TIMESTAMP),lattr(%#/D`COMBAT`Q`*))={@pemit %#=align(17 18 1 10 15 12,u(getmoniker,last(%i0,`)),get(%#/%i0),switch(get(%#/%i0`LEVEL),>9,S,get(%#/%i0`LEVEL)),default(%!/TYPE`[get(%#/%i0`TYPE)],<unknown>),default(%!/MECHANISM`[get(%#/%i0`MECHANISM)],<unknown>)%b\([if(match(1 2 6,get(%#/%i0`MECHANISM)),Mel,Rng)]\),iter(get(%#/%i0`EFFECTS),default(%!/EFFECT`%i0,<unknown>)))};@pemit %#=u(footer)

@@ HEALTH CODE
&INC`COMBAT`HEALTh`MAIN [u(cobj,age)]=@attach %!/INC`CHECKPC=u(strfirstof,%0,%#),1;@check nattr(%q<t1>/D`COMBAT`**)=@attach %!/INC`MSG=ERROR: %q<t1name> is not readied for battle.;@pemit %#=u(header,%q<t1name> - Health);@select/inline strmatch(%q<t1>,%#)=1,{@attach %!/INC`COMBAT`STATS`DISPLAY};@pemit %#=u(subheader,Effects);@pemit %#=align(1. 36 1. 37 1.,ansi(u(color,%#,BORDER),|),center(ansi(g,Attack Effects),36)[u(trimlines,%R[u(FUN`LIST_STATUS,%q<t1>,ATTACK)])],ansi(u(color,%#,BORDER),|),center(ansi(g,Defense Effects),37)[u(trimlines,%R[u(FUN`LIST_STATUS,%q<t1>,DEFENSE)])],ansi(u(color,%#,BORDER),|));@pemit %#=u(footer)

&FUN`LIST_STATUS [u(Cobj,age)]=iter(sortkey(#lambda/get(%!/STATUS`\[before(\%0,$)\]),u(filter,DISPLAY,get(%0/D`COMBAT`ACTIVE`STATUS`%1),%b,%b,%0,%1),i),\([get(%0/D`COMBAT`STATUS`%i0`%1_TURNS)]\)%B[ansi(hw,\[[ucstr(get(%0/D`COMBAT`STATUS`%i0))]\])] - [u(STATUS`[before(%i0,$)]`DESCRIPTION,%0,%i0)][if(strlen(u(setr,intensity,u(STATUS`[before(%i0,$)]`CURE`INTENSITY,%0,%i0))),%b\(%q<intensity>\))],%b,%r)

&FIL`DISPLAY [u(cobj,age)]=t(match(get(%!/STATUS`[before(%0,$)]`TAGS),DISPLAY))

@@ @pemit %#=ACTIVE BOOSTS: [itemize(iter(get(%#/D`COMBAT`ACTIVE_BOOSTS),default(%!/BOOST`[u(setr,id,before(%i0,~))],<unset>)%b\([add(u(getstat,%#,D`COMBAT`ACTIVE_BOOSTS`ATTACK,%q<id>),0)]/[add(u(getstat,%#,D`COMBAT`ACTIVE_BOOSTS`DEFENSE,%q<id>),0)]\),%b,|),|,and,\,)];@pemit %#=ACTIVE EFFECTS: [itemize(iter(get(%#/D`COMBAT`ACTIVE_EFFECTS),default(%!/EFFECT`[u(setr,id,before(%i0,~))],<unset>)%b\([add(u(getstat,%#,D`COMBAT`ACTIVE_EFFECTS`ATTACK,%q<id>),0)]/[add(u(getstat,%#,D`COMBAT`ACTIVE_EFFECTS`DEFENSE,%q<id>),0)]\),%b,|),|,and,\,)];@pemit %#=u(footer)

@@ +bbpost 6/CSYS: Character Editor=The commands [ansi(h,+select\, +view\, +create\, +delete\, +add\, +remove\, +set\, +mode)] are the core of the Combat System editor. It works on the following principle:%R%RWhen you [ansi(h,+select)] something, this becomes your focus point, or +mode. Selecting a PLAYER with [ansi(h,+select player=<playername>)] will initialize them for the combat system, create a DEFAULT PILOT if they don't have one already, and put you in Player/Pilot Mode. (If they already HAVE a pilot, you will then need to [ansi(h,+select pilot=<pilot name or id>)] to target that.)%R%RWhile in Player/Pilot mode, the [ansi(h,+create)] command can be used to [ansi(h,+create pilot=<new pilot name>)] or [ansi(h,+create mecha=<new mecha name>)], which will shift your focus.%R%RShifting to MECHA MODE allows for [ansi(h,+create attack=<attack name>)].%R%RSimilarly, in each mode the functions of the +add, +remove, and +set commands change. For PILOT and MECHA mode, +set will let you target things like name, agi, mel, and similar properties. For example, [ansi(h,+set agi=60)]. Changes are saved immediately, but will only be reflected on players using it when they +reset.%R%RIn PLAYER or MECHA mode, the +add and +remove commands can be used to add/remove ABILITIES or BOOSTS. In ATTACK mode, it can only be used for Effects. The full list of available traits is on the csys design document, I'm not gonna list it here. Example: [ansi(h,+add abil=Attacker)]%R%RA more comprehensive guide will be written in the future, but I expect this to be intuitive enough for you guys to experiment.%R%R[ansi(hr,FOR NOW)] I have created a character called [ansi(h,MP-Holder)]. While I haven't quite worked out all the commands for handling MP Mecha and Generic Pilots, please feel free to create various pilot and mech builds on this guy. When we're ready I can mass-assign whatever's on him as generic/mp stuff for everyone to test.

@@ +bbpost 6/CSYS: Combat Commands=[ansi(h,+reset)] to get ready for combat! This will clear EVERYTHING right now. Sorry, switching pilots and mechas mid-flight isn't currently supported, although it won't be hard to add that in either. I mean you can, but you're starting the fight fresh. Not fair.%R%R[ansi(h,+boost <name>)] to activate a boost. They're listed in +stats.%R%R[ansi(h,+free <name>=<level> <type> <mechanism>)] to set a Free attack. /rem and /clear haven't been implemented yet, but entering the same name will overwrite the old entry. Free attacks are bound to your mecha and switch accordingly.%R%R[ansi(h,+attack <player>=<attack name>)] - Attack someone. You can (untested) use [ansi(h,+attack <player1>\,<player2>,\,<player3>\,...=<attack name>)] for multi-targeting. In theory.%R%R[ansi(h,+defend <attacker>=<response>)]. Where response is AVOID, BLOCK, STEADY, VENT, ALLOW, or SURRENDER.%R%RKNOWN ISSUES:%RA: There's currently no health display anywhere. Or active buffs/debuffs.%RB: Or an incoming attack display.%RC: Boss modes haven't been implemented yet.
@@ +bbpost 6/CSYS: Approval Commands=[ansi(hc,Player Commands)]%R[ansi(h,+submit <thing>)] to submit a designed Mecha or Pilot for approval. Once submitted they cannot be modified except by admin.%R%R[ansi(hc,Admin Commands)]%R[ansi(h,+set approved=<0 or 1>)] - This is to be used when you've used the character editor and selected the relevant mecha/pilot. Setting it to 0 clears the pending review and returns it to unapproved. Setting to 1 marks it approved so players can use it.%R[ansi(h,+key/add Csys=<player>)] - adds a player to the Csys Tester list. (see below.) Use +key/rem csys=<name> to revoke tester abilities.%R%RTesters can use unapproved mechs/pilots and can toggle on/off debug displays.%R%R[ansi(hc,Tester Commands)]%R[ansi(h,+matrix)] - This command toggles on/off the debug display. Only usable by admin and Csys Testers.
